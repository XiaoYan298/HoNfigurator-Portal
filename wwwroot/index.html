<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HoNfigurator Management Portal</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        /* Clean Minimal Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        /* Tab Category Dropdown */
        .tab-category {
            position: relative;
        }
        .tab-category-dropdown {
            position: fixed;
            min-width: 200px;
            background: #18181b;
            border: 1px solid #3f3f46;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            padding: 6px;
            z-index: 9999;
        }
        .tab-category-dropdown button {
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
        }
        .tab-category-dropdown button:hover {
            background: #27272a;
        }
        .tab-category-dropdown button.active {
            background: #f97316;
            color: white;
        }
        .category-divider {
            height: 1px;
            background: #27272a;
            margin: 6px 0;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 50: '#18181b', 100: '#1f1f23', 200: '#27272a', 300: '#3f3f46' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-zinc-950 text-gray-100 min-h-screen" x-data="portalApp()" x-init="init()">
    
    <!-- Toast Notifications -->
    <div class="fixed top-4 right-4 z-[9999] space-y-2">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="true"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-x-8"
                 x-transition:enter-end="opacity-100 translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-x-0"
                 x-transition:leave-end="opacity-0 translate-x-8"
                 class="flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg border max-w-sm"
                 :class="{
                     'bg-green-900/90 border-green-700 text-green-100': toast.type === 'success',
                     'bg-red-900/90 border-red-700 text-red-100': toast.type === 'error',
                     'bg-yellow-900/90 border-yellow-700 text-yellow-100': toast.type === 'warning',
                     'bg-blue-900/90 border-blue-700 text-blue-100': toast.type === 'info'
                 }">
                <i class="fas"
                   :class="{
                       'fa-check-circle': toast.type === 'success',
                       'fa-exclamation-circle': toast.type === 'error',
                       'fa-exclamation-triangle': toast.type === 'warning',
                       'fa-info-circle': toast.type === 'info'
                   }"></i>
                <span class="text-sm flex-1" x-text="toast.message"></span>
                <button @click="removeToast(toast.id)" class="opacity-70 hover:opacity-100">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>
        </template>
    </div>
    
    <!-- Login Screen -->
    <div x-show="!user" x-cloak class="min-h-screen flex items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <!-- Logo -->
            <div class="text-center mb-10">
                <img src="/favicon.png" alt="HoNfigurator" class="w-80 h-59 mx-auto mb-4">
                <h1 class="text-2xl font-semibold text-white">HoNfigurator</h1>
                <p class="text-zinc-500 text-sm mt-1">Management Portal</p>
            </div>
            
            <!-- Login Card -->
            <div class="bg-zinc-900 rounded-lg p-6 border border-zinc-800">
                <p class="text-zinc-400 text-sm text-center mb-6">
                    Sign in to manage your game servers
                </p>
                
                <a href="/auth/discord" 
                   class="flex items-center justify-center gap-2 w-full bg-[#5865F2] hover:bg-[#4752C4] text-white py-3 px-4 rounded-lg font-medium transition-colors">
                    <i class="fab fa-discord text-lg"></i>
                    Continue with Discord
                </a>
            </div>
            
            <p class="text-xs text-zinc-600 text-center mt-6">
                By continuing, you agree to our terms of service.
            </p>
        </div>
    </div>

    <!-- Main App (after login) -->
    <div x-show="user" x-cloak>
        <!-- Header -->
        <header class="bg-zinc-900 border-b border-zinc-800 sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center gap-2">
                    <img src="/favicon.png" alt="" class="w-30 h-14">
                    <span class="font-semibold text-white">HoNfigurator</span>
                    <span class="text-[10px] px-1.5 py-0.5 bg-orange-500/10 text-orange-400 rounded font-medium">BETA</span>
                </div>
                
                <!-- Right -->
                <div class="flex items-center gap-4">
                    <!-- Status -->
                    <div class="flex items-center gap-1.5 text-xs">
                        <span class="w-1.5 h-1.5 rounded-full" :class="hubConnected ? 'bg-green-500' : 'bg-red-500'"></span>
                        <span :class="hubConnected ? 'text-green-500' : 'text-red-500'" x-text="hubConnected ? 'Live' : 'Offline'"></span>
                    </div>
                    
                    <!-- Admin -->
                    <button x-show="user?.isSuperAdmin" 
                            @click="showAdminPanel = true; loadAdminUsers()"
                            class="text-xs text-zinc-400 hover:text-white transition">
                        <i class="fas fa-shield-alt"></i>
                    </button>
                    
                    <!-- User -->
                    <div class="flex items-center gap-2">
                        <img :src="user?.avatar" class="w-7 h-7 rounded-full">
                        <span class="text-sm text-zinc-300 hidden sm:block" x-text="user?.username"></span>
                        <button @click="logout()" class="text-zinc-500 hover:text-white transition p-1" title="Logout">
                            <i class="fas fa-sign-out-alt text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-6xl mx-auto px-4 py-6">
            <!-- No Servers - Empty State -->
            <div x-show="servers.length === 0 && !loading" class="text-center py-20">
                <div class="w-16 h-16 mx-auto mb-6 rounded-full bg-zinc-800 flex items-center justify-center">
                    <i class="fas fa-server text-2xl text-zinc-500"></i>
                </div>
                <h2 class="text-lg font-medium text-white mb-2">No servers yet</h2>
                <p class="text-zinc-500 text-sm mb-6 max-w-sm mx-auto">
                    Add your HoNfigurator server to start monitoring.
                </p>
                <button @click="showAddModal = true" 
                        class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Server
                </button>
            </div>

            <!-- Has Servers - Dashboard -->
            <div x-show="servers.length > 0">
                <!-- Stats Row -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-zinc-900 rounded-lg p-4 border border-zinc-800">
                        <div class="text-zinc-500 text-xs uppercase tracking-wide mb-1">Hosts</div>
                        <div class="text-2xl font-semibold text-white" x-text="dashboard.totalServers"></div>
                        <div class="text-xs text-green-500 mt-1"><span x-text="dashboard.onlineServers"></span> online</div>
                    </div>
                    <div class="bg-zinc-900 rounded-lg p-4 border border-zinc-800">
                        <div class="text-zinc-500 text-xs uppercase tracking-wide mb-1">Servers</div>
                        <div class="text-2xl font-semibold text-white" x-text="dashboard.totalGameServers"></div>
                        <div class="text-xs text-green-500 mt-1"><span x-text="dashboard.activeGameServers"></span> active</div>
                    </div>
                    <div class="bg-zinc-900 rounded-lg p-4 border border-zinc-800">
                        <div class="text-zinc-500 text-xs uppercase tracking-wide mb-1">Matches</div>
                        <div class="text-2xl font-semibold text-white" x-text="dashboard.activeMatches"></div>
                    </div>
                    <div class="bg-zinc-900 rounded-lg p-4 border border-zinc-800">
                        <div class="text-zinc-500 text-xs uppercase tracking-wide mb-1">Players</div>
                        <div class="text-2xl font-semibold text-white" x-text="dashboard.totalPlayers"></div>
                    </div>
                </div>

                <!-- Server List -->
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-medium text-zinc-400">Your Servers</h2>
                    <button @click="showAddModal = true" 
                            class="bg-zinc-800 hover:bg-zinc-700 text-white px-3 py-1.5 rounded text-xs font-medium transition-colors">
                        <i class="fas fa-plus mr-1"></i>Add
                    </button>
                </div>

                <div class="bg-zinc-900 rounded-lg border border-zinc-800 divide-y divide-zinc-800">
                    <template x-for="server in servers" :key="server.serverId">
                        <div class="p-4 hover:bg-zinc-800/50 transition-colors">
                            <div class="flex items-center justify-between">
                                <!-- Left: Status + Info -->
                                <div class="flex items-center gap-3">
                                    <span class="w-2 h-2 rounded-full flex-shrink-0" 
                                          :class="server.isOnline ? 'bg-green-500' : 'bg-zinc-600'"></span>
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-medium text-white" x-text="server.serverName"></span>
                                            <span x-show="server.isOwner === false" 
                                                  class="text-[10px] px-1.5 py-0.5 rounded bg-zinc-800 text-zinc-400"
                                                  x-text="server.role"></span>
                                        </div>
                                        <div class="text-xs text-zinc-500 mt-0.5">
                                            <span x-text="server.ipAddress + ':' + server.apiPort"></span>
                                            <span class="mx-1">Â·</span>
                                            <span x-text="server.region"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right: Stats + Actions -->
                                <div class="flex items-center gap-6">
                                    <div x-show="server.isOnline" class="flex items-center gap-4 text-xs">
                                        <div class="text-center">
                                            <span class="text-zinc-500">Servers</span>
                                            <div class="text-white font-medium">
                                                <span x-text="getServerStatus(server.serverId)?.onlineServers || 0" class="text-green-500"></span>/<span x-text="getServerStatus(server.serverId)?.totalServers || 0"></span>
                                            </div>
                                        </div>
                                        <div class="text-center">
                                            <span class="text-zinc-500">Players</span>
                                            <div class="text-white font-medium" x-text="getServerStatus(server.serverId)?.totalPlayers || 0"></div>
                                        </div>
                                        <div class="text-center">
                                            <span class="text-zinc-500">CPU</span>
                                            <div class="font-medium" :class="(getServerStatus(server.serverId)?.systemStats?.cpuPercent || 0) > 80 ? 'text-red-400' : 'text-white'"
                                                 x-text="(getServerStatus(server.serverId)?.systemStats?.cpuPercent || 0).toFixed(0) + '%'"></div>
                                        </div>
                                    </div>
                                    <div x-show="!server.isOnline" class="text-xs text-zinc-500">Offline</div>
                                    
                                    <!-- Actions -->
                                    <div class="flex items-center gap-1">
                                        <button @click="openServerDetails(server)" 
                                                class="p-2 text-zinc-500 hover:text-white transition" title="Details">
                                            <i class="fas fa-chevron-right text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Server Modal -->
    <div x-show="showAddModal || showEditModal" x-cloak
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4"
         @click.self="closeModals()">
        <div class="bg-zinc-900 rounded-lg w-full max-w-md border border-zinc-800">
            <div class="p-4 border-b border-zinc-800 flex items-center justify-between">
                <h3 class="font-medium text-white" x-text="showEditModal ? 'Edit Server' : 'Add Server'"></h3>
                <button @click="closeModals()" class="text-zinc-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form @submit.prevent="showEditModal ? updateServer() : addServer()" class="p-4 space-y-4">
                <div>
                    <label class="block text-xs text-zinc-500 mb-1.5">Server Name</label>
                    <input type="text" x-model="serverForm.serverName" required
                           class="w-full bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-zinc-600"
                           placeholder="My HoN Server">
                </div>
                <div>
                    <label class="block text-xs text-zinc-500 mb-1.5">IP Address</label>
                    <input type="text" x-model="serverForm.ipAddress" required
                           class="w-full bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-zinc-600"
                           placeholder="123.45.67.89">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-zinc-500 mb-1.5">API Port</label>
                        <input type="number" x-model="serverForm.apiPort"
                               class="w-full bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-zinc-600"
                               placeholder="5050">
                    </div>
                    <div>
                        <label class="block text-xs text-zinc-500 mb-1.5">Region</label>
                        <select x-model="serverForm.region"
                                class="w-full bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-zinc-600">
                            <option value="Unknown">Select</option>
                            <option value="Asia">Asia</option>
                            <option value="Europe">Europe</option>
                            <option value="North America">North America</option>
                            <option value="South America">South America</option>
                            <option value="Oceania">Oceania</option>
                            <option value="Africa">Africa</option>
                        </select>
                    </div>
                </div>
                <div x-show="formError" class="text-red-400 text-xs bg-red-500/10 rounded p-3">
                    <span x-text="formError"></span>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="button" @click="closeModals()" 
                            class="flex-1 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition-colors">Cancel</button>
                    <button type="submit" :disabled="formLoading"
                            class="flex-1 px-3 py-2 bg-orange-500 hover:bg-orange-600 rounded text-sm font-medium transition-colors disabled:opacity-50">
                        <span x-show="!formLoading" x-text="showEditModal ? 'Update' : 'Add'"></span>
                        <span x-show="formLoading"><i class="fas fa-spinner fa-spin"></i></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- API Key Modal -->
    <div x-show="showKeyModal" x-cloak
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4"
         @click.self="showKeyModal = false">
        <div class="bg-zinc-900 rounded-lg w-full max-w-lg border border-zinc-800">
            <div class="p-4 border-b border-zinc-800 flex items-center justify-between">
                <h3 class="font-medium text-white">API Key</h3>
                <button @click="showKeyModal = false" class="text-zinc-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4">
                <p class="text-xs text-zinc-500 mb-3">Add this key to your config.json:</p>
                <div class="bg-zinc-950 rounded p-3 font-mono text-xs break-all text-zinc-300 border border-zinc-800">
                    <span x-text="selectedServer?.apiKey"></span>
                </div>
                <button @click="copyApiKey()" class="mt-3 text-xs text-blue-400 hover:text-blue-300">
                    <i class="fas fa-copy mr-1"></i>Copy
                </button>
                <div class="mt-4 bg-zinc-950 rounded p-3 border border-zinc-800">
                    <pre class="text-xs text-zinc-400 overflow-x-auto">"management_portal": {
  "enabled": true,
  "portal_url": "<span x-text="window.location.origin"></span>",
  "api_key": "<span x-text="selectedServer?.apiKey"></span>"
}</pre>
                </div>
            </div>
            <div class="p-4 border-t border-zinc-800">
                <button @click="showKeyModal = false" class="w-full px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" x-cloak
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4"
         @click.self="showDeleteModal = false">
        <div class="bg-zinc-900 rounded-lg w-full max-w-sm border border-zinc-800">
            <div class="p-4 border-b border-zinc-800">
                <h3 class="font-medium text-white">Delete Server</h3>
            </div>
            <div class="p-4">
                <p class="text-sm text-zinc-300">
                    Delete <span class="text-white font-medium" x-text="selectedServer?.serverName"></span>?
                </p>
                <p class="text-xs text-zinc-500 mt-2">This cannot be undone.</p>
            </div>
            <div class="p-4 border-t border-zinc-800 flex gap-2">
                <button @click="showDeleteModal = false" 
                        class="flex-1 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition-colors">Cancel</button>
                <button @click="deleteServer()" :disabled="formLoading"
                        class="flex-1 px-3 py-2 bg-red-600 hover:bg-red-700 rounded text-sm font-medium transition-colors disabled:opacity-50">
                    <span x-show="!formLoading">Delete</span>
                    <span x-show="formLoading"><i class="fas fa-spinner fa-spin"></i></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Server Details & Control Modal -->
    <div x-show="showDetailsModal" x-cloak
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4"
         @click.self="showDetailsModal = false; openDropdown = null; stopAutoRefresh()">
        <div class="bg-zinc-900 rounded-lg w-full max-w-6xl max-h-[95vh] flex flex-col border border-zinc-800" @click="openDropdown = null">
            <div class="p-4 border-b border-zinc-800 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="w-2.5 h-2.5 rounded-full" :class="selectedServer?.isOnline ? 'bg-green-400' : 'bg-zinc-600'"></span>
                    <div>
                        <h3 class="font-medium text-white" x-text="selectedServer?.serverName"></h3>
                        <span class="text-xs text-zinc-500" x-text="selectedServer?.ipAddress + ':' + selectedServer?.apiPort"></span>
                    </div>
                </div>
                <button @click="showDetailsModal = false; stopAutoRefresh()" class="text-zinc-500 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Tab Navigation - Categorized -->
            <div class="border-b border-zinc-800 px-4 flex gap-1 items-center flex-wrap" @click.stop>
                
                <!-- ðŸ“Š Overview (Direct) -->
                <button @click="activeTab = 'overview'; openDropdown = null" 
                        :class="activeTab === 'overview' ? 'border-orange-500 text-white bg-zinc-800/50' : 'border-transparent text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800/30'"
                        class="px-4 py-3 border-b-2 text-sm transition-colors whitespace-nowrap rounded-t-lg flex items-center gap-2">
                    <i class="fas fa-home"></i> Overview
                </button>
                
                <!-- ðŸ“ˆ Monitoring Category -->
                <div class="relative">
                    <button @click.stop="openDropdown = openDropdown === 'monitoring' ? null : 'monitoring'"
                            :class="['instances', 'stats', 'charts', 'health', 'alerts'].includes(activeTab) ? 'border-orange-500 text-white bg-zinc-800/50' : 'border-transparent text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800/30'"
                            class="px-4 py-3 border-b-2 text-sm transition-colors whitespace-nowrap rounded-t-lg flex items-center gap-2">
                        <i class="fas fa-chart-line"></i> Monitoring
                        <i class="fas fa-chevron-down text-[10px] transition-transform" :class="openDropdown === 'monitoring' ? 'rotate-180' : ''"></i>
                        <span x-show="unacknowledgedCount > 0" class="w-2 h-2 rounded-full bg-red-500"></span>
                    </button>
                    <div x-show="openDropdown === 'monitoring'" x-cloak
                         class="absolute top-full left-0 mt-1 min-w-[200px] bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl p-1.5 z-[9999]">
                        <button @click="activeTab = 'instances'; openDropdown = null" :class="activeTab === 'instances' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-server w-4 mr-2 text-blue-400"></i> Instances
                            <span class="ml-auto text-xs opacity-60" x-text="'(' + (statusData?.instances?.length || 0) + ')'"></span>
                        </button>
                        <button @click="activeTab = 'stats'; loadStatistics(); openDropdown = null" :class="activeTab === 'stats' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-chart-bar w-4 mr-2 text-purple-400"></i> Statistics
                        </button>
                        <button @click="activeTab = 'charts'; loadCharts(); openDropdown = null" :class="activeTab === 'charts' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-chart-area w-4 mr-2 text-green-400"></i> Charts
                        </button>
                        <button @click="activeTab = 'health'; loadHealth(); openDropdown = null" :class="activeTab === 'health' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-heartbeat w-4 mr-2 text-red-400"></i> Health
                        </button>
                        <div class="h-px bg-zinc-700 my-1"></div>
                        <button @click="activeTab = 'alerts'; loadNotifications(); openDropdown = null" :class="activeTab === 'alerts' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-bell w-4 mr-2 text-yellow-400"></i> Alerts
                            <span x-show="unacknowledgedCount > 0" class="ml-auto px-1.5 py-0.5 text-xs bg-red-500 text-white rounded-full" x-text="unacknowledgedCount"></span>
                        </button>
                    </div>
                </div>
                
                <!-- ðŸ“ Logs Category -->
                <div class="relative">
                    <button @click.stop="openDropdown = openDropdown === 'logs' ? null : 'logs'"
                            :class="['logs', 'console'].includes(activeTab) ? 'border-orange-500 text-white bg-zinc-800/50' : 'border-transparent text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800/30'"
                            class="px-4 py-3 border-b-2 text-sm transition-colors whitespace-nowrap rounded-t-lg flex items-center gap-2">
                        <i class="fas fa-scroll"></i> Logs
                        <i class="fas fa-chevron-down text-[10px] transition-transform" :class="openDropdown === 'logs' ? 'rotate-180' : ''"></i>
                    </button>
                    <div x-show="openDropdown === 'logs'" x-cloak
                         class="absolute top-full left-0 mt-1 min-w-[200px] bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl p-1.5 z-[9999]">
                        <button @click="activeTab = 'logs'; loadLogs(); openDropdown = null" :class="activeTab === 'logs' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-list-alt w-4 mr-2 text-cyan-400"></i> Game Logs
                        </button>
                        <button @click="activeTab = 'console'; loadConsoleLogs(); openDropdown = null" :class="activeTab === 'console' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-terminal w-4 mr-2 text-emerald-400"></i> Console
                        </button>
                    </div>
                </div>
                
                <!-- âš™ï¸ Management Category -->
                <div class="relative">
                    <button @click.stop="openDropdown = openDropdown === 'management' ? null : 'management'"
                            :class="['actions', 'scaling', 'config'].includes(activeTab) ? 'border-orange-500 text-white bg-zinc-800/50' : 'border-transparent text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800/30'"
                            class="px-4 py-3 border-b-2 text-sm transition-colors whitespace-nowrap rounded-t-lg flex items-center gap-2">
                        <i class="fas fa-sliders-h"></i> Management
                        <i class="fas fa-chevron-down text-[10px] transition-transform" :class="openDropdown === 'management' ? 'rotate-180' : ''"></i>
                    </button>
                    <div x-show="openDropdown === 'management'" x-cloak
                         class="absolute top-full left-0 mt-1 min-w-[200px] bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl p-1.5 z-[9999]">
                        <button @click="activeTab = 'actions'; openDropdown = null" :class="activeTab === 'actions' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-play-circle w-4 mr-2 text-green-400"></i> Actions
                        </button>
                        <button @click="activeTab = 'scaling'; loadScalingStatus(); openDropdown = null" :class="activeTab === 'scaling' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-expand-arrows-alt w-4 mr-2 text-blue-400"></i> Scaling
                        </button>
                        <div class="h-px bg-zinc-700 my-1"></div>
                        <button @click="activeTab = 'config'; openDropdown = null" :class="activeTab === 'config' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-cog w-4 mr-2 text-zinc-400"></i> Configuration
                        </button>
                    </div>
                </div>
                
                <!-- ðŸ”§ System Category -->
                <div class="relative">
                    <button @click.stop="openDropdown = openDropdown === 'system' ? null : 'system'"
                            :class="['system', 'git', 'filebeat', 'backups'].includes(activeTab) ? 'border-orange-500 text-white bg-zinc-800/50' : 'border-transparent text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800/30'"
                            class="px-4 py-3 border-b-2 text-sm transition-colors whitespace-nowrap rounded-t-lg flex items-center gap-2">
                        <i class="fas fa-cogs"></i> System
                        <i class="fas fa-chevron-down text-[10px] transition-transform" :class="openDropdown === 'system' ? 'rotate-180' : ''"></i>
                    </button>
                    <div x-show="openDropdown === 'system'" x-cloak
                         class="absolute top-full left-0 mt-1 min-w-[200px] bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl p-1.5 z-[9999]">
                        <button @click="activeTab = 'system'; loadSystemInfo(); openDropdown = null" :class="activeTab === 'system' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-info-circle w-4 mr-2 text-blue-400"></i> System Info
                        </button>
                        <button @click="activeTab = 'git'; loadGitStatus(); openDropdown = null" :class="activeTab === 'git' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fab fa-git-alt w-4 mr-2 text-orange-400"></i> Git
                        </button>
                        <div class="h-px bg-zinc-700 my-1"></div>
                        <button @click="activeTab = 'filebeat'; loadFilebeatStatus(); openDropdown = null" :class="activeTab === 'filebeat' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-file-alt w-4 mr-2 text-amber-400"></i> Filebeat
                        </button>
                        <button @click="activeTab = 'backups'; loadBackups(); openDropdown = null" :class="activeTab === 'backups' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-archive w-4 mr-2 text-teal-400"></i> Backups
                        </button>
                    </div>
                </div>
                
                <!-- ðŸ” Security Category -->
                <div class="relative">
                    <button @click.stop="openDropdown = openDropdown === 'security' ? null : 'security'"
                            :class="['access', 'rbac'].includes(activeTab) ? 'border-orange-500 text-white bg-zinc-800/50' : 'border-transparent text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800/30'"
                            class="px-4 py-3 border-b-2 text-sm transition-colors whitespace-nowrap rounded-t-lg flex items-center gap-2">
                        <i class="fas fa-shield-alt"></i> Security
                        <i class="fas fa-chevron-down text-[10px] transition-transform" :class="openDropdown === 'security' ? 'rotate-180' : ''"></i>
                    </button>
                    <div x-show="openDropdown === 'security'" x-cloak
                         class="absolute top-full left-0 mt-1 min-w-[200px] bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl p-1.5 z-[9999]">
                        <button @click="activeTab = 'access'; loadServerAccess(); openDropdown = null" :class="activeTab === 'access' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-users w-4 mr-2 text-indigo-400"></i> Access Control
                        </button>
                        <button @click="activeTab = 'rbac'; loadRoles(); openDropdown = null" :class="activeTab === 'rbac' ? 'bg-orange-500 text-white' : 'text-zinc-300 hover:bg-zinc-800'" class="w-full text-left px-3 py-2 rounded-md text-sm flex items-center">
                            <i class="fas fa-user-shield w-4 mr-2 text-violet-400"></i> RBAC / Roles
                        </button>
                    </div>
                </div>
                
                <!-- ðŸ“¦ Replays (Direct) -->
                <button @click="activeTab = 'replays'; loadReplays(); openDropdown = null" 
                        :class="activeTab === 'replays' ? 'border-orange-500 text-white bg-zinc-800/50' : 'border-transparent text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800/30'"
                        class="px-4 py-3 border-b-2 text-sm transition-colors whitespace-nowrap rounded-t-lg flex items-center gap-2">
                    <i class="fas fa-film"></i> Replays
                    <span class="px-1.5 py-0.5 text-xs bg-zinc-700 rounded" x-text="replays.length"></span>
                </button>
                
                <!-- Auto-Refresh & Refresh Button -->
                <div class="ml-auto flex items-center gap-2">
                    <!-- Auto-Refresh Toggle -->
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-zinc-800/50 rounded-lg border border-zinc-700">
                        <button @click="toggleAutoRefresh()" 
                                :class="autoRefreshEnabled ? 'text-green-400' : 'text-zinc-500 hover:text-zinc-300'"
                                class="text-sm transition-colors flex items-center gap-1.5"
                                :title="autoRefreshEnabled ? 'Auto-refresh ON' : 'Auto-refresh OFF'">
                            <i class="fas" :class="autoRefreshEnabled ? 'fa-toggle-on text-lg' : 'fa-toggle-off text-lg'"></i>
                            <span class="hidden sm:inline text-xs">Auto</span>
                        </button>
                        <select x-model="autoRefreshInterval" @change="restartAutoRefresh()" 
                                class="bg-zinc-900 text-zinc-300 text-xs rounded px-1.5 py-0.5 border border-zinc-700 focus:outline-none focus:border-orange-500"
                                :disabled="!autoRefreshEnabled">
                            <option value="5">5s</option>
                            <option value="10">10s</option>
                            <option value="30">30s</option>
                            <option value="60">1m</option>
                        </select>
                        <span x-show="autoRefreshEnabled" class="text-xs text-green-400 animate-pulse">
                            <i class="fas fa-circle text-[6px]"></i>
                        </span>
                    </div>
                    
                    <!-- Manual Refresh Button -->
                    <button @click="refreshServerDetails()" :disabled="detailsLoading"
                            class="px-3 py-1.5 text-zinc-500 hover:text-white text-sm transition-colors disabled:opacity-50 bg-zinc-800/50 rounded-lg border border-zinc-700"
                            title="Refresh Now">
                        <i class="fas fa-sync-alt" :class="detailsLoading ? 'fa-spin' : ''"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-4 overflow-y-auto flex-1">
                <!-- ==================== OVERVIEW TAB ==================== -->
                <div x-show="activeTab === 'overview'">
                    <!-- Server Manager Section -->
                <div class="bg-zinc-800/50 rounded-lg p-4 mb-4 border border-zinc-800">
                    <h4 class="text-sm font-medium mb-4 text-zinc-400">Server Manager</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <!-- Running Servers -->
                        <div class="bg-zinc-900 rounded p-4 text-center border border-zinc-800">
                            <div class="text-3xl font-bold text-white" 
                                 x-text="statusData?.running_servers || statusData?.runningServers || 0"></div>
                            <div class="text-xs text-zinc-500">Running</div>
                        </div>
                        
                        <!-- Target Servers -->
                        <div class="bg-zinc-900 rounded p-4 border border-zinc-800">
                            <div class="text-xs text-zinc-500 mb-2 text-center">Target</div>
                            <div class="flex items-center justify-center gap-2">
                                <button @click="targetServers = Math.max(0, targetServers - 1)"
                                        class="w-8 h-8 bg-zinc-700 hover:bg-zinc-600 rounded flex items-center justify-center text-sm transition-colors">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" x-model="targetServers" min="0" max="20"
                                       class="w-12 h-8 bg-zinc-800 border border-zinc-700 rounded text-center font-medium">
                                <button @click="targetServers = Math.min(20, targetServers + 1)"
                                        class="w-8 h-8 bg-zinc-700 hover:bg-zinc-600 rounded flex items-center justify-center text-sm transition-colors">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Scale -->
                        <div class="bg-zinc-900 rounded p-4 border border-zinc-800">
                            <div class="text-xs text-zinc-500 mb-2 text-center">Quick</div>
                            <div class="flex items-center justify-center gap-1">
                                <template x-for="n in [1, 2, 4, 8, 0]" :key="n">
                                    <button @click="targetServers = n; applyScale()"
                                            :class="targetServers === n ? 'bg-orange-500 text-white' : 'bg-zinc-700 hover:bg-zinc-600'"
                                            class="w-8 h-8 rounded flex items-center justify-center text-sm font-medium transition-colors"
                                            x-text="n"></button>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <button @click="applyScale()" :disabled="controlLoading"
                            class="w-full py-2 bg-orange-500 hover:bg-orange-600 rounded text-sm font-medium transition-colors disabled:opacity-50">
                        Apply Changes
                    </button>
                </div>
                
                <!-- Connection Status -->
                <div class="bg-zinc-800/50 rounded-lg p-4 mb-4 border border-zinc-800">
                    <h4 class="text-sm font-medium mb-3 text-zinc-400">Connections</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full" 
                                  :class="statusData?.master_server_connected || statusData?.masterServerConnected ? 'bg-green-400' : 'bg-zinc-600'"></span>
                            <div>
                                <div class="text-xs text-zinc-500">Master</div>
                                <div class="text-sm" 
                                     :class="statusData?.master_server_connected || statusData?.masterServerConnected ? 'text-green-400' : 'text-zinc-600'"
                                     x-text="statusData?.master_server_connected || statusData?.masterServerConnected ? 'Online' : 'Offline'"></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full" 
                                  :class="statusData?.chat_server_connected || statusData?.chatServerConnected ? 'bg-green-400' : 'bg-zinc-600'"></span>
                            <div>
                                <div class="text-xs text-zinc-500">Chat</div>
                                <div class="text-sm" 
                                     :class="statusData?.chat_server_connected || statusData?.chatServerConnected ? 'text-green-400' : 'text-zinc-600'"
                                     x-text="statusData?.chat_server_connected || statusData?.chatServerConnected ? 'Online' : 'Offline'"></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-400"></span>
                            <div>
                                <div class="text-xs text-zinc-500">Portal</div>
                                <div class="text-sm text-green-400">OK</div>
                            </div>
                        </div>
                        <div>
                            <div class="text-xs text-zinc-500">Version</div>
                            <div class="text-sm text-white" x-text="statusData?.hon_version || statusData?.honVersion || '-'"></div>
                        </div>
                    </div>
                </div>
                
                <!-- System Stats -->
                <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                    <h4 class="text-sm font-medium mb-3 text-zinc-400">System</h4>
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                        <div class="text-center">
                            <div class="text-xs text-zinc-500 mb-1">CPU</div>
                            <div class="text-xl font-medium" 
                                 :class="(statusData?.system_stats?.cpu_percent || statusData?.systemStats?.cpuPercent || 0) > 80 ? 'text-red-400' : 'text-white'"
                                 x-text="(statusData?.system_stats?.cpu_percent || statusData?.systemStats?.cpuPercent || 0).toFixed(1) + '%'"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-zinc-500 mb-1">Memory</div>
                            <div class="text-xl font-medium text-white"
                                 x-text="(statusData?.system_stats?.memory_percent || statusData?.systemStats?.memoryPercent || 0).toFixed(1) + '%'"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-zinc-500 mb-1">Uptime</div>
                            <div class="text-xl font-medium text-white"
                                 x-text="formatUptime(statusData?.system_stats?.uptime_seconds || statusData?.systemStats?.uptimeSeconds)"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-zinc-500 mb-1">CPU Cores</div>
                            <div class="text-xl font-medium text-white"
                                 x-text="statusData?.system_stats?.cpu_count || statusData?.systemStats?.cpuCount || '-'"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-zinc-500 mb-1">Target</div>
                            <div class="text-xl font-medium"
                                 :class="getSvrTargetColor(statusData)"
                                 x-text="(statusData?.system_stats?.svr_total || statusData?.systemStats?.svrTotal || (statusData?.total_servers || statusData?.totalServers || '-'))"></div>
                            <div class="text-[10px] text-zinc-600" x-text="'(' + (statusData?.running_servers || statusData?.runningServers || 0) + ' running)'"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-zinc-500 mb-1">Max Allowed</div>
                            <div class="text-xl font-medium" 
                                 :class="(statusData?.system_stats?.svr_total || statusData?.systemStats?.svrTotal || 0) > (statusData?.system_stats?.max_allowed_servers || statusData?.systemStats?.maxAllowedServers || 0) ? 'text-red-400' : 'text-green-400'"
                                 x-text="(statusData?.system_stats?.max_allowed_servers || statusData?.systemStats?.maxAllowedServers || getMaxServers(statusData?.system_stats?.cpu_count || statusData?.systemStats?.cpuCount || 0)) || '-'"></div>
                            <div class="text-[10px] text-zinc-600" x-text="'(' + (statusData?.system_stats?.svr_total_per_core || statusData?.systemStats?.svrTotalPerCore || 1) + '/CPU)'"></div>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- ==================== INSTANCES TAB ==================== -->
                <div x-show="activeTab === 'instances'">
                <!-- Game Instances Section -->
                <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
                        <span class="text-sm text-zinc-400">Instances <span x-text="filteredInstances.length + '/' + (statusData?.total_servers || statusData?.totalServers || 0)"></span></span>
                        
                        <!-- Search, Filter & Sort -->
                        <div class="flex items-center gap-2">
                            <input type="text" x-model="instanceSearch" placeholder="Search..."
                                   class="w-28 h-7 bg-zinc-900 border border-zinc-700 rounded px-2 text-xs">
                            <select x-model="instanceFilter" class="h-7 bg-zinc-900 border border-zinc-700 rounded text-xs px-1">
                                <option value="all">All</option>
                                <option value="Ready">Ready</option>
                                <option value="Occupied">Occupied</option>
                                <option value="Offline">Offline</option>
                            </select>
                            <select x-model="instanceSort" class="h-7 bg-zinc-900 border border-zinc-700 rounded text-xs px-1">
                                <option value="id">ID</option>
                                <option value="status">Status</option>
                                <option value="port">Port</option>
                                <option value="players">Players</option>
                            </select>
                            <button @click="instanceSortAsc = !instanceSortAsc" 
                                    class="h-7 w-7 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded flex items-center justify-center text-xs transition-colors">
                                <i class="fas" :class="instanceSortAsc ? 'fa-sort-up' : 'fa-sort-down'"></i>
                            </button>
                            <div class="flex border border-zinc-700 rounded overflow-hidden">
                                <button @click="instanceViewMode = 'grid'" 
                                        :class="instanceViewMode === 'grid' ? 'bg-zinc-700' : 'bg-zinc-800 hover:bg-zinc-700'"
                                        class="h-7 w-7 flex items-center justify-center text-xs transition-colors">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button @click="instanceViewMode = 'list'" 
                                        :class="instanceViewMode === 'list' ? 'bg-zinc-700' : 'bg-zinc-800 hover:bg-zinc-700'"
                                        class="h-7 w-7 flex items-center justify-center text-xs transition-colors">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div x-show="!filteredInstances.length" class="text-zinc-500 text-center py-8 text-sm">
                        No instances found
                    </div>

                    <!-- Table View (List Mode) -->
                    <div x-show="instanceViewMode === 'list' && filteredInstances.length" class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-zinc-700 text-left text-xs text-zinc-500">
                                    <th class="pb-2 pl-2">ID</th>
                                    <th class="pb-2">Status</th>
                                    <th class="pb-2">Port</th>
                                    <th class="pb-2">Players</th>
                                    <th class="pb-2">Phase</th>
                                    <th class="pb-2">Uptime</th>
                                    <th class="pb-2 text-right pr-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="instance in sortedInstances" :key="instance.id">
                                    <tr class="border-b border-zinc-800 hover:bg-zinc-800/50">
                                        <td class="py-2 pl-2 text-zinc-400" x-text="'#' + instance.id"></td>
                                        <td class="py-2">
                                            <span class="flex items-center gap-1.5">
                                                <span class="w-1.5 h-1.5 rounded-full" :class="getStatusDotClass(instance)"></span>
                                                <span class="text-xs" x-text="instance.status || 'Unknown'"></span>
                                            </span>
                                        </td>
                                        <td class="py-2" x-text="instance.port"></td>
                                        <td class="py-2" x-text="(instance.num_clients ?? instance.numClients ?? 0) + '/10'"></td>
                                        <td class="py-2 text-xs text-zinc-400" x-text="instance.game_phase || instance.gamePhase || 'Idle'"></td>
                                        <td class="py-2 text-xs text-zinc-500" x-text="formatInstanceUptime(instance.start_time || instance.startTime)"></td>
                                        <td class="py-2 pr-2">
                                            <div class="flex items-center gap-1 justify-end">
                                                <!-- Sleep Status Badge -->
                                                <template x-if="isSleeping(instance.id)">
                                                    <div class="flex items-center gap-1 mr-1">
                                                        <span class="px-2 py-0.5 bg-blue-600/30 border border-blue-500/50 rounded text-xs text-blue-400 flex items-center gap-1"
                                                              title="Server is sleeping">
                                                            <i class="fas fa-moon"></i>
                                                            <span>Sleeping</span>
                                                        </span>
                                                        <button @click="wakeInstance(instance.id)" class="w-6 h-6 bg-yellow-600 hover:bg-yellow-500 rounded flex items-center justify-center text-xs" title="Wake Up">
                                                            <i class="fas fa-sun"></i>
                                                        </button>
                                                    </div>
                                                </template>
                                                <button @click="startInstance(instance.id)" :disabled="isStartDisabled(instance)"
                                                        class="w-6 h-6 bg-zinc-700 hover:bg-green-600 rounded flex items-center justify-center text-xs transition-colors disabled:opacity-30">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                <button @click="stopInstance(instance.id)" :disabled="isStopDisabled(instance) || isSleeping(instance.id)"
                                                        class="w-6 h-6 bg-zinc-700 hover:bg-red-600 rounded flex items-center justify-center text-xs transition-colors disabled:opacity-30">
                                                    <i class="fas fa-stop"></i>
                                                </button>
                                                <button @click="restartInstance(instance.id)" :disabled="isRestartDisabled(instance) || isSleeping(instance.id)"
                                                        class="w-6 h-6 bg-zinc-700 hover:bg-orange-600 rounded flex items-center justify-center text-xs transition-colors disabled:opacity-30">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                                <button @click="deleteInstance(instance.id)" :disabled="controlLoading || isSleeping(instance.id)"
                                                        class="w-6 h-6 bg-zinc-700 hover:bg-zinc-600 rounded flex items-center justify-center text-xs transition-colors disabled:opacity-30">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Grid View -->
                    <div x-show="instanceViewMode === 'grid' && filteredInstances.length" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                        <template x-for="instance in sortedInstances" :key="instance.id">
                            <div class="bg-zinc-900 rounded p-3 border border-zinc-800 hover:border-zinc-700 transition-colors" :class="{'border-blue-500/50': isSleeping(instance.id)}">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-2 h-2 rounded-full" :class="getStatusDotClass(instance)"></span>
                                    <span class="text-sm" x-text="'#' + instance.id"></span>
                                    <span class="text-xs text-zinc-500" x-text="instance.status || 'Unknown'"></span>
                                    <!-- Sleep Badge -->
                                    <template x-if="isSleeping(instance.id)">
                                        <span class="ml-auto px-2 py-0.5 bg-blue-600/30 border border-blue-500/50 rounded text-xs text-blue-400 flex items-center gap-1">
                                            <i class="fas fa-moon"></i>
                                            <span>Sleeping</span>
                                        </span>
                                    </template>
                                </div>
                                <div class="text-xs text-zinc-500 space-y-1 mb-3">
                                    <div class="flex justify-between">
                                        <span>Port</span>
                                        <span class="text-white" x-text="instance.port"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Players</span>
                                        <span class="text-white" x-text="(instance.num_clients ?? instance.numClients ?? 0) + '/10'"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Phase</span>
                                        <span class="text-zinc-400" x-text="instance.game_phase || instance.gamePhase || 'Idle'"></span>
                                    </div>
                                    <!-- Sleep Status -->
                                    <template x-if="isSleeping(instance.id)">
                                        <div class="flex justify-between text-blue-400">
                                            <span>Status</span>
                                            <span x-text="getSleepStatus(instance.id)"></span>
                                        </div>
                                    </template>
                                </div>
                                <div class="flex items-center gap-1">
                                    <template x-if="isSleeping(instance.id)">
                                        <button @click="wakeInstance(instance.id)"
                                                class="flex-1 h-7 bg-yellow-600 hover:bg-yellow-500 rounded text-xs transition-colors">
                                            <i class="fas fa-sun mr-1"></i>Wake
                                        </button>
                                    </template>
                                    <template x-if="!isSleeping(instance.id)">
                                        <button @click="startInstance(instance.id)" :disabled="isStartDisabled(instance)"
                                                class="flex-1 h-7 bg-zinc-800 hover:bg-green-600 rounded text-xs transition-colors disabled:opacity-30">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    </template>
                                    <template x-if="!isSleeping(instance.id)">
                                        <button @click="stopInstance(instance.id)" :disabled="isStopDisabled(instance)"
                                                class="flex-1 h-7 bg-zinc-800 hover:bg-red-600 rounded text-xs transition-colors disabled:opacity-30">
                                            <i class="fas fa-stop"></i>
                                        </button>
                                    </template>
                                    <template x-if="!isSleeping(instance.id)">
                                        <button @click="restartInstance(instance.id)" :disabled="isRestartDisabled(instance)"
                                                class="flex-1 h-7 bg-zinc-800 hover:bg-orange-600 rounded text-xs transition-colors disabled:opacity-30">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Add Instance Button -->
                    <button @click="showAddInstanceModal = true" :disabled="controlLoading"
                            class="mt-4 w-full py-2 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded text-sm transition-colors disabled:opacity-50">
                        <i class="fas fa-plus mr-2"></i>Add Instance
                    </button>
                </div>
                </div>

                <!-- ==================== STATISTICS TAB ==================== -->
                <div x-show="activeTab === 'stats'">
                    <div class="bg-zinc-800/50 rounded-lg p-4 mb-4 border border-zinc-800">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-medium text-zinc-400">
                                <i class="fas fa-chart-bar mr-2"></i>Statistics Summary
                            </h4>
                            <button @click="loadStatistics()" :disabled="statsLoading"
                                    class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors disabled:opacity-50">
                                <i class="fas fa-sync-alt" :class="statsLoading ? 'fa-spin' : ''"></i>
                                <span class="ml-1">Refresh</span>
                            </button>
                        </div>
                        
                        <!-- Stats Summary Cards -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" x-show="statsSummary">
                            <div class="bg-zinc-900 rounded p-3 text-center">
                                <div class="text-2xl font-bold text-orange-400" x-text="statsSummary?.totalMatches || 0"></div>
                                <div class="text-xs text-zinc-500">Total Matches</div>
                            </div>
                            <div class="bg-zinc-900 rounded p-3 text-center">
                                <div class="text-2xl font-bold text-blue-400" x-text="statsSummary?.totalPlayers || 0"></div>
                                <div class="text-xs text-zinc-500">Total Players</div>
                            </div>
                            <div class="bg-zinc-900 rounded p-3 text-center">
                                <div class="text-2xl font-bold text-green-400" x-text="statsSummary?.avgMatchDuration || '0m'"></div>
                                <div class="text-xs text-zinc-500">Avg Duration</div>
                            </div>
                            <div class="bg-zinc-900 rounded p-3 text-center">
                                <div class="text-2xl font-bold text-purple-400" x-text="statsSummary?.totalPlayTime || '0h'"></div>
                                <div class="text-xs text-zinc-500">Total Play Time</div>
                            </div>
                        </div>
                        
                        <!-- Recent Matches -->
                        <h5 class="text-sm font-medium text-zinc-400 mb-3">Recent Matches</h5>
                        <div x-show="statsLoading" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin text-xl text-zinc-500"></i>
                        </div>
                        <div x-show="!statsLoading && recentMatches.length === 0" class="text-center py-4 text-zinc-500">
                            No matches found
                        </div>
                        <div x-show="!statsLoading && recentMatches.length > 0" class="space-y-2 max-h-64 overflow-y-auto">
                            <template x-for="match in recentMatches" :key="match.matchId">
                                <div class="bg-zinc-900 rounded p-3 flex justify-between items-center">
                                    <div>
                                        <span class="text-orange-400 font-mono" x-text="'#' + match.matchId"></span>
                                        <span class="text-zinc-500 text-sm ml-2" x-text="match.map || 'Unknown Map'"></span>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm" x-text="match.duration || 'N/A'"></div>
                                        <div class="text-xs text-zinc-500" x-text="match.date"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Top Players -->
                        <h5 class="text-sm font-medium text-zinc-400 mb-3 mt-6">Top Players</h5>
                        <div x-show="topPlayers.length > 0" class="grid grid-cols-2 gap-2">
                            <template x-for="(player, idx) in topPlayers.slice(0, 6)" :key="player.name">
                                <div class="bg-zinc-900 rounded p-2 flex items-center gap-2">
                                    <span class="text-orange-400 font-bold" x-text="'#' + (idx + 1)"></span>
                                    <span class="flex-1 truncate" x-text="player.name"></span>
                                    <span class="text-green-400 text-sm" x-text="player.winRate + '%'"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- ==================== LOGS TAB ==================== -->
                <div x-show="activeTab === 'logs'">
                    <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-medium text-zinc-400">
                                <i class="fas fa-scroll mr-2"></i>Server Logs
                            </h4>
                            <div class="flex gap-2 items-center">
                                <select x-model="selectedLogInstance" @change="loadLogs()"
                                        class="h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm">
                                    <template x-for="inst in (statusData?.instances || [])" :key="inst.id">
                                        <option :value="inst.id" x-text="'Instance ' + inst.id"></option>
                                    </template>
                                </select>
                                <button @click="downloadLogs()" :disabled="logsLoading"
                                        class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded text-xs transition-colors disabled:opacity-50">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button @click="loadLogs()" :disabled="logsLoading"
                                        class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors disabled:opacity-50">
                                    <i class="fas fa-sync-alt" :class="logsLoading ? 'fa-spin' : ''"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div x-show="logsLoading" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-2xl text-zinc-500"></i>
                        </div>
                        
                        <div x-show="!logsLoading" 
                             class="bg-zinc-900 rounded p-3 font-mono text-xs h-96 overflow-auto whitespace-pre-wrap"
                             x-text="serverLogs || 'No logs available'">
                        </div>
                    </div>
                </div>

                <!-- ==================== HEALTH TAB ==================== -->
                <div x-show="activeTab === 'health'">
                    <div class="bg-zinc-800/50 rounded-lg p-4 mb-4 border border-zinc-800">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-medium text-zinc-400">
                                <i class="fas fa-heartbeat mr-2"></i>System Health
                            </h4>
                            <div class="flex gap-2">
                                <button @click="runHealthChecks()" :disabled="healthLoading"
                                        class="px-3 py-1.5 bg-green-600 hover:bg-green-500 rounded text-xs transition-colors disabled:opacity-50">
                                    <i class="fas fa-stethoscope"></i>
                                    <span class="ml-1">Run Checks</span>
                                </button>
                                <button @click="loadHealth()" :disabled="healthLoading"
                                        class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors disabled:opacity-50">
                                    <i class="fas fa-sync-alt" :class="healthLoading ? 'fa-spin' : ''"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- System Resources -->
                        <div class="grid grid-cols-3 gap-4 mb-6" x-show="systemResources">
                            <div class="bg-zinc-900 rounded p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-zinc-500">CPU</span>
                                    <span class="text-sm font-bold" :class="systemResources?.cpuUsage > 80 ? 'text-red-400' : 'text-green-400'" 
                                          x-text="(systemResources?.cpuUsage || 0) + '%'"></span>
                                </div>
                                <div class="h-2 bg-zinc-800 rounded overflow-hidden">
                                    <div class="h-full transition-all" 
                                         :class="systemResources?.cpuUsage > 80 ? 'bg-red-500' : 'bg-green-500'"
                                         :style="'width: ' + (systemResources?.cpuUsage || 0) + '%'"></div>
                                </div>
                            </div>
                            <div class="bg-zinc-900 rounded p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-zinc-500">Memory</span>
                                    <span class="text-sm font-bold" :class="systemResources?.memoryUsage > 80 ? 'text-red-400' : 'text-blue-400'"
                                          x-text="(systemResources?.memoryUsage || 0) + '%'"></span>
                                </div>
                                <div class="h-2 bg-zinc-800 rounded overflow-hidden">
                                    <div class="h-full transition-all"
                                         :class="systemResources?.memoryUsage > 80 ? 'bg-red-500' : 'bg-blue-500'"
                                         :style="'width: ' + (systemResources?.memoryUsage || 0) + '%'"></div>
                                </div>
                            </div>
                            <div class="bg-zinc-900 rounded p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-zinc-500">Disk</span>
                                    <span class="text-sm font-bold" :class="systemResources?.diskUsage > 90 ? 'text-red-400' : 'text-purple-400'"
                                          x-text="(systemResources?.diskUsage || 0) + '%'"></span>
                                </div>
                                <div class="h-2 bg-zinc-800 rounded overflow-hidden">
                                    <div class="h-full transition-all"
                                         :class="systemResources?.diskUsage > 90 ? 'bg-red-500' : 'bg-purple-500'"
                                         :style="'width: ' + (systemResources?.diskUsage || 0) + '%'"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Health Checks -->
                        <h5 class="text-sm font-medium text-zinc-400 mb-3">Health Checks</h5>
                        <div x-show="healthLoading" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin text-xl text-zinc-500"></i>
                        </div>
                        <div x-show="!healthLoading && healthChecks.length > 0" class="space-y-2">
                            <template x-for="check in healthChecks" :key="check.name">
                                <div class="bg-zinc-900 rounded p-3 flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <i class="fas" :class="check.status === 'Healthy' ? 'fa-check-circle text-green-400' : (check.status === 'Warning' ? 'fa-exclamation-triangle text-yellow-400' : 'fa-times-circle text-red-400')"></i>
                                        <span x-text="check.name"></span>
                                    </div>
                                    <span class="text-xs text-zinc-500" x-text="check.message || check.status"></span>
                                </div>
                            </template>
                        </div>
                        <div x-show="!healthLoading && healthChecks.length === 0" class="text-center py-4 text-zinc-500">
                            No health check data available
                        </div>
                    </div>
                </div>

                <!-- ==================== SYSTEM TAB ==================== -->
                <div x-show="activeTab === 'system'">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Patching -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <h4 class="text-sm font-medium text-zinc-400 mb-4">
                                <i class="fas fa-download mr-2"></i>Patching
                            </h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-zinc-500">Current Version</span>
                                    <span class="font-mono" x-text="patchStatus?.currentVersion || 'Unknown'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-zinc-500">Latest Version</span>
                                    <span class="font-mono" :class="patchStatus?.updateAvailable ? 'text-orange-400' : 'text-green-400'"
                                          x-text="patchStatus?.latestVersion || 'Unknown'"></span>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button @click="checkForPatches()" :disabled="patchLoading"
                                            class="flex-1 py-2 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors disabled:opacity-50">
                                        <i class="fas fa-search" :class="patchLoading ? 'fa-spin' : ''"></i>
                                        <span class="ml-1">Check</span>
                                    </button>
                                    <button @click="applyPatch()" :disabled="patchLoading || !patchStatus?.updateAvailable"
                                            class="flex-1 py-2 bg-orange-600 hover:bg-orange-500 rounded text-xs transition-colors disabled:opacity-50">
                                        <i class="fas fa-download"></i>
                                        <span class="ml-1">Apply Patch</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AutoPing -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <h4 class="text-sm font-medium text-zinc-400 mb-4">
                                <i class="fas fa-satellite-dish mr-2"></i>AutoPing
                            </h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-zinc-500">Status</span>
                                    <span :class="autoPingStatus?.running ? 'text-green-400' : 'text-zinc-500'"
                                          x-text="autoPingStatus?.running ? 'Running' : 'Stopped'"></span>
                                </div>
                                <div class="flex justify-between" x-show="autoPingStatus?.port">
                                    <span class="text-zinc-500">Port</span>
                                    <span class="font-mono" x-text="autoPingStatus?.port"></span>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button @click="startAutoPing()" :disabled="autoPingLoading || autoPingStatus?.running"
                                            class="flex-1 py-2 bg-green-600 hover:bg-green-500 rounded text-xs transition-colors disabled:opacity-50">
                                        <i class="fas fa-play"></i>
                                        <span class="ml-1">Start</span>
                                    </button>
                                    <button @click="stopAutoPing()" :disabled="autoPingLoading || !autoPingStatus?.running"
                                            class="flex-1 py-2 bg-red-600 hover:bg-red-500 rounded text-xs transition-colors disabled:opacity-50">
                                        <i class="fas fa-stop"></i>
                                        <span class="ml-1">Stop</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MQTT -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <h4 class="text-sm font-medium text-zinc-400 mb-4">
                                <i class="fas fa-broadcast-tower mr-2"></i>MQTT
                            </h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-zinc-500">Status</span>
                                    <span :class="mqttStatus?.connected ? 'text-green-400' : 'text-zinc-500'"
                                          x-text="mqttStatus?.connected ? 'Connected' : 'Disconnected'"></span>
                                </div>
                                <div class="flex justify-between" x-show="mqttStatus?.broker">
                                    <span class="text-zinc-500">Broker</span>
                                    <span class="font-mono text-xs truncate max-w-32" x-text="mqttStatus?.broker"></span>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button @click="connectMqtt()" :disabled="mqttLoading || mqttStatus?.connected"
                                            class="flex-1 py-2 bg-green-600 hover:bg-green-500 rounded text-xs transition-colors disabled:opacity-50">
                                        <i class="fas fa-plug"></i>
                                        <span class="ml-1">Connect</span>
                                    </button>
                                    <button @click="disconnectMqtt()" :disabled="mqttLoading || !mqttStatus?.connected"
                                            class="flex-1 py-2 bg-red-600 hover:bg-red-500 rounded text-xs transition-colors disabled:opacity-50">
                                        <i class="fas fa-unlink"></i>
                                        <span class="ml-1">Disconnect</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Discord -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <h4 class="text-sm font-medium text-zinc-400 mb-4">
                                <i class="fab fa-discord mr-2"></i>Discord Bot
                            </h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-zinc-500">Status</span>
                                    <span :class="discordStatus?.connected ? 'text-green-400' : 'text-zinc-500'"
                                          x-text="discordStatus?.connected ? 'Connected' : 'Disconnected'"></span>
                                </div>
                                <div class="flex justify-between" x-show="discordStatus?.channelId">
                                    <span class="text-zinc-500">Channel</span>
                                    <span class="font-mono text-xs" x-text="discordStatus?.channelId"></span>
                                </div>
                                <button @click="testDiscordNotification()" :disabled="discordLoading"
                                        class="w-full py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-xs transition-colors disabled:opacity-50 mt-4">
                                    <i class="fas fa-bell"></i>
                                    <span class="ml-1">Send Test Notification</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Scheduled Tasks -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800 md:col-span-2">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400">
                                    <i class="fas fa-clock mr-2"></i>Scheduled Tasks
                                </h4>
                                <button @click="loadScheduledTasks()" :disabled="tasksLoading"
                                        class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors disabled:opacity-50">
                                    <i class="fas fa-sync-alt" :class="tasksLoading ? 'fa-spin' : ''"></i>
                                </button>
                            </div>
                            <div x-show="scheduledTasks.length > 0" class="space-y-2">
                                <template x-for="task in scheduledTasks" :key="task.name">
                                    <div class="bg-zinc-900 rounded p-3 flex justify-between items-center">
                                        <div>
                                            <span class="font-medium" x-text="task.name"></span>
                                            <span class="text-xs text-zinc-500 ml-2" x-text="task.schedule || task.interval"></span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span :class="task.enabled ? 'text-green-400' : 'text-zinc-500'" 
                                                  x-text="task.enabled ? 'Enabled' : 'Disabled'"></span>
                                            <button @click="runTask(task.name)" :disabled="tasksLoading"
                                                    class="px-2 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            <button @click="toggleTask(task.name, !task.enabled)" :disabled="tasksLoading"
                                                    class="px-2 py-1 rounded text-xs"
                                                    :class="task.enabled ? 'bg-red-600 hover:bg-red-500' : 'bg-green-600 hover:bg-green-500'">
                                                <i :class="task.enabled ? 'fas fa-pause' : 'fas fa-play'"></i>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div x-show="!tasksLoading && scheduledTasks.length === 0" class="text-center py-4 text-zinc-500">
                                No scheduled tasks
                            </div>
                        </div>
                        
                        <!-- CLI Console -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800 md:col-span-2">
                            <h4 class="text-sm font-medium text-zinc-400 mb-4">
                                <i class="fas fa-terminal mr-2"></i>CLI Console
                            </h4>
                            <div class="flex gap-2 mb-3">
                                <input type="text" x-model="cliCommand" @keyup.enter="executeCliCommand()"
                                       placeholder="Enter command..."
                                       class="flex-1 h-9 bg-zinc-900 border border-zinc-700 rounded px-3 text-sm font-mono focus:border-zinc-600 focus:outline-none">
                                <button @click="executeCliCommand()" :disabled="cliLoading"
                                        class="px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded text-sm transition-colors disabled:opacity-50">
                                    <i class="fas fa-paper-plane" :class="cliLoading ? 'fa-spin' : ''"></i>
                                </button>
                            </div>
                            <div class="bg-zinc-900 rounded p-3 font-mono text-xs h-32 overflow-auto whitespace-pre-wrap"
                                 x-text="cliOutput || 'Type a command and press Enter...'">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== SCALING TAB ==================== -->
                <div x-show="activeTab === 'scaling'">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Auto-Scaling Status -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400">
                                    <i class="fas fa-expand-arrows-alt mr-2"></i>Auto-Scaling Status
                                </h4>
                                <button @click="loadScalingStatus()" :disabled="scalingLoading"
                                        class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors disabled:opacity-50">
                                    <i class="fas fa-sync-alt" :class="scalingLoading ? 'fa-spin' : ''"></i>
                                </button>
                            </div>
                            <div x-show="scalingLoading" class="text-center py-6">
                                <i class="fas fa-spinner fa-spin text-xl text-zinc-500"></i>
                            </div>
                            <div x-show="!scalingLoading && scalingStatus" class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-zinc-500">Enabled</span>
                                    <span :class="scalingStatus?.enabled ? 'text-green-400' : 'text-zinc-500'"
                                          x-text="scalingStatus?.enabled ? 'Yes' : 'No'"></span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-zinc-500">Current Instances</span>
                                    <span class="font-mono text-white" x-text="scalingStatus?.currentInstances || 0"></span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-zinc-500">Target Instances</span>
                                    <span class="font-mono text-white" x-text="scalingStatus?.targetInstances || 0"></span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-zinc-500">Min Instances</span>
                                    <span class="font-mono" x-text="scalingStatus?.minInstances || 1"></span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-zinc-500">Max Instances</span>
                                    <span class="font-mono" x-text="scalingStatus?.maxInstances || 10"></span>
                                </div>
                                <div class="flex justify-between items-center" x-show="scalingStatus?.lastScaleAction">
                                    <span class="text-zinc-500">Last Action</span>
                                    <span class="text-xs text-zinc-400" x-text="scalingStatus?.lastScaleAction"></span>
                                </div>
                            </div>
                            <div x-show="!scalingLoading && !scalingStatus" class="text-center py-6 text-zinc-500 text-sm">
                                No scaling data available
                            </div>
                        </div>
                        
                        <!-- Manual Scaling Controls -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <h4 class="text-sm font-medium text-zinc-400 mb-4">
                                <i class="fas fa-sliders-h mr-2"></i>Manual Scaling
                            </h4>
                            <div class="space-y-4">
                                <p class="text-xs text-zinc-500">
                                    Manually scale your game server instances up or down.
                                </p>
                                <div class="flex gap-2">
                                    <button @click="scaleUp()" :disabled="scalingLoading"
                                            class="flex-1 py-3 bg-green-600 hover:bg-green-500 rounded text-sm transition-colors disabled:opacity-50">
                                        <i class="fas fa-plus mr-2"></i>Scale Up
                                    </button>
                                    <button @click="scaleDown()" :disabled="scalingLoading"
                                            class="flex-1 py-3 bg-red-600 hover:bg-red-500 rounded text-sm transition-colors disabled:opacity-50">
                                        <i class="fas fa-minus mr-2"></i>Scale Down
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Crash Protection -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800 md:col-span-2">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400">
                                    <i class="fas fa-shield-alt mr-2 text-red-400"></i>Crash Protection
                                </h4>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs" :class="crashProtection.enabled ? 'text-green-400' : 'text-zinc-500'">
                                        <i class="fas fa-circle text-[8px] mr-1" :class="crashProtection.enabled ? 'animate-pulse' : ''"></i>
                                        <span x-text="crashProtection.enabled ? 'Active' : 'Disabled'"></span>
                                    </span>
                                    <button @click="saveCrashProtectionSettings()" :disabled="crashProtectionLoading"
                                            class="px-3 py-1.5 bg-orange-600 hover:bg-orange-500 rounded text-xs transition-colors disabled:opacity-50">
                                        <i class="fas fa-save" :class="crashProtectionLoading ? 'fa-spin' : ''"></i>
                                        <span class="ml-1">Save</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Settings -->
                                <div class="space-y-4">
                                    <h5 class="text-xs font-medium text-zinc-500 uppercase tracking-wider">Settings</h5>
                                    
                                    <!-- Enable Protection -->
                                    <div class="flex items-center justify-between bg-zinc-900 rounded p-3">
                                        <div>
                                            <span class="text-sm">Enable Protection</span>
                                            <p class="text-xs text-zinc-500">Monitor instances for crashes</p>
                                        </div>
                                        <button @click="crashProtection.enabled = !crashProtection.enabled"
                                                :class="crashProtection.enabled ? 'bg-green-600' : 'bg-zinc-700'"
                                                class="relative w-12 h-6 rounded-full transition-colors">
                                            <span class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all"
                                                  :class="crashProtection.enabled ? 'left-7' : 'left-1'"></span>
                                        </button>
                                    </div>
                                    
                                    <!-- Auto Restart -->
                                    <div class="flex items-center justify-between bg-zinc-900 rounded p-3">
                                        <div>
                                            <span class="text-sm">Auto-Restart on Crash</span>
                                            <p class="text-xs text-zinc-500">Automatically restart crashed instances</p>
                                        </div>
                                        <button @click="crashProtection.autoRestartEnabled = !crashProtection.autoRestartEnabled"
                                                :class="crashProtection.autoRestartEnabled ? 'bg-green-600' : 'bg-zinc-700'"
                                                class="relative w-12 h-6 rounded-full transition-colors"
                                                :disabled="!crashProtection.enabled">
                                            <span class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all"
                                                  :class="crashProtection.autoRestartEnabled ? 'left-7' : 'left-1'"></span>
                                        </button>
                                    </div>
                                    
                                    <!-- Max Restart Attempts -->
                                    <div class="bg-zinc-900 rounded p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm">Max Restart Attempts</span>
                                            <span class="text-xs text-orange-400 font-mono" x-text="crashProtection.maxRestartAttempts"></span>
                                        </div>
                                        <input type="range" min="1" max="10" x-model="crashProtection.maxRestartAttempts"
                                               class="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-orange-500"
                                               :disabled="!crashProtection.enabled || !crashProtection.autoRestartEnabled">
                                        <p class="text-xs text-zinc-500 mt-1">Stop trying after this many failures</p>
                                    </div>
                                    
                                    <!-- Restart Cooldown -->
                                    <div class="bg-zinc-900 rounded p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm">Restart Cooldown</span>
                                            <span class="text-xs text-blue-400 font-mono" x-text="crashProtection.restartCooldownSeconds + 's'"></span>
                                        </div>
                                        <input type="range" min="5" max="120" step="5" x-model="crashProtection.restartCooldownSeconds"
                                               class="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                               :disabled="!crashProtection.enabled || !crashProtection.autoRestartEnabled">
                                        <p class="text-xs text-zinc-500 mt-1">Wait time between restart attempts</p>
                                    </div>
                                    
                                    <!-- Monitor Interval -->
                                    <div class="bg-zinc-900 rounded p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm">Monitor Interval</span>
                                            <span class="text-xs text-purple-400 font-mono" x-text="crashProtection.monitorIntervalSeconds + 's'"></span>
                                        </div>
                                        <input type="range" min="5" max="60" step="5" x-model="crashProtection.monitorIntervalSeconds"
                                               class="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-purple-500"
                                               :disabled="!crashProtection.enabled">
                                        <p class="text-xs text-zinc-500 mt-1">How often to check instance health</p>
                                    </div>
                                    
                                    <!-- Notifications -->
                                    <div class="bg-zinc-900 rounded p-3 space-y-2">
                                        <span class="text-sm">Notifications</span>
                                        <label class="flex items-center gap-2 text-xs text-zinc-400 cursor-pointer">
                                            <input type="checkbox" x-model="crashProtection.notifyOnCrash" 
                                                   class="rounded bg-zinc-800 border-zinc-600 text-orange-500 focus:ring-orange-500"
                                                   :disabled="!crashProtection.enabled">
                                            Notify on crash detected
                                        </label>
                                        <label class="flex items-center gap-2 text-xs text-zinc-400 cursor-pointer">
                                            <input type="checkbox" x-model="crashProtection.notifyOnRestart" 
                                                   class="rounded bg-zinc-800 border-zinc-600 text-orange-500 focus:ring-orange-500"
                                                   :disabled="!crashProtection.enabled">
                                            Notify on auto-restart
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Crash History -->
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <h5 class="text-xs font-medium text-zinc-500 uppercase tracking-wider">Crash History</h5>
                                        <button @click="loadCrashHistory()" class="text-xs text-zinc-500 hover:text-white">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Stats Summary -->
                                    <div class="grid grid-cols-3 gap-2">
                                        <div class="bg-zinc-900 rounded p-3 text-center">
                                            <div class="text-lg font-bold text-red-400" x-text="crashHistory.filter(c => c.type === 'crash').length"></div>
                                            <div class="text-xs text-zinc-500">Crashes</div>
                                        </div>
                                        <div class="bg-zinc-900 rounded p-3 text-center">
                                            <div class="text-lg font-bold text-green-400" x-text="crashHistory.filter(c => c.type === 'restart').length"></div>
                                            <div class="text-xs text-zinc-500">Restarts</div>
                                        </div>
                                        <div class="bg-zinc-900 rounded p-3 text-center">
                                            <div class="text-lg font-bold text-blue-400" x-text="crashHistory.filter(c => c.recovered).length"></div>
                                            <div class="text-xs text-zinc-500">Recovered</div>
                                        </div>
                                    </div>
                                    
                                    <!-- History List -->
                                    <div class="bg-zinc-900 rounded max-h-[280px] overflow-y-auto">
                                        <template x-if="crashHistory.length === 0">
                                            <div class="p-4 text-center text-zinc-500 text-sm">
                                                <i class="fas fa-check-circle text-2xl text-green-500 mb-2"></i>
                                                <p>No crashes recorded</p>
                                                <p class="text-xs">All instances are running smoothly</p>
                                            </div>
                                        </template>
                                        <template x-for="event in crashHistory.slice(0, 20)" :key="event.id">
                                            <div class="p-3 border-b border-zinc-800 last:border-0 hover:bg-zinc-800/50">
                                                <div class="flex items-start justify-between">
                                                    <div class="flex items-center gap-2">
                                                        <i class="fas text-sm" 
                                                           :class="event.type === 'crash' ? 'fa-exclamation-triangle text-red-400' : 
                                                                   event.type === 'restart' ? 'fa-redo text-yellow-400' : 
                                                                   'fa-check-circle text-green-400'"></i>
                                                        <div>
                                                            <span class="text-sm font-medium" x-text="'Instance #' + event.instanceId"></span>
                                                            <span class="text-xs px-1.5 py-0.5 rounded ml-2"
                                                                  :class="event.type === 'crash' ? 'bg-red-500/20 text-red-400' : 
                                                                          event.type === 'restart' ? 'bg-yellow-500/20 text-yellow-400' : 
                                                                          'bg-green-500/20 text-green-400'"
                                                                  x-text="event.type.charAt(0).toUpperCase() + event.type.slice(1)"></span>
                                                        </div>
                                                    </div>
                                                    <span class="text-xs text-zinc-500" x-text="formatTimeAgo(event.timestamp)"></span>
                                                </div>
                                                <p class="text-xs text-zinc-500 mt-1 pl-6" x-text="event.message"></p>
                                                <div class="flex gap-2 mt-2 pl-6" x-show="event.type === 'crash' && !event.recovered">
                                                    <button @click="manualRestartCrashedInstance(event.instanceId)" 
                                                            class="text-xs px-2 py-1 bg-green-600 hover:bg-green-500 rounded">
                                                        <i class="fas fa-play mr-1"></i>Restart
                                                    </button>
                                                    <button @click="dismissCrashEvent(event.id)" 
                                                            class="text-xs px-2 py-1 bg-zinc-700 hover:bg-zinc-600 rounded">
                                                        <i class="fas fa-times mr-1"></i>Dismiss
                                                    </button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    
                                    <!-- Clear History -->
                                    <button @click="clearCrashHistory()" 
                                            x-show="crashHistory.length > 0"
                                            class="w-full py-2 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors">
                                        <i class="fas fa-trash mr-1"></i>Clear History
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Safe Mode / Player Protection -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800 md:col-span-2">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400">
                                    <i class="fas fa-user-shield mr-2 text-blue-400"></i>Player Protection (Safe Mode)
                                </h4>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs" :class="safeMode.enabled ? 'text-blue-400' : 'text-zinc-500'">
                                        <i class="fas fa-circle text-[8px] mr-1" :class="safeMode.enabled ? 'animate-pulse' : ''"></i>
                                        <span x-text="safeMode.enabled ? 'Protected' : 'Disabled'"></span>
                                    </span>
                                    <span x-show="Object.keys(sleepingInstances).length > 0" 
                                          class="text-xs px-2 py-0.5 bg-blue-600/30 border border-blue-500/50 rounded text-blue-400">
                                        <i class="fas fa-moon mr-1"></i>
                                        <span x-text="Object.keys(sleepingInstances).length + ' sleeping'"></span>
                                    </span>
                                </div>
                            </div>
                            
                            <p class="text-sm text-zinc-500 mb-4">
                                <i class="fas fa-info-circle text-blue-400 mr-1"></i>
                                Protect players by preventing accidental server stops/restarts while games are active.
                            </p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Settings -->
                                <div class="space-y-4">
                                    <h5 class="text-xs font-medium text-zinc-500 uppercase tracking-wider">Settings</h5>
                                    
                                    <!-- Enable Safe Mode -->
                                    <div class="flex items-center justify-between bg-zinc-900 rounded p-3">
                                        <div>
                                            <span class="text-sm">Enable Safe Mode</span>
                                            <p class="text-xs text-zinc-500">Prevent actions when players are in-game</p>
                                        </div>
                                        <button @click="safeMode.enabled = !safeMode.enabled"
                                                :class="safeMode.enabled ? 'bg-blue-600' : 'bg-zinc-700'"
                                                class="relative w-12 h-6 rounded-full transition-colors">
                                            <span class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all"
                                                  :class="safeMode.enabled ? 'left-7' : 'left-1'"></span>
                                        </button>
                                    </div>
                                    
                                    <!-- Require Confirmation -->
                                    <div class="flex items-center justify-between bg-zinc-900 rounded p-3">
                                        <div>
                                            <span class="text-sm">Require Confirmation</span>
                                            <p class="text-xs text-zinc-500">Show warning dialog before force actions</p>
                                        </div>
                                        <button @click="safeMode.requireConfirmation = !safeMode.requireConfirmation"
                                                :class="safeMode.requireConfirmation ? 'bg-blue-600' : 'bg-zinc-700'"
                                                class="relative w-12 h-6 rounded-full transition-colors"
                                                :disabled="!safeMode.enabled">
                                            <span class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all"
                                                  :class="safeMode.requireConfirmation ? 'left-7' : 'left-1'"></span>
                                        </button>
                                    </div>
                                    
                                    <!-- Auto Execute When Empty -->
                                    <div class="flex items-center justify-between bg-zinc-900 rounded p-3">
                                        <div>
                                            <span class="text-sm">Auto-Execute When Empty</span>
                                            <p class="text-xs text-zinc-500">Run pending action when players leave</p>
                                        </div>
                                        <button @click="safeMode.autoRestartWhenEmpty = !safeMode.autoRestartWhenEmpty"
                                                :class="safeMode.autoRestartWhenEmpty ? 'bg-blue-600' : 'bg-zinc-700'"
                                                class="relative w-12 h-6 rounded-full transition-colors"
                                                :disabled="!safeMode.enabled">
                                            <span class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all"
                                                  :class="safeMode.autoRestartWhenEmpty ? 'left-7' : 'left-1'"></span>
                                        </button>
                                    </div>
                                    
                                    <!-- Detection Mode -->
                                    <div class="bg-zinc-900 rounded p-3">
                                        <span class="text-sm block mb-2">Detection Mode</span>
                                        <div class="space-y-2">
                                            <label class="flex items-center gap-2 text-xs text-zinc-400 cursor-pointer">
                                                <input type="radio" name="detectionMode" value="players" 
                                                       :checked="!safeMode.strictMode"
                                                       @change="safeMode.strictMode = false"
                                                       class="text-blue-500 focus:ring-blue-500"
                                                       :disabled="!safeMode.enabled">
                                                <span><strong>Players Online</strong> - Protect when num_clients > 0</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-xs text-zinc-400 cursor-pointer">
                                                <input type="radio" name="detectionMode" value="game" 
                                                       :checked="safeMode.strictMode"
                                                       @change="safeMode.strictMode = true"
                                                       class="text-blue-500 focus:ring-blue-500"
                                                       :disabled="!safeMode.enabled">
                                                <span><strong>Game Active</strong> - Only during active game phase</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Sleeping Instances -->
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <h5 class="text-xs font-medium text-zinc-500 uppercase tracking-wider">Sleeping Instances</h5>
                                        <button @click="checkSleepingInstances()" class="text-xs text-zinc-500 hover:text-white">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Summary -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <div class="bg-zinc-900 rounded p-3 text-center">
                                            <div class="text-lg font-bold text-blue-400" x-text="Object.keys(sleepingInstances).length"></div>
                                            <div class="text-xs text-zinc-500">Sleeping</div>
                                        </div>
                                        <div class="bg-zinc-900 rounded p-3 text-center">
                                            <div class="text-lg font-bold text-green-400" x-text="statusData?.instances?.filter(i => !hasActivePlayers(i)).length || 0"></div>
                                            <div class="text-xs text-zinc-500">Empty</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Sleeping List -->
                                    <div class="bg-zinc-900 rounded max-h-[220px] overflow-y-auto">
                                        <template x-if="Object.keys(sleepingInstances).length === 0">
                                            <div class="p-4 text-center text-zinc-500 text-sm">
                                                <i class="fas fa-check-circle text-2xl text-green-500 mb-2"></i>
                                                <p>No sleeping instances</p>
                                                <p class="text-xs">All actions executed immediately</p>
                                            </div>
                                        </template>
                                        <template x-for="(info, instanceId) in sleepingInstances" :key="instanceId">
                                            <div class="p-3 border-b border-zinc-800 last:border-0 hover:bg-zinc-800/50">
                                                <div class="flex items-start justify-between">
                                                    <div class="flex items-center gap-2">
                                                        <i class="fas fa-moon text-blue-400 animate-pulse"></i>
                                                        <div>
                                                            <span class="text-sm font-medium" x-text="'Instance #' + instanceId"></span>
                                                            <span class="text-xs px-1.5 py-0.5 rounded ml-2"
                                                                  :class="info.pendingAction === 'stop' ? 'bg-red-500/20 text-red-400' : 'bg-orange-500/20 text-orange-400'"
                                                                  x-text="info.pendingAction === 'stop' ? 'Stopping' : 'Restarting'"></span>
                                                        </div>
                                                    </div>
                                                    <button @click="cancelSleep(instanceId)" 
                                                            class="text-xs px-2 py-1 bg-red-600 hover:bg-red-500 rounded">
                                                        <i class="fas fa-times mr-1"></i>Cancel
                                                    </button>
                                                </div>
                                                <p class="text-xs text-zinc-500 mt-1 pl-6">
                                                    <i class="fas fa-clock mr-1"></i>
                                                    Waiting since <span x-text="new Date(info.waitingSince).toLocaleTimeString()"></span>
                                                </p>
                                            </div>
                                        </template>
                                    </div>
                                    
                                    <!-- Cancel All -->
                                    <button @click="Object.keys(sleepingInstances).forEach(id => cancelSleep(id))" 
                                            x-show="Object.keys(sleepingInstances).length > 0"
                                            class="w-full py-2 bg-red-700 hover:bg-red-600 rounded text-xs transition-colors">
                                        <i class="fas fa-times mr-1"></i>Cancel All Sleeping
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Templates -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800 md:col-span-2">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400">
                                    <i class="fas fa-copy mr-2"></i>Server Templates
                                </h4>
                                <button @click="loadTemplates()" :disabled="templatesLoading"
                                        class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors disabled:opacity-50">
                                    <i class="fas fa-sync-alt" :class="templatesLoading ? 'fa-spin' : ''"></i>
                                </button>
                            </div>
                            <div x-show="templatesLoading" class="text-center py-6">
                                <i class="fas fa-spinner fa-spin text-xl text-zinc-500"></i>
                            </div>
                            <div x-show="!templatesLoading && templates.length > 0" class="space-y-2">
                                <template x-for="template in templates" :key="template.id">
                                    <div class="bg-zinc-900 rounded p-3 flex justify-between items-center">
                                        <div>
                                            <span class="font-medium" x-text="template.name"></span>
                                            <span class="text-xs text-zinc-500 ml-2" x-text="template.description"></span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button @click="applyTemplate(template.id)" :disabled="templatesLoading"
                                                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded text-xs">
                                                <i class="fas fa-play mr-1"></i>Apply
                                            </button>
                                            <button @click="deleteTemplate(template.id)" :disabled="templatesLoading"
                                                    class="px-2 py-1.5 bg-red-600 hover:bg-red-500 rounded text-xs">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div x-show="!templatesLoading && templates.length === 0" class="text-center py-6 text-zinc-500 text-sm">
                                No templates available
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== ALERTS TAB ==================== -->
                <div x-show="activeTab === 'alerts'">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Notifications -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400">
                                    <i class="fas fa-bell mr-2"></i>Recent Notifications
                                    <span x-show="unacknowledgedCount > 0" class="ml-2 px-2 py-0.5 bg-red-500 rounded-full text-xs" x-text="unacknowledgedCount"></span>
                                </h4>
                                <div class="flex gap-2">
                                    <button @click="clearNotifications()" :disabled="notificationsLoading || notifications.length === 0"
                                            class="px-3 py-1.5 bg-red-600 hover:bg-red-500 rounded text-xs transition-colors disabled:opacity-50">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button @click="loadNotifications()" :disabled="notificationsLoading"
                                            class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors disabled:opacity-50">
                                        <i class="fas fa-sync-alt" :class="notificationsLoading ? 'fa-spin' : ''"></i>
                                    </button>
                                </div>
                            </div>
                            <div x-show="notificationsLoading" class="text-center py-6">
                                <i class="fas fa-spinner fa-spin text-xl text-zinc-500"></i>
                            </div>
                            <div x-show="!notificationsLoading && notifications.length > 0" class="space-y-2 max-h-64 overflow-y-auto">
                                <template x-for="notif in notifications" :key="notif.id">
                                    <div class="bg-zinc-900 rounded p-3 flex justify-between items-start"
                                         :class="notif.acknowledged ? 'opacity-60' : 'border-l-2 border-orange-500'">
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <i class="fas" :class="{
                                                    'fa-exclamation-circle text-red-400': notif.severity === 'error',
                                                    'fa-exclamation-triangle text-yellow-400': notif.severity === 'warning',
                                                    'fa-info-circle text-blue-400': notif.severity === 'info'
                                                }"></i>
                                                <span class="text-sm" x-text="notif.message"></span>
                                            </div>
                                            <span class="text-xs text-zinc-500" x-text="notif.timestamp"></span>
                                        </div>
                                        <button x-show="!notif.acknowledged" @click="acknowledgeNotification(notif.id)"
                                                class="px-2 py-1 bg-zinc-700 hover:bg-zinc-600 rounded text-xs">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                </template>
                            </div>
                            <div x-show="!notificationsLoading && notifications.length === 0" class="text-center py-6 text-zinc-500 text-sm">
                                No notifications
                            </div>
                        </div>
                        
                        <!-- Alert Thresholds -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400">
                                    <i class="fas fa-tachometer-alt mr-2"></i>Alert Thresholds
                                </h4>
                                <button @click="loadThresholds()" :disabled="notificationsLoading"
                                        class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors disabled:opacity-50">
                                    <i class="fas fa-sync-alt" :class="notificationsLoading ? 'fa-spin' : ''"></i>
                                </button>
                            </div>
                            <template x-if="alertThresholds">
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs text-zinc-500 block mb-1">CPU Warning (%)</label>
                                    <input type="number" x-model.number="alertThresholds.cpuWarning" min="0" max="100"
                                           class="w-full h-9 bg-zinc-900 border border-zinc-700 rounded px-3 text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-zinc-500 block mb-1">CPU Critical (%)</label>
                                    <input type="number" x-model.number="alertThresholds.cpuCritical" min="0" max="100"
                                           class="w-full h-9 bg-zinc-900 border border-zinc-700 rounded px-3 text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-zinc-500 block mb-1">Memory Warning (%)</label>
                                    <input type="number" x-model.number="alertThresholds.memoryWarning" min="0" max="100"
                                           class="w-full h-9 bg-zinc-900 border border-zinc-700 rounded px-3 text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-zinc-500 block mb-1">Memory Critical (%)</label>
                                    <input type="number" x-model.number="alertThresholds.memoryCritical" min="0" max="100"
                                           class="w-full h-9 bg-zinc-900 border border-zinc-700 rounded px-3 text-sm">
                                </div>
                                <button @click="updateThresholds()" :disabled="notificationsLoading"
                                        class="w-full py-2 bg-orange-500 hover:bg-orange-600 rounded text-sm transition-colors disabled:opacity-50">
                                    <i class="fas fa-save mr-2"></i>Save Thresholds
                                </button>
                            </div>
                            </template>
                            <div x-show="!alertThresholds" class="text-center py-6 text-zinc-500 text-sm">
                                Loading thresholds...
                            </div>
                        </div>
                        
                        <!-- Webhooks -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800 lg:col-span-2">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400">
                                    <i class="fas fa-plug mr-2"></i>Webhooks
                                </h4>
                                <button @click="loadWebhooks()" :disabled="webhooksLoading"
                                        class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors disabled:opacity-50">
                                    <i class="fas fa-sync-alt" :class="webhooksLoading ? 'fa-spin' : ''"></i>
                                </button>
                            </div>
                            
                            <!-- Add Webhook Form -->
                            <div class="mb-4 p-3 bg-zinc-900 rounded">
                                <div class="flex gap-2 mb-2">
                                    <input type="text" x-model="newWebhookUrl" placeholder="https://example.com/webhook"
                                           class="flex-1 h-9 bg-zinc-800 border border-zinc-700 rounded px-3 text-sm focus:outline-none focus:border-zinc-600">
                                    <button @click="registerWebhook()" :disabled="webhooksLoading || !newWebhookUrl"
                                            class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-xs transition-colors disabled:opacity-50">
                                        <i class="fas fa-plus mr-1"></i>Add
                                    </button>
                                </div>
                                <div class="flex flex-wrap gap-2 text-xs">
                                    <label class="flex items-center gap-1 text-zinc-400">
                                        <input type="checkbox" value="server.start" x-model="newWebhookEvents"> Server Start
                                    </label>
                                    <label class="flex items-center gap-1 text-zinc-400">
                                        <input type="checkbox" value="server.stop" x-model="newWebhookEvents"> Server Stop
                                    </label>
                                    <label class="flex items-center gap-1 text-zinc-400">
                                        <input type="checkbox" value="match.start" x-model="newWebhookEvents"> Match Start
                                    </label>
                                    <label class="flex items-center gap-1 text-zinc-400">
                                        <input type="checkbox" value="match.end" x-model="newWebhookEvents"> Match End
                                    </label>
                                    <label class="flex items-center gap-1 text-zinc-400">
                                        <input type="checkbox" value="alert" x-model="newWebhookEvents"> Alerts
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Webhook List -->
                            <div x-show="webhooksLoading" class="text-center py-4">
                                <i class="fas fa-spinner fa-spin text-xl text-zinc-500"></i>
                            </div>
                            <div x-show="!webhooksLoading && webhooks.length > 0" class="space-y-2">
                                <template x-for="hook in webhooks" :key="hook.id">
                                    <div class="bg-zinc-900 rounded p-3 flex justify-between items-center">
                                        <div>
                                            <span class="font-mono text-sm text-blue-400 truncate block max-w-md" x-text="hook.url"></span>
                                            <span class="text-xs text-zinc-500" x-text="(hook.events || []).join(', ')"></span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button @click="testWebhook(hook.id)" :disabled="webhooksLoading"
                                                    class="px-2 py-1.5 bg-blue-600 hover:bg-blue-500 rounded text-xs">
                                                <i class="fas fa-bolt"></i> Test
                                            </button>
                                            <button @click="deleteWebhook(hook.id)" :disabled="webhooksLoading"
                                                    class="px-2 py-1.5 bg-red-600 hover:bg-red-500 rounded text-xs">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div x-show="!webhooksLoading && webhooks.length === 0" class="text-center py-4 text-zinc-500 text-sm">
                                No webhooks configured
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== CHARTS TAB ==================== -->
                <div x-show="activeTab === 'charts'">
                    <div class="space-y-4">
                        <!-- Chart Controls -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-zinc-400">Time Range:</span>
                                <select x-model.number="chartDays" @change="loadCharts()"
                                        class="h-9 bg-zinc-800 border border-zinc-700 rounded px-3 text-sm">
                                    <option value="7">Last 7 Days</option>
                                    <option value="14">Last 14 Days</option>
                                    <option value="30">Last 30 Days</option>
                                </select>
                            </div>
                            <button @click="loadCharts()" :disabled="chartsLoading"
                                    class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors disabled:opacity-50">
                                <i class="fas fa-sync-alt" :class="chartsLoading ? 'fa-spin' : ''"></i>
                                <span class="ml-1">Refresh</span>
                            </button>
                        </div>
                        
                        <!-- Uptime Chart -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <h4 class="text-sm font-medium text-zinc-400 mb-4">
                                <i class="fas fa-clock mr-2"></i>Server Uptime
                            </h4>
                            <div x-show="chartsLoading" class="text-center py-8">
                                <i class="fas fa-spinner fa-spin text-2xl text-zinc-500"></i>
                            </div>
                            <div x-show="!chartsLoading && chartsData.uptime.length > 0" class="h-48">
                                <div class="flex items-end h-40 gap-1">
                                    <template x-for="(point, i) in chartsData.uptime" :key="i">
                                        <div class="flex-1 flex flex-col items-center">
                                            <div class="w-full bg-green-500/80 rounded-t transition-all"
                                                 :style="`height: ${point.value}%`"
                                                 :title="`${point.date}: ${point.value}%`"></div>
                                        </div>
                                    </template>
                                </div>
                                <div class="flex justify-between text-xs text-zinc-500 mt-2">
                                    <span x-text="chartsData.uptime[0]?.date || ''"></span>
                                    <span x-text="chartsData.uptime[chartsData.uptime.length - 1]?.date || ''"></span>
                                </div>
                            </div>
                            <div x-show="!chartsLoading && chartsData.uptime.length === 0" class="text-center py-8 text-zinc-500 text-sm">
                                No uptime data available
                            </div>
                        </div>
                        
                        <!-- Players Chart -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <h4 class="text-sm font-medium text-zinc-400 mb-4">
                                <i class="fas fa-users mr-2"></i>Players Over Time
                            </h4>
                            <div x-show="chartsLoading" class="text-center py-8">
                                <i class="fas fa-spinner fa-spin text-2xl text-zinc-500"></i>
                            </div>
                            <div x-show="!chartsLoading && chartsData.players.length > 0" class="h-48">
                                <div class="flex items-end h-40 gap-1">
                                    <template x-for="(point, i) in chartsData.players" :key="i">
                                        <div class="flex-1 flex flex-col items-center">
                                            <div class="w-full bg-blue-500/80 rounded-t transition-all"
                                                 :style="`height: ${Math.min((point.value / Math.max(...chartsData.players.map(p => p.value), 1)) * 100, 100)}%`"
                                                 :title="`${point.date}: ${point.value} players`"></div>
                                        </div>
                                    </template>
                                </div>
                                <div class="flex justify-between text-xs text-zinc-500 mt-2">
                                    <span x-text="chartsData.players[0]?.date || ''"></span>
                                    <span x-text="chartsData.players[chartsData.players.length - 1]?.date || ''"></span>
                                </div>
                            </div>
                            <div x-show="!chartsLoading && chartsData.players.length === 0" class="text-center py-8 text-zinc-500 text-sm">
                                No player data available
                            </div>
                        </div>
                        
                        <!-- Matches Chart -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <h4 class="text-sm font-medium text-zinc-400 mb-4">
                                <i class="fas fa-gamepad mr-2"></i>Matches Per Day
                            </h4>
                            <div x-show="chartsLoading" class="text-center py-8">
                                <i class="fas fa-spinner fa-spin text-2xl text-zinc-500"></i>
                            </div>
                            <div x-show="!chartsLoading && chartsData.matches.length > 0" class="h-48">
                                <div class="flex items-end h-40 gap-1">
                                    <template x-for="(point, i) in chartsData.matches" :key="i">
                                        <div class="flex-1 flex flex-col items-center">
                                            <div class="w-full bg-orange-500/80 rounded-t transition-all"
                                                 :style="`height: ${Math.min((point.value / Math.max(...chartsData.matches.map(p => p.value), 1)) * 100, 100)}%`"
                                                 :title="`${point.date}: ${point.value} matches`"></div>
                                        </div>
                                    </template>
                                </div>
                                <div class="flex justify-between text-xs text-zinc-500 mt-2">
                                    <span x-text="chartsData.matches[0]?.date || ''"></span>
                                    <span x-text="chartsData.matches[chartsData.matches.length - 1]?.date || ''"></span>
                                </div>
                            </div>
                            <div x-show="!chartsLoading && chartsData.matches.length === 0" class="text-center py-8 text-zinc-500 text-sm">
                                No match data available
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== REPLAYS TAB ==================== -->
                <div x-show="activeTab === 'replays'">
                    <!-- Replay Stats -->
                    <div class="bg-zinc-800/50 rounded-lg p-4 mb-4 border border-zinc-800">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-medium text-zinc-400">
                                <i class="fas fa-film mr-2"></i>Game Replays
                            </h4>
                            <div class="flex gap-2">
                                <button @click="archiveReplays()" :disabled="replaysLoading"
                                        class="px-3 py-1.5 bg-amber-600 hover:bg-amber-500 rounded text-xs transition-colors disabled:opacity-50"
                                        title="Archive replays older than 30 days">
                                    <i class="fas fa-archive"></i>
                                    <span class="ml-1">Archive</span>
                                </button>
                                <button @click="cleanupReplays()" :disabled="replaysLoading"
                                        class="px-3 py-1.5 bg-red-600 hover:bg-red-500 rounded text-xs transition-colors disabled:opacity-50"
                                        title="Delete archived replays older than 90 days">
                                    <i class="fas fa-broom"></i>
                                    <span class="ml-1">Cleanup</span>
                                </button>
                                <button @click="loadReplays()" :disabled="replaysLoading"
                                        class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors disabled:opacity-50">
                                    <i class="fas fa-sync-alt" :class="replaysLoading ? 'fa-spin' : ''"></i>
                                    <span class="ml-1">Refresh</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Stats Summary -->
                        <div class="grid grid-cols-3 gap-4 mb-4" x-show="replayStats">
                            <div class="bg-zinc-900 rounded p-3 text-center">
                                <div class="text-xl font-bold text-orange-400" x-text="replayStats?.totalReplays || 0"></div>
                                <div class="text-xs text-zinc-500">Total Replays</div>
                            </div>
                            <div class="bg-zinc-900 rounded p-3 text-center">
                                <div class="text-xl font-bold text-blue-400" x-text="replayStats?.totalSizeFormatted || '0 B'"></div>
                                <div class="text-xs text-zinc-500">Total Size</div>
                            </div>
                            <div class="bg-zinc-900 rounded p-3 text-center">
                                <div class="text-xl font-bold text-green-400" x-text="replayStats?.archivedReplays || 0"></div>
                                <div class="text-xs text-zinc-500">Archived</div>
                            </div>
                        </div>
                        
                        <!-- Loading State -->
                        <div x-show="replaysLoading" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-2xl text-zinc-500"></i>
                            <p class="text-zinc-500 mt-2">Loading replays...</p>
                        </div>
                        
                        <!-- Empty State -->
                        <div x-show="!replaysLoading && replays.length === 0" class="text-center py-8">
                            <i class="fas fa-film text-4xl text-zinc-700"></i>
                            <p class="text-zinc-500 mt-2">No replays found</p>
                        </div>
                        
                        <!-- Replays Table -->
                        <div x-show="!replaysLoading && replays.length > 0" class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-left text-zinc-500 border-b border-zinc-700">
                                        <th class="pb-2 font-medium">Match ID</th>
                                        <th class="pb-2 font-medium">Date</th>
                                        <th class="pb-2 font-medium">Size</th>
                                        <th class="pb-2 font-medium text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="replay in replays" :key="replay.filename">
                                        <tr class="border-b border-zinc-800 hover:bg-zinc-800/50">
                                            <td class="py-2">
                                                <span class="text-orange-400 font-mono" x-text="replay.matchId"></span>
                                            </td>
                                            <td class="py-2 text-zinc-400" x-text="replay.date"></td>
                                            <td class="py-2 text-zinc-400" x-text="replay.size"></td>
                                            <td class="py-2 text-right">
                                                <button @click="downloadReplay(replay.filename)"
                                                        class="px-2 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs mr-1">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <button @click="deleteReplay(replay.filename)"
                                                        class="px-2 py-1 bg-red-600 hover:bg-red-500 rounded text-xs">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- ==================== CONFIGURATION TAB ==================== -->
                <div x-show="activeTab === 'config'">
                    <!-- Server Settings -->
                    <div class="bg-zinc-800/50 rounded-lg p-4 mb-4 border border-zinc-800">
                        <h4 class="text-sm font-medium mb-4 text-zinc-400">Server Settings</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <!-- Name -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Name</label>
                                <input type="text" x-model="serverConfig.svr_name" 
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:border-zinc-600 focus:outline-none">
                            </div>
                            
                            <!-- Location -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Location</label>
                                <input type="text" x-model="serverConfig.svr_location" 
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Priority -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Priority</label>
                                <select x-model="serverConfig.svr_priority" 
                                        class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                                    <option value="LOW">LOW</option>
                                    <option value="MEDIUM">MEDIUM</option>
                                    <option value="HIGH">HIGH</option>
                                </select>
                            </div>
                            
                            <!-- Total -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Total</label>
                                <input type="number" x-model="serverConfig.svr_total" min="0" max="20"
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Servers Per Core -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Per CPU</label>
                                <select x-model="serverConfig.svr_total_per_core" 
                                        class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                                    <option value="0.5">0.5</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </div>
                            
                            <!-- Enable Bot Match -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Bot Match</label>
                                <button :class="serverConfig.svr_enableBotMatch ? 'bg-green-600' : 'bg-zinc-800'" 
                                     class="w-full h-8 rounded px-2 text-sm flex items-center justify-between border border-zinc-700 transition-colors"
                                     @click="serverConfig.svr_enableBotMatch = !serverConfig.svr_enableBotMatch">
                                    <span x-text="serverConfig.svr_enableBotMatch ? 'On' : 'Off'"></span>
                                    <span class="w-2 h-2 rounded-full" :class="serverConfig.svr_enableBotMatch ? 'bg-white' : 'bg-zinc-600'"></span>
                                </button>
                            </div>
                            
                            <!-- Start On Launch -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Auto Start</label>
                                <button :class="serverConfig.svr_start_on_launch ? 'bg-green-600' : 'bg-zinc-800'" 
                                     class="w-full h-8 rounded px-2 text-sm flex items-center justify-between border border-zinc-700 transition-colors"
                                     @click="serverConfig.svr_start_on_launch = !serverConfig.svr_start_on_launch">
                                    <span x-text="serverConfig.svr_start_on_launch ? 'On' : 'Off'"></span>
                                    <span class="w-2 h-2 rounded-full" :class="serverConfig.svr_start_on_launch ? 'bg-white' : 'bg-zinc-600'"></span>
                                </button>
                            </div>
                            
                            <!-- No Console -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">No Console</label>
                                <button :class="serverConfig.svr_noConsole ? 'bg-green-600' : 'bg-zinc-800'" 
                                     class="w-full h-8 rounded px-2 text-sm flex items-center justify-between border border-zinc-700 transition-colors"
                                     @click="serverConfig.svr_noConsole = !serverConfig.svr_noConsole">
                                    <span x-text="serverConfig.svr_noConsole ? 'On' : 'Off'"></span>
                                    <span class="w-2 h-2 rounded-full" :class="serverConfig.svr_noConsole ? 'bg-white' : 'bg-zinc-600'"></span>
                                </button>
                            </div>
                            
                            <!-- Max Start At Once -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Max Start</label>
                                <input type="number" x-model="serverConfig.svr_max_start_at_once" min="1" max="10"
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Startup Timeout -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Timeout</label>
                                <input type="number" x-model="serverConfig.svr_startup_timeout" min="30" max="600"
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Restart Between Games -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Restart Games</label>
                                <button :class="serverConfig.svr_restart_between_games ? 'bg-green-600' : 'bg-zinc-800'" 
                                     class="w-full h-8 rounded px-2 text-sm flex items-center justify-between border border-zinc-700 transition-colors"
                                     @click="serverConfig.svr_restart_between_games = !serverConfig.svr_restart_between_games">
                                    <span x-text="serverConfig.svr_restart_between_games ? 'On' : 'Off'"></span>
                                    <span class="w-2 h-2 rounded-full" :class="serverConfig.svr_restart_between_games ? 'bg-white' : 'bg-zinc-600'"></span>
                                </button>
                            </div>
                            
                            <!-- Master Server -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Master Server</label>
                                <input type="text" x-model="serverConfig.svr_masterServer" 
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Host Login -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Host Login</label>
                                <input type="text" x-model="serverConfig.svr_login" 
                                       placeholder="Your HoN login"
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Host Password -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Host Password</label>
                                <input type="password" x-model="serverConfig.svr_password" 
                                       placeholder="Your HoN password"
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Chat Server -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Chat Server</label>
                                <input type="text" x-model="serverConfig.svr_chatServer" 
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Patch Server -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Patch Server</label>
                                <input type="text" x-model="serverConfig.svr_patchServer" 
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Starting Game Port -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Game Port</label>
                                <input type="number" x-model="serverConfig.svr_starting_gamePort" 
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Starting Voice Port -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Voice Port</label>
                                <input type="number" x-model="serverConfig.svr_starting_voicePort" disabled
                                       class="w-full h-8 bg-zinc-950 border border-zinc-800 rounded px-2 text-sm text-zinc-600">
                            </div>
                            
                            <!-- Api Port -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">API Port</label>
                                <input type="number" x-model="serverConfig.svr_api_port" 
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Max Clients -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Max Clients</label>
                                <input type="number" x-model="serverConfig.svr_maxClients" min="1" max="20"
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Manager Port -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Manager Port</label>
                                <input type="number" x-model="serverConfig.svr_managerPort" disabled
                                       class="w-full h-8 bg-zinc-950 border border-zinc-800 rounded px-2 text-sm text-zinc-600">
                            </div>
                            
                            <!-- Beta Mode -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Beta Mode</label>
                                <input type="text" :value="serverConfig.svr_beta_mode ? 'true' : 'false'" disabled
                                       class="w-full h-8 bg-zinc-950 border border-zinc-800 rounded px-2 text-sm text-zinc-600">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Manager Settings -->
                    <div class="bg-zinc-800/50 rounded-lg p-4 mb-4 border border-zinc-800">
                        <h4 class="text-sm font-medium mb-3 text-zinc-400">Manager Settings</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- Enable Proxy -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Proxy</label>
                                <button :class="serverConfig.man_enableProxy ? 'bg-green-600' : 'bg-zinc-800'" 
                                     class="w-full h-8 rounded px-2 text-sm flex items-center justify-between border border-zinc-700 transition-colors"
                                     @click="serverConfig.man_enableProxy = !serverConfig.man_enableProxy">
                                    <span x-text="serverConfig.man_enableProxy ? 'On' : 'Off'"></span>
                                    <span class="w-2 h-2 rounded-full" :class="serverConfig.man_enableProxy ? 'bg-white' : 'bg-zinc-600'"></span>
                                </button>
                            </div>
                            
                            <!-- Use Cowmaster -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Cowmaster</label>
                                <button :class="serverConfig.man_use_cowmaster ? 'bg-green-600' : 'bg-zinc-800'" 
                                     class="w-full h-8 rounded px-2 text-sm flex items-center justify-between border border-zinc-700 transition-colors"
                                     @click="serverConfig.man_use_cowmaster = !serverConfig.man_use_cowmaster">
                                    <span x-text="serverConfig.man_use_cowmaster ? 'On' : 'Off'"></span>
                                    <span class="w-2 h-2 rounded-full" :class="serverConfig.man_use_cowmaster ? 'bg-white' : 'bg-zinc-600'"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Other Settings -->
                    <div class="bg-zinc-800/50 rounded-lg p-4 mb-4 border border-zinc-800">
                        <h4 class="text-sm font-medium mb-3 text-zinc-400">Directories</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- Hon Install Directory -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Install Directory</label>
                                <input type="text" x-model="serverConfig.hon_install_directory" 
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Hon Home Directory -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Home Directory</label>
                                <input type="text" x-model="serverConfig.hon_home_directory" 
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Discord Bot Settings -->
                    <div class="bg-zinc-800/50 rounded-lg p-4 mb-4 border border-zinc-800">
                        <h4 class="text-sm font-medium mb-3 text-zinc-400">
                            <i class="fab fa-discord mr-2 text-indigo-400"></i>Discord Bot
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- Bot Token -->
                            <div class="md:col-span-2">
                                <label class="block text-xs text-zinc-500 mb-1">Bot Token</label>
                                <input type="password" x-model="serverConfig.discord_bot_token" 
                                       placeholder="Enter your Discord bot token"
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Owner ID -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Owner Discord ID</label>
                                <input type="text" x-model="serverConfig.discord_owner_id" 
                                       placeholder="Your Discord User ID"
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Notification Channel ID -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Notification Channel ID</label>
                                <input type="text" x-model="serverConfig.discord_notification_channel_id" 
                                       placeholder="Discord Channel ID for notifications"
                                       class="w-full h-8 bg-zinc-900 border border-zinc-700 rounded px-2 text-sm focus:outline-none">
                            </div>
                            
                            <!-- Enable Notifications -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Notifications</label>
                                <button :class="serverConfig.discord_enable_notifications ? 'bg-green-600' : 'bg-zinc-800'" 
                                     class="w-full h-8 rounded px-2 text-sm flex items-center justify-between border border-zinc-700 transition-colors"
                                     @click="serverConfig.discord_enable_notifications = !serverConfig.discord_enable_notifications">
                                    <span x-text="serverConfig.discord_enable_notifications ? 'On' : 'Off'"></span>
                                    <span class="w-2 h-2 rounded-full" :class="serverConfig.discord_enable_notifications ? 'bg-white' : 'bg-zinc-600'"></span>
                                </button>
                            </div>
                            
                            <!-- Notify Match Start -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Match Start</label>
                                <button :class="serverConfig.discord_notify_match_start ? 'bg-green-600' : 'bg-zinc-800'" 
                                     class="w-full h-8 rounded px-2 text-sm flex items-center justify-between border border-zinc-700 transition-colors"
                                     @click="serverConfig.discord_notify_match_start = !serverConfig.discord_notify_match_start">
                                    <span x-text="serverConfig.discord_notify_match_start ? 'On' : 'Off'"></span>
                                    <span class="w-2 h-2 rounded-full" :class="serverConfig.discord_notify_match_start ? 'bg-white' : 'bg-zinc-600'"></span>
                                </button>
                            </div>
                            
                            <!-- Notify Match End -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Match End</label>
                                <button :class="serverConfig.discord_notify_match_end ? 'bg-green-600' : 'bg-zinc-800'" 
                                     class="w-full h-8 rounded px-2 text-sm flex items-center justify-between border border-zinc-700 transition-colors"
                                     @click="serverConfig.discord_notify_match_end = !serverConfig.discord_notify_match_end">
                                    <span x-text="serverConfig.discord_notify_match_end ? 'On' : 'Off'"></span>
                                    <span class="w-2 h-2 rounded-full" :class="serverConfig.discord_notify_match_end ? 'bg-white' : 'bg-zinc-600'"></span>
                                </button>
                            </div>
                            
                            <!-- Notify Player Join/Leave -->
                            <div>
                                <label class="block text-xs text-zinc-500 mb-1">Player Join/Leave</label>
                                <button :class="serverConfig.discord_notify_player_join_leave ? 'bg-green-600' : 'bg-zinc-800'" 
                                     class="w-full h-8 rounded px-2 text-sm flex items-center justify-between border border-zinc-700 transition-colors"
                                     @click="serverConfig.discord_notify_player_join_leave = !serverConfig.discord_notify_player_join_leave">
                                    <span x-text="serverConfig.discord_notify_player_join_leave ? 'On' : 'Off'"></span>
                                    <span class="w-2 h-2 rounded-full" :class="serverConfig.discord_notify_player_join_leave ? 'bg-white' : 'bg-zinc-600'"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="flex gap-2">
                        <button @click="loadServerConfig()" :disabled="controlLoading"
                                class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition-colors disabled:opacity-50">Reset</button>
                        <button @click="saveFullConfig()" :disabled="controlLoading"
                                class="flex-1 px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded text-sm font-medium transition-colors disabled:opacity-50">Save Config</button>
                    </div>
                </div>
                
                <!-- ==================== ACTIONS TAB ==================== -->
                <div x-show="activeTab === 'actions'">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Server Control -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <h4 class="text-sm font-medium mb-3 text-zinc-400">Server Control</h4>
                            <div class="space-y-2">
                                <button @click="startAllInstances()" :disabled="controlLoading"
                                        class="w-full px-3 py-2 bg-zinc-700 hover:bg-green-600 rounded text-sm transition-colors disabled:opacity-50">
                                    <i class="fas fa-play mr-2"></i>Start All
                                </button>
                                <button @click="stopAllInstances()" :disabled="controlLoading"
                                        class="w-full px-3 py-2 bg-zinc-700 hover:bg-red-600 rounded text-sm transition-colors disabled:opacity-50">
                                    <i class="fas fa-stop mr-2"></i>Stop All
                                </button>
                                <button @click="restartAllInstances()" :disabled="controlLoading"
                                        class="w-full px-3 py-2 bg-zinc-700 hover:bg-orange-600 rounded text-sm transition-colors disabled:opacity-50">
                                    <i class="fas fa-sync-alt mr-2"></i>Restart All
                                </button>
                            </div>
                        </div>
                        
                        <!-- Instance Management -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <h4 class="text-sm font-medium mb-3 text-zinc-400">Instances</h4>
                            <div class="space-y-2">
                                <button @click="showAddInstanceModal = true" :disabled="controlLoading"
                                        class="w-full px-3 py-2 bg-zinc-700 hover:bg-zinc-600 rounded text-sm transition-colors disabled:opacity-50">
                                    <i class="fas fa-plus mr-2"></i>Add Instance
                                </button>
                                <button @click="addAllInstances()" :disabled="controlLoading"
                                        class="w-full px-3 py-2 bg-zinc-700 hover:bg-green-600 rounded text-sm transition-colors disabled:opacity-50">
                                    <i class="fas fa-server mr-2"></i>Add All
                                </button>
                                <button @click="deleteAllInstances()" :disabled="controlLoading"
                                        class="w-full px-3 py-2 bg-zinc-700 hover:bg-red-600 rounded text-sm transition-colors disabled:opacity-50">
                                    <i class="fas fa-trash mr-2"></i>Delete All
                                </button>
                            </div>
                        </div>
                        
                        <!-- Communication -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <h4 class="text-sm font-medium mb-3 text-zinc-400">Broadcast</h4>
                            <div class="space-y-2">
                                <textarea x-model="broadcastMessage" rows="2"
                                          class="w-full bg-zinc-900 border border-zinc-700 rounded px-2 py-1.5 text-sm focus:outline-none"
                                          placeholder="Message..."></textarea>
                                <button @click="sendBroadcast()" :disabled="!broadcastMessage || controlLoading"
                                        class="w-full px-3 py-2 bg-zinc-700 hover:bg-purple-600 rounded text-sm transition-colors disabled:opacity-50">
                                    <i class="fas fa-paper-plane mr-2"></i>Send
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Scale -->
                        <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                            <h4 class="text-sm font-medium mb-3 text-zinc-400">Quick Scale</h4>
                            <div class="grid grid-cols-5 gap-1">
                                <template x-for="n in [0, 1, 2, 4, 8]" :key="n">
                                    <button @click="targetServers = n; applyScale()"
                                            :class="targetServers === n ? 'bg-orange-500' : 'bg-zinc-700 hover:bg-zinc-600'"
                                            class="py-2 rounded text-sm font-medium transition-colors"
                                            x-text="n"></button>
                                </template>
                            </div>
                            <p class="text-xs text-zinc-500 mt-2 text-center">Click to scale</p>
                        </div>
                    </div>
                </div>
                
                <!-- ==================== ACCESS TAB ==================== -->
                <div x-show="activeTab === 'access'">
                    <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm text-zinc-400">Shared Access</span>
                            <button @click="showAddAccessModal = true"
                                    class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors">
                                <i class="fas fa-plus mr-1"></i>Add User
                            </button>
                        </div>

                        <div x-show="accessLoading" class="text-center py-6 text-zinc-500">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>

                        <div x-show="!accessLoading && serverAccessList.length === 0" class="text-center py-6 text-zinc-500 text-sm">
                            No users have access yet
                        </div>

                        <div x-show="!accessLoading && serverAccessList.length > 0" class="space-y-2">
                            <template x-for="access in serverAccessList" :key="access.id">
                                <div class="bg-zinc-900 rounded p-3 flex items-center justify-between border border-zinc-800">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center overflow-hidden">
                                            <img x-show="access.avatar_url || access.avatarUrl" :src="access.avatar_url || access.avatarUrl" class="w-full h-full object-cover">
                                            <i x-show="!access.avatar_url && !access.avatarUrl" class="fas fa-user text-zinc-600 text-xs"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm">
                                                <span x-show="access.username" x-text="access.username"></span>
                                                <span x-show="!access.username" class="text-zinc-500">Unknown</span>
                                            </div>
                                            <div class="text-xs text-zinc-500" x-text="access.discord_id || access.discordId"></div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <select x-model="access.role" @change="updateAccessRole(access)"
                                                class="bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-xs">
                                            <option value="0">Viewer</option>
                                            <option value="1">Operator</option>
                                            <option value="2">Admin</option>
                                            <option value="3">Owner</option>
                                        </select>
                                        <button @click="removeAccess(access)" 
                                                class="text-zinc-500 hover:text-red-400 transition-colors text-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="mt-4 pt-4 border-t border-zinc-800 text-xs text-zinc-500 space-y-1">
                            <div><span class="text-zinc-400">Viewer:</span> View status</div>
                            <div><span class="text-zinc-400">Operator:</span> Start/stop instances</div>
                            <div><span class="text-zinc-400">Admin:</span> Full control + config</div>
                            <div><span class="text-zinc-400">Owner:</span> Full ownership</div>
                        </div>
                    </div>
                </div>

                <!-- ==================== CONSOLE TAB ==================== -->
                <div x-show="activeTab === 'console'">
                    <div class="bg-zinc-900 rounded-lg border border-zinc-800 flex flex-col h-[600px]">
                        <!-- Console Header -->
                        <div class="px-4 py-2 border-b border-zinc-800 bg-zinc-800/50 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-terminal text-green-400"></i>
                                <span class="text-sm font-medium">Server Console</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button @click="showConsoleHelp = !showConsoleHelp" 
                                        class="px-2 py-1 text-xs bg-zinc-700 hover:bg-zinc-600 rounded transition-colors">
                                    <i class="fas fa-question-circle mr-1"></i>Help
                                </button>
                                <button @click="clearConsole()" 
                                        class="px-2 py-1 text-xs bg-zinc-700 hover:bg-zinc-600 rounded transition-colors">
                                    <i class="fas fa-trash mr-1"></i>Clear
                                </button>
                            </div>
                        </div>
                        
                        <!-- Help Panel -->
                        <div x-show="showConsoleHelp" x-cloak class="px-4 py-3 border-b border-zinc-800 bg-zinc-800/30 text-xs">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div>
                                    <div class="text-orange-400 font-medium mb-1">Instance Control</div>
                                    <div class="text-zinc-400 space-y-0.5">
                                        <div><code class="text-green-400">start [id]</code> - Start instance</div>
                                        <div><code class="text-green-400">stop [id]</code> - Stop instance</div>
                                        <div><code class="text-green-400">restart [id]</code> - Restart instance</div>
                                        <div><code class="text-green-400">startall</code> - Start all</div>
                                        <div><code class="text-green-400">stopall</code> - Stop all</div>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-orange-400 font-medium mb-1">Sleep Mode</div>
                                    <div class="text-zinc-400 space-y-0.5">
                                        <div><code class="text-blue-400">sleep [id]</code> - Sleep (kick+stop)</div>
                                        <div><code class="text-yellow-400">wake [id]</code> - Wake (start)</div>
                                        <div><code class="text-blue-400">sleeping</code> - List sleeping</div>
                                        <div><code class="text-red-400">reset [id]</code> - Kick players only</div>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-orange-400 font-medium mb-1">Information</div>
                                    <div class="text-zinc-400 space-y-0.5">
                                        <div><code class="text-green-400">status</code> - Show all status</div>
                                        <div><code class="text-green-400">status [id]</code> - Instance status</div>
                                        <div><code class="text-green-400">list</code> - List instances</div>
                                        <div><code class="text-green-400">info</code> - Server info</div>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-orange-400 font-medium mb-1">Other</div>
                                    <div class="text-zinc-400 space-y-0.5">
                                        <div><code class="text-green-400">say [msg]</code> - Broadcast to all</div>
                                        <div><code class="text-green-400">help</code> - Show this help</div>
                                        <div><code class="text-green-400">clear</code> - Clear console</div>
                                        <div><code class="text-green-400">refresh</code> - Refresh data</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Console Output -->
                        <div class="flex-1 p-4 overflow-y-auto font-mono text-xs space-y-1" id="console-output">
                            <template x-for="log in consoleLogs" :key="log.id || log.timestamp">
                                <div :class="{
                                    'text-zinc-300': log.type === 'output',
                                    'text-green-400': log.type === 'success',
                                    'text-red-400': log.type === 'error',
                                    'text-yellow-400': log.type === 'warning',
                                    'text-cyan-400': log.type === 'info',
                                    'text-zinc-500': log.type === 'command'
                                }">
                                    <span class="text-zinc-600" x-text="log.time || new Date(log.timestamp).toLocaleTimeString()"></span>
                                    <span x-show="log.type === 'command'" class="text-orange-400">$</span>
                                    <span x-html="log.message"></span>
                                </div>
                            </template>
                            <div x-show="consoleLogs.length === 0" class="text-zinc-500 text-center py-8">
                                <i class="fas fa-terminal text-2xl mb-2"></i>
                                <p>Type <code class="text-green-400">help</code> to see available commands</p>
                            </div>
                        </div>
                        
                        <!-- Console Input -->
                        <div class="p-2 border-t border-zinc-800 bg-zinc-800/50">
                            <form @submit.prevent="executeConsoleCommand()" class="flex gap-2">
                                <span class="flex items-center text-green-400 font-mono text-sm px-2">$</span>
                                <input type="text" x-model="consoleCommand" 
                                       @keyup.up="navigateCommandHistory(-1)"
                                       @keyup.down="navigateCommandHistory(1)"
                                       placeholder="Enter command (e.g., start 1, stop 2, status, help)..." 
                                       class="flex-1 bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm font-mono focus:border-orange-500 focus:outline-none"
                                       autocomplete="off">
                                <button type="submit" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded text-sm font-medium transition-colors">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- ==================== FILEBEAT TAB ==================== -->
                <div x-show="activeTab === 'filebeat'">
                    <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                        <div class="flex items-center justify-between mb-6">
                            <h4 class="text-sm font-medium text-zinc-400">Filebeat Status</h4>
                            <div class="flex items-center gap-2">
                                <span class="w-2.5 h-2.5 rounded-full" :class="filebeatStatus?.isRunning ? 'bg-green-400' : 'bg-red-400'"></span>
                                <span class="text-sm font-medium" x-text="filebeatStatus?.isRunning ? 'Running' : 'Stopped'"></span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="bg-zinc-900 rounded p-4 border border-zinc-800">
                                    <div class="text-xs text-zinc-500 mb-1">Installed</div>
                                    <div class="text-lg font-medium" x-text="filebeatStatus?.isInstalled ? 'Yes' : 'No'"></div>
                                </div>
                                <div class="bg-zinc-900 rounded p-4 border border-zinc-800">
                                    <div class="text-xs text-zinc-500 mb-1">Version</div>
                                    <div class="text-lg font-medium" x-text="filebeatStatus?.version || '-'"></div>
                                </div>
                            </div>

                            <div class="space-y-2">
                                <button @click="controlFilebeat('start')" :disabled="!filebeatStatus?.isInstalled || filebeatStatus?.isRunning"
                                        class="w-full py-2 bg-green-600 hover:bg-green-500 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm font-medium transition-colors">
                                    Start Service
                                </button>
                                <button @click="controlFilebeat('stop')" :disabled="!filebeatStatus?.isRunning"
                                        class="w-full py-2 bg-red-600 hover:bg-red-500 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm font-medium transition-colors">
                                    Stop Service
                                </button>
                                <button @click="controlFilebeat('restart')" :disabled="!filebeatStatus?.isRunning"
                                        class="w-full py-2 bg-orange-600 hover:bg-orange-500 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm font-medium transition-colors">
                                    Restart Service
                                </button>
                                <button @click="installFilebeat()" :disabled="filebeatStatus?.isInstalled"
                                        class="w-full py-2 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm font-medium transition-colors">
                                    Install Filebeat
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== GIT TAB ==================== -->
                <div x-show="activeTab === 'git'">
                    <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                        <div class="flex items-center justify-between mb-6">
                            <h4 class="text-sm font-medium text-zinc-400">Git Repository</h4>
                            <div class="text-sm text-zinc-500">
                                Current Branch: <span class="text-white font-medium" x-text="gitStatus?.currentBranch"></span>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="bg-zinc-900 rounded p-4 border border-zinc-800 font-mono text-xs whitespace-pre-wrap" 
                                 x-text="gitStatus?.lastCommit || 'No commit info'"></div>

                            <div class="flex gap-2">
                                <select x-model="selectedBranch" class="flex-1 bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm">
                                    <template x-for="branch in gitStatus?.branches" :key="branch">
                                        <option :value="branch" x-text="branch"></option>
                                    </template>
                                </select>
                                <button @click="checkoutBranch()" class="px-4 py-2 bg-zinc-700 hover:bg-zinc-600 rounded text-sm font-medium transition-colors">
                                    Checkout
                                </button>
                            </div>

                            <div class="flex gap-2">
                                <button @click="gitPull()" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm font-medium transition-colors">
                                    <i class="fas fa-download mr-2"></i> Pull Latest
                                </button>
                                <button @click="gitReset()" class="flex-1 py-2 bg-red-600 hover:bg-red-500 rounded text-sm font-medium transition-colors">
                                    <i class="fas fa-undo mr-2"></i> Hard Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== BACKUPS TAB ==================== -->
                <div x-show="activeTab === 'backups'">
                    <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-medium text-zinc-400">System Backups</h4>
                            <button @click="createBackup()" class="px-3 py-1.5 bg-green-600 hover:bg-green-500 rounded text-xs transition-colors">
                                <i class="fas fa-plus mr-1"></i> Create Backup
                            </button>
                        </div>

                        <div class="space-y-2">
                            <template x-for="backup in backupsList" :key="backup.name">
                                <div class="bg-zinc-900 rounded p-3 flex items-center justify-between border border-zinc-800">
                                    <div>
                                        <div class="text-sm font-medium text-white" x-text="backup.name"></div>
                                        <div class="text-xs text-zinc-500" x-text="formatBytes(backup.size) + ' â€¢ ' + new Date(backup.created).toLocaleString()"></div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="restoreBackup(backup.name)" class="text-zinc-500 hover:text-blue-400 transition-colors" title="Restore">
                                            <i class="fas fa-history"></i>
                                        </button>
                                        <button @click="deleteBackup(backup.name)" class="text-zinc-500 hover:text-red-400 transition-colors" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                            <div x-show="!backupsList.length" class="text-center py-8 text-zinc-500 text-sm">
                                No backups found
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== RBAC TAB ==================== -->
                <div x-show="activeTab === 'rbac'">
                    <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-800">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-medium text-zinc-400">Role Management</h4>
                            <button @click="showAddRoleModal = true" class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-xs transition-colors">
                                <i class="fas fa-plus mr-1"></i> Add Role
                            </button>
                        </div>

                        <div class="space-y-2">
                            <template x-for="role in rolesList" :key="role.id">
                                <div class="bg-zinc-900 rounded p-3 border border-zinc-800">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="font-medium text-white" x-text="role.name"></div>
                                        <div class="flex gap-2">
                                            <button @click="editRole(role)" class="text-zinc-500 hover:text-blue-400 transition-colors">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button @click="deleteRole(role.id)" class="text-zinc-500 hover:text-red-400 transition-colors">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-1">
                                        <template x-for="perm in role.permissions" :key="perm">
                                            <span class="px-1.5 py-0.5 bg-zinc-800 rounded text-[10px] text-zinc-400" x-text="perm"></span>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-zinc-800">
                <button @click="showDetailsModal = false; stopAutoRefresh()" class="w-full px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Add Access Modal -->
    <div x-show="showAddAccessModal" x-cloak
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4"
         @click.self="showAddAccessModal = false">
        <div class="bg-zinc-900 rounded-lg w-full max-w-sm border border-zinc-800">
            <div class="p-4 border-b border-zinc-800">
                <h3 class="font-medium text-white">Add User Access</h3>
            </div>
            <div class="p-4 space-y-3">
                <div>
                    <label class="block text-xs text-zinc-500 mb-1">Discord User ID *</label>
                    <input type="text" x-model="addAccessForm.discordId" 
                           class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1.5 text-sm focus:outline-none"
                           placeholder="123456789012345678">
                    <p class="text-xs text-zinc-500 mt-1">Right-click user on Discord â†’ Copy ID</p>
                </div>
                
                <div>
                    <label class="block text-xs text-zinc-500 mb-1">Role</label>
                    <select x-model="addAccessForm.role"
                            class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1.5 text-sm focus:outline-none">
                        <option value="0">Viewer</option>
                        <option value="1">Operator</option>
                        <option value="2">Admin</option>
                        <option value="3">Owner</option>
                    </select>
                </div>

                <div x-show="accessFormError" class="text-red-400 text-xs bg-red-500/10 rounded p-2">
                    <span x-text="accessFormError"></span>
                </div>
            </div>
            <div class="p-4 border-t border-zinc-800 flex gap-2">
                <button @click="showAddAccessModal = false; accessFormError = ''" 
                        class="flex-1 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition-colors">Cancel</button>
                <button @click="addAccess()" :disabled="accessFormLoading"
                        class="flex-1 px-3 py-2 bg-orange-500 hover:bg-orange-600 rounded text-sm font-medium transition-colors disabled:opacity-50">
                    <span x-show="!accessFormLoading">Add</span>
                    <span x-show="accessFormLoading"><i class="fas fa-spinner fa-spin"></i></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Role Modal -->
    <div x-show="showAddRoleModal" x-cloak
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4"
         @click.self="showAddRoleModal = false">
        <div class="bg-zinc-900 rounded-lg w-full max-w-sm border border-zinc-800">
            <div class="p-4 border-b border-zinc-800">
                <h3 class="font-medium text-white">Add Role</h3>
            </div>
            <div class="p-4 space-y-3">
                <div>
                    <label class="block text-xs text-zinc-500 mb-1">Role Name *</label>
                    <input type="text" x-model="addRoleForm.name" 
                           class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1.5 text-sm focus:outline-none"
                           placeholder="e.g. Moderator">
                </div>
                
                <div>
                    <label class="block text-xs text-zinc-500 mb-1">Permissions</label>
                    <div class="space-y-1 max-h-40 overflow-y-auto bg-zinc-800 p-2 rounded border border-zinc-700">
                        <template x-for="perm in availablePermissions" :key="perm">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" :value="perm" x-model="addRoleForm.permissions" class="rounded bg-zinc-700 border-zinc-600">
                                <span x-text="perm"></span>
                            </label>
                        </template>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-zinc-800 flex gap-2">
                <button @click="showAddRoleModal = false" 
                        class="flex-1 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition-colors">Cancel</button>
                <button @click="addRole()"
                        class="flex-1 px-3 py-2 bg-orange-500 hover:bg-orange-600 rounded text-sm font-medium transition-colors">
                    Create
                </button>
            </div>
        </div>
    </div>

    <!-- Safe Mode Warning Modal -->
    <div x-show="showSafeModeModal" x-cloak
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4"
         @click.self="showSafeModeModal = false">
        <div class="bg-zinc-900 rounded-lg w-full max-w-md border border-zinc-800">
            <div class="p-4 border-b border-zinc-800 flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                </div>
                <div>
                    <h3 class="font-medium text-white">Active Players Detected</h3>
                    <p class="text-xs text-zinc-500">Instance #<span x-text="safeModeInstance?.id"></span> has players</p>
                </div>
            </div>
            <div class="p-4">
                <div class="bg-zinc-800/50 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm text-zinc-400">Current Status</span>
                        <span class="text-sm font-medium" :class="getStatusColor(safeModeInstance?.status)" x-text="safeModeInstance?.status"></span>
                    </div>
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm text-zinc-400">Players Online</span>
                        <span class="text-sm font-bold text-orange-400" x-text="(safeModeInstance?.num_clients ?? safeModeInstance?.numClients ?? 0) + ' players'"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-zinc-400">Game Phase</span>
                        <span class="text-sm" x-text="safeModeInstance?.game_phase || safeModeInstance?.gamePhase || 'Unknown'"></span>
                    </div>
                </div>
                
                <div class="text-sm text-zinc-400 mb-4">
                    <p class="mb-2">
                        <i class="fas fa-shield-alt text-blue-400 mr-2"></i>
                        <strong>Safe Mode</strong> is protecting active players.
                    </p>
                    <p class="text-xs text-zinc-500">
                        Choose how you want to proceed:
                    </p>
                </div>
                
                <div class="space-y-2">
                    <!-- Sleep Option -->
                    <button @click="sleepInstance(safeModeInstance?.id)"
                            class="w-full p-3 bg-blue-600/20 hover:bg-blue-600/30 border border-blue-600/50 rounded-lg text-left transition-colors group">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-moon text-blue-400 text-lg"></i>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-white">Sleep Mode</div>
                                <div class="text-xs text-zinc-400">Kick all players and stop server. Use <span class="text-yellow-400">Wake</span> to start again.</div>
                            </div>
                            <i class="fas fa-chevron-right text-zinc-600 group-hover:text-zinc-400"></i>
                        </div>
                    </button>
                    
                    <!-- Force Option -->
                    <button @click="forceAction()"
                            class="w-full p-3 bg-red-600/20 hover:bg-red-600/30 border border-red-600/50 rounded-lg text-left transition-colors group">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-bolt text-red-400 text-lg"></i>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-white">Force <span x-text="safeModeAction" class="capitalize"></span></div>
                                <div class="text-xs text-zinc-400">Kick players and <span x-text="safeModeAction" class="text-red-400"></span> immediately</div>
                            </div>
                            <i class="fas fa-chevron-right text-zinc-600 group-hover:text-zinc-400"></i>
                        </div>
                    </button>
                </div>
            </div>
            <div class="p-4 border-t border-zinc-800">
                <button @click="showSafeModeModal = false" 
                        class="w-full px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Broadcast Message Modal -->
    <div x-show="showBroadcastModal" x-cloak
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4"
         @click.self="showBroadcastModal = false">
        <div class="bg-zinc-900 rounded-lg w-full max-w-sm border border-zinc-800">
            <div class="p-4 border-b border-zinc-800">
                <h3 class="font-medium text-white">Broadcast Message</h3>
            </div>
            <div class="p-4">
                <label class="block text-xs text-zinc-500 mb-1">Message</label>
                <textarea x-model="broadcastMessage" rows="3"
                          class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1.5 text-sm focus:outline-none resize-none"
                          placeholder="Enter message..."></textarea>
            </div>
            <div class="p-4 border-t border-zinc-800 flex gap-2">
                <button @click="showBroadcastModal = false" 
                        class="flex-1 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition-colors">Cancel</button>
                <button @click="sendBroadcast()" :disabled="!broadcastMessage || controlLoading"
                        class="flex-1 px-3 py-2 bg-orange-500 hover:bg-orange-600 rounded text-sm font-medium transition-colors disabled:opacity-50">Send</button>
            </div>
        </div>
    </div>

    <!-- Add Instance Modal -->
    <div x-show="showAddInstanceModal" x-cloak
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4"
         @click.self="showAddInstanceModal = false">
        <div class="bg-zinc-900 rounded-lg w-full max-w-sm border border-zinc-800">
            <div class="p-4 border-b border-zinc-800">
                <h3 class="font-medium text-white">Add Instances</h3>
            </div>
            <div class="p-4">
                <label class="block text-xs text-zinc-500 mb-2">Number of instances to add</label>
                
                <!-- Quick Select Buttons -->
                <div class="grid grid-cols-5 gap-2 mb-4">
                    <template x-for="n in [1, 2, 3, 5, 10]" :key="n">
                        <button @click="addInstanceCount = n"
                                class="py-2 rounded text-sm font-medium transition-colors"
                                :class="addInstanceCount === n ? 'bg-orange-500 text-white' : 'bg-zinc-800 hover:bg-zinc-700 text-zinc-300'">
                            <span x-text="n"></span>
                        </button>
                    </template>
                </div>
                
                <!-- Custom Input -->
                <div class="flex items-center gap-2 mb-4">
                    <input type="number" x-model.number="addInstanceCount" min="1" max="20"
                           class="flex-1 h-9 bg-zinc-800 border border-zinc-700 rounded px-3 text-sm focus:outline-none focus:border-zinc-600"
                           placeholder="Custom amount">
                    <span class="text-zinc-500 text-sm">instances</span>
                </div>
                
                <!-- All to Total Option -->
                <button @click="addInstanceCount = Math.max(0, (serverConfig?.svr_total || 0) - (statusData?.instances?.length || 0))"
                        class="w-full py-2 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded text-sm transition-colors mb-2"
                        :disabled="(serverConfig?.svr_total || 0) <= (statusData?.instances?.length || 0)">
                    <i class="fas fa-fill-drip mr-2"></i>
                    Fill to Total (<span x-text="serverConfig?.svr_total || 0"></span> - <span x-text="statusData?.instances?.length || 0"></span> = <span x-text="Math.max(0, (serverConfig?.svr_total || 0) - (statusData?.instances?.length || 0))"></span>)
                </button>
                
                <!-- Info -->
                <div class="text-xs text-zinc-500 mt-3">
                    Current: <span x-text="statusData?.instances?.length || 0"></span> instances
                    <span x-show="serverConfig?.svr_total"> | Target: <span x-text="serverConfig?.svr_total"></span></span>
                </div>
            </div>
            <div class="p-4 border-t border-zinc-800 flex gap-2">
                <button @click="showAddInstanceModal = false" 
                        class="flex-1 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm transition-colors">Cancel</button>
                <button @click="addMultipleInstances()" :disabled="!addInstanceCount || addInstanceCount < 1 || controlLoading"
                        class="flex-1 px-3 py-2 bg-orange-500 hover:bg-orange-600 rounded text-sm font-medium transition-colors disabled:opacity-50">
                    <span x-show="!controlLoading">Add <span x-text="addInstanceCount"></span> Instance<span x-show="addInstanceCount > 1">s</span></span>
                    <span x-show="controlLoading"><i class="fas fa-spinner fa-spin mr-1"></i>Adding...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- SuperAdmin Panel Modal -->
    <div x-show="showAdminPanel" x-cloak
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4"
         @click.self="showAdminPanel = false">
        <div class="bg-zinc-900 rounded-lg w-full max-w-2xl max-h-[80vh] flex flex-col border border-zinc-800">
            <div class="p-4 border-b border-zinc-800 flex items-center justify-between">
                <h3 class="font-medium text-white flex items-center gap-2">
                    <i class="fas fa-shield-alt text-red-400"></i>
                    SuperAdmin Panel
                </h3>
                <button @click="showAdminPanel = false" class="text-zinc-500 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-4 overflow-y-auto flex-1">
                <div x-show="adminLoading" class="text-center py-6 text-zinc-500">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                
                <!-- Users List -->
                <div x-show="!adminLoading">
                    <div class="text-xs text-zinc-500 mb-3">Users (<span x-text="adminUsers.length"></span>)</div>
                    
                    <div class="space-y-2">
                        <template x-for="u in adminUsers" :key="u.id">
                            <div class="flex items-center justify-between p-3 bg-zinc-800/50 rounded border border-zinc-800">
                                <div class="flex items-center gap-3">
                                    <img :src="u.avatarUrl || 'https://cdn.discordapp.com/embed/avatars/0.png'" 
                                         class="w-8 h-8 rounded-full">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span x-text="u.username" class="text-sm"></span>
                                            <span x-show="u.isSuperAdmin" class="text-xs text-red-400">
                                                <i class="fas fa-shield-alt"></i>
                                            </span>
                                        </div>
                                        <div class="text-xs text-zinc-500">
                                            <span x-text="u.serverCount"></span> servers
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <template x-if="u.id !== user?.id">
                                        <button @click="toggleSuperAdmin(u)"
                                                class="px-2 py-1 text-xs rounded transition-colors"
                                                :class="u.isSuperAdmin 
                                                    ? 'bg-zinc-700 hover:bg-zinc-600 text-zinc-300' 
                                                    : 'bg-red-500/20 hover:bg-red-500/30 text-red-400'">
                                            <span x-text="u.isSuperAdmin ? 'Remove' : 'Make Admin'"></span>
                                        </button>
                                    </template>
                                    <template x-if="u.id === user?.id">
                                        <span class="text-xs text-zinc-600">You</span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <div x-show="adminUsers.length === 0" class="text-center py-6 text-zinc-500 text-sm">
                        No users found
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function portalApp() {
            return {
                user: null,
                token: null,
                servers: [],
                serverStatuses: {},
                dashboard: {
                    totalServers: 0,
                    onlineServers: 0,
                    totalGameServers: 0,
                    activeGameServers: 0,
                    activeMatches: 0,
                    totalPlayers: 0
                },
                loading: true,
                hubConnection: null,
                hubConnected: false,
                
                // Modals
                showAddModal: false,
                showEditModal: false,
                showKeyModal: false,
                showDeleteModal: false,
                showDetailsModal: false,
                showBroadcastModal: false,
                showAddAccessModal: false,
                showAdminPanel: false,
                showAddInstanceModal: false,
                addInstanceCount: 1,
                selectedServer: null,
                serverDetails: null,
                statusData: null,
                detailsLoading: false,
                controlLoading: false,
                activeTab: 'overview',
                openDropdown: null,
                
                // Toast notifications
                toasts: [],
                
                // Auto-Refresh
                autoRefreshEnabled: false,
                autoRefreshInterval: 10,
                autoRefreshTimer: null,
                
                // SuperAdmin Panel
                adminUsers: [],
                adminLoading: false,
                
                // Access Management
                serverAccessList: [],
                accessLoading: false,
                accessFormLoading: false,
                accessFormError: '',
                addAccessForm: {
                    discordId: '',
                    role: 0
                },
                
                // Replays
                replays: [],
                replayStats: null,
                replaysLoading: false,
                
                // Statistics
                statsSummary: null,
                recentMatches: [],
                topPlayers: [],
                statsLoading: false,
                
                // Logs
                serverLogs: '',
                selectedLogInstance: null,
                logsLoading: false,
                
                // Health
                healthChecks: [],

                // Console
                consoleLogs: [],
                consoleCommand: '',
                consoleCommandHistory: [],
                consoleHistoryIndex: -1,
                showConsoleHelp: false,
                
                // Filebeat
                filebeatStatus: null,
                
                // Git
                gitStatus: null,
                selectedBranch: '',
                
                // Backups
                backupsList: [],
                
                // RBAC
                rolesList: [],
                showAddRoleModal: false,
                addRoleForm: {
                    name: '',
                    permissions: []
                },
                availablePermissions: [
                    'server.view',
                    'server.control',
                    'server.config',
                    'server.console',
                    'server.files',
                    'server.backups',
                    'server.git',
                    'server.rbac'
                ],
                systemResources: null,
                healthLoading: false,
                
                // System - Patching
                patchStatus: null,
                patchLoading: false,
                
                // System - AutoPing
                autoPingStatus: null,
                autoPingLoading: false,
                
                // System - MQTT
                mqttStatus: null,
                mqttLoading: false,
                
                // System - Discord
                discordStatus: null,
                discordLoading: false,
                
                // System - Tasks
                scheduledTasks: [],
                tasksLoading: false,
                
                // System - CLI
                cliCommand: '',
                cliOutput: '',
                cliLoading: false,
                
                // Scaling
                scalingStatus: null,
                scalingLoading: false,
                
                // Crash Protection
                crashProtection: {
                    enabled: true,
                    autoRestartEnabled: true,
                    maxRestartAttempts: 3,
                    restartCooldownSeconds: 30,
                    monitorIntervalSeconds: 10,
                    notifyOnCrash: true,
                    notifyOnRestart: true
                },
                crashHistory: [],
                crashProtectionLoading: false,
                
                // Safe Mode (Player Protection)
                safeMode: {
                    enabled: true,
                    requireConfirmation: true,
                    autoRestartWhenEmpty: true,
                    strictMode: false  // false = protect when players > 0, true = protect only during active game
                },
                sleepingInstances: {},  // { instanceId: { pendingAction: 'stop'|'restart', waitingSince: timestamp } }
                showSafeModeModal: false,
                safeModeAction: null,
                safeModeInstance: null,
                
                // Notifications & Alerts
                notifications: [],
                unacknowledgedCount: 0,
                alertThresholds: null,
                notificationsLoading: false,
                
                // Webhooks
                webhooks: [],
                webhooksLoading: false,
                newWebhookUrl: '',
                newWebhookEvents: [],
                
                // Charts
                chartsData: {
                    uptime: [],
                    players: [],
                    matches: []
                },
                chartsLoading: false,
                chartDays: 7,
                
                // Templates
                templates: [],
                templatesLoading: false,
                
                // Server Manager Settings
                targetServers: 1,
                proxyEnabled: true,
                basePort: 10001,
                maxPlayers: 10,
                instanceSearch: '',
                instanceFilter: 'all',
                instanceSort: 'id',
                instanceSortAsc: true,
                instanceViewMode: 'list',
                broadcastMessage: '',
                
                // Full Config
                serverConfig: {
                    svr_name: '',
                    svr_location: 'NEWERTH',
                    svr_priority: 'HIGH',
                    svr_total: 1,
                    svr_total_per_core: 1,
                    svr_enableBotMatch: true,
                    svr_start_on_launch: false,
                    svr_noConsole: true,
                    svr_max_start_at_once: 5,
                    svr_startup_timeout: 180,
                    svr_restart_between_games: false,
                    svr_masterServer: '',
                    svr_chatServer: '',
                    svr_patchServer: 'api.kongor.net/patches',
                    svr_starting_gamePort: 10001,
                    svr_starting_voicePort: 10061,
                    svr_api_port: 5050,
                    svr_maxClients: 10,
                    svr_managerPort: 11235,
                    svr_beta_mode: false,
                    man_enableProxy: true,
                    man_use_cowmaster: false,
                    hon_install_directory: '',
                    hon_home_directory: '',
                    // Discord Bot Settings
                    discord_bot_token: '',
                    discord_owner_id: '',
                    discord_notification_channel_id: '',
                    discord_enable_notifications: true,
                    discord_notify_match_start: true,
                    discord_notify_match_end: true,
                    discord_notify_player_join_leave: false
                },
                
                // Form
                serverForm: {
                    serverName: '',
                    ipAddress: '',
                    apiPort: 5050,
                    region: 'Unknown'
                },
                formError: '',
                formLoading: false,

                // Computed property to get status data (liveData first, then cachedStatus)
                get statusData() {
                    return this.serverDetails?.liveData || this.serverDetails?.cachedStatus || {};
                },

                async init() {
                    console.log('Init started, URL:', window.location.href);
                    
                    // Check for token in URL or localStorage
                    const params = new URLSearchParams(window.location.search);
                    const urlToken = params.get('token');
                    
                    console.log('URL token:', urlToken);
                    console.log('LocalStorage token:', localStorage.getItem('portal_token'));
                    
                    if (urlToken) {
                        this.token = urlToken;
                        localStorage.setItem('portal_token', urlToken);
                        window.history.replaceState({}, '', '/');
                    } else {
                        this.token = localStorage.getItem('portal_token');
                    }
                    
                    // Check for error
                    const error = params.get('error');
                    if (error) {
                        console.error('Login error:', error);
                        alert('Login failed: ' + error);
                        window.history.replaceState({}, '', '/');
                    }
                    
                    console.log('Final token:', this.token);
                    
                    if (this.token) {
                        await this.loadUser();
                    }
                    
                    console.log('User after loadUser:', this.user);
                    this.loading = false;
                },
                
                // Toast notification system
                showToast(message, type = 'info') {
                    const id = Date.now();
                    const toast = { id, message, type };
                    this.toasts.push(toast);
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        this.removeToast(id);
                    }, 5000);
                },
                
                removeToast(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index !== -1) {
                        this.toasts.splice(index, 1);
                    }
                },

                async loadUser() {
                    try {
                        console.log('loadUser called with token:', this.token);
                        const res = await this.apiCall('/auth/me');
                        console.log('loadUser response status:', res.status);
                        if (res.ok) {
                            this.user = await res.json();
                            console.log('User loaded:', this.user);
                            await this.loadServers();
                            this.connectSignalR();
                        } else {
                            const errorText = await res.text();
                            console.error('loadUser failed:', res.status, errorText);
                            this.token = null;
                            localStorage.removeItem('portal_token');
                        }
                    } catch (err) {
                        console.error('Failed to load user:', err);
                    }
                },

                async loadServers() {
                    try {
                        const res = await this.apiCall('/api/my-servers');
                        if (res.ok) {
                            this.servers = await res.json();
                            this.servers.forEach(s => {
                                if (s.status) {
                                    this.serverStatuses[s.serverId] = s.status;
                                }
                            });
                            this.recalculateDashboard();
                        }
                    } catch (err) {
                        console.error('Failed to load servers:', err);
                    }
                },

                async connectSignalR() {
                    this.hubConnection = new signalR.HubConnectionBuilder()
                        .withUrl('/hub/portal')
                        .withAutomaticReconnect()
                        .build();

                    this.hubConnection.on('ServerStatusUpdated', (serverId, status) => {
                        this.serverStatuses[serverId] = status;
                        const server = this.servers.find(s => s.serverId === serverId);
                        if (server) {
                            server.isOnline = true;
                            server.lastSeenAt = new Date().toISOString();
                        }
                        this.recalculateDashboard();
                    });

                    this.hubConnection.onreconnecting(() => this.hubConnected = false);
                    this.hubConnection.onreconnected(() => this.hubConnected = true);
                    this.hubConnection.onclose(() => this.hubConnected = false);

                    try {
                        await this.hubConnection.start();
                        this.hubConnected = true;
                    } catch (err) {
                        console.error('SignalR failed:', err);
                        setTimeout(() => this.connectSignalR(), 5000);
                    }
                },

                recalculateDashboard() {
                    let totalServers = this.servers.length;
                    let onlineServers = 0;
                    let totalGameServers = 0;
                    let activeGameServers = 0;
                    let totalPlayers = 0;
                    let activeMatches = 0;

                    this.servers.forEach(server => {
                        if (server.isOnline) onlineServers++;
                        
                        const status = this.serverStatuses[server.serverId];
                        if (status) {
                            totalGameServers += status.totalServers || 0;
                            activeGameServers += status.onlineServers || 0;
                            totalPlayers += status.totalPlayers || 0;
                            
                            if (status.instances) {
                                activeMatches += status.instances.filter(i => 
                                    i.status === 'Occupied' || i.status === 'OCCUPIED'
                                ).length;
                            }
                        }
                    });

                    this.dashboard = {
                        totalServers,
                        onlineServers,
                        totalGameServers,
                        activeGameServers,
                        totalPlayers,
                        activeMatches
                    };
                },

                getServerStatus(serverId) {
                    return this.serverStatuses[serverId] || null;
                },

                // Form actions
                async addServer() {
                    this.formError = '';
                    this.formLoading = true;
                    
                    try {
                        const res = await this.apiCall('/api/my-servers', {
                            method: 'POST',
                            body: JSON.stringify({
                                server_name: this.serverForm.serverName,
                                ip_address: this.serverForm.ipAddress,
                                api_port: this.serverForm.apiPort || 5050,
                                region: this.serverForm.region
                            })
                        });
                        
                        const data = await res.json();
                        
                        if (res.ok) {
                            await this.loadServers();
                            this.closeModals();
                            
                            // Show API key
                            this.selectedServer = data;
                            this.showKeyModal = true;
                        } else {
                            this.formError = data.error || 'Failed to add server';
                        }
                    } catch (err) {
                        this.formError = 'Network error';
                    } finally {
                        this.formLoading = false;
                    }
                },

                editServer(server) {
                    this.selectedServer = server;
                    this.serverForm = {
                        serverName: server.serverName,
                        ipAddress: server.ipAddress,
                        apiPort: server.apiPort,
                        region: server.region
                    };
                    this.showEditModal = true;
                },

                async updateServer() {
                    this.formError = '';
                    this.formLoading = true;
                    
                    try {
                        const res = await this.apiCall(`/api/my-servers/${this.selectedServer.serverId}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                server_name: this.serverForm.serverName,
                                ip_address: this.serverForm.ipAddress,
                                api_port: this.serverForm.apiPort,
                                region: this.serverForm.region
                            })
                        });
                        
                        const data = await res.json();
                        
                        if (res.ok) {
                            await this.loadServers();
                            this.closeModals();
                        } else {
                            this.formError = data.error || 'Failed to update server';
                        }
                    } catch (err) {
                        this.formError = 'Network error';
                    } finally {
                        this.formLoading = false;
                    }
                },

                confirmDelete(server) {
                    this.selectedServer = server;
                    this.showDeleteModal = true;
                },

                async deleteServer() {
                    this.formLoading = true;
                    
                    try {
                        const res = await this.apiCall(`/api/my-servers/${this.selectedServer.serverId}`, {
                            method: 'DELETE'
                        });
                        
                        if (res.ok) {
                            await this.loadServers();
                            this.showDeleteModal = false;
                        } else {
                            alert('Failed to delete server');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.formLoading = false;
                    }
                },

                showApiKey(server) {
                    this.selectedServer = server;
                    this.showKeyModal = true;
                },

                copyApiKey() {
                    navigator.clipboard.writeText(this.selectedServer.apiKey);
                    alert('API Key copied to clipboard!');
                },

                // Server Details & Control
                async openServerDetails(server) {
                    this.selectedServer = server;
                    this.serverDetails = null;
                    this.activeTab = 'overview';
                    this.showDetailsModal = true;
                    await this.refreshServerDetails();
                    await this.loadServerConfig();
                    // Load crash protection settings
                    await this.loadCrashProtectionSettings();
                    await this.loadCrashHistory();
                },

                // Auto-Refresh Methods
                toggleAutoRefresh() {
                    this.autoRefreshEnabled = !this.autoRefreshEnabled;
                    if (this.autoRefreshEnabled) {
                        this.startAutoRefresh();
                    } else {
                        this.stopAutoRefresh();
                    }
                },
                
                startAutoRefresh() {
                    this.stopAutoRefresh(); // Clear any existing timer
                    const intervalMs = parseInt(this.autoRefreshInterval) * 1000;
                    this.autoRefreshTimer = setInterval(() => {
                        if (this.showDetailsModal && !this.detailsLoading) {
                            this.refreshServerDetails();
                        }
                    }, intervalMs);
                },
                
                stopAutoRefresh() {
                    if (this.autoRefreshTimer) {
                        clearInterval(this.autoRefreshTimer);
                        this.autoRefreshTimer = null;
                    }
                },
                
                restartAutoRefresh() {
                    if (this.autoRefreshEnabled) {
                        this.startAutoRefresh();
                    }
                },

                async refreshServerDetails() {
                    if (!this.selectedServer) return;
                    
                    this.detailsLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/details`);
                        if (res.ok) {
                            const data = await res.json();
                            this.serverDetails = data;
                            
                            // Update local serverStatuses with live data if available
                            if (data.liveData) {
                                this.serverStatuses[this.selectedServer.serverId] = data.liveData;
                                this.statusData = data.liveData;
                            } else if (data.cachedStatus) {
                                this.serverStatuses[this.selectedServer.serverId] = data.cachedStatus;
                                this.statusData = data.cachedStatus;
                            }
                            
                            this.recalculateDashboard();
                            
                            // Check for crashed instances (crash protection)
                            this.checkForCrashedInstances();
                        }
                    } catch (err) {
                        console.error('Failed to load server details:', err);
                    } finally {
                        this.detailsLoading = false;
                    }
                },

                async startInstance(instanceId) {
                    this.controlLoading = true;
                    try {
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/instances/${instanceId}/start`,
                            { method: 'POST' }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            await this.refreshServerDetails();
                        } else {
                            alert(data.error || 'Failed to start instance');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async stopInstance(instanceId, force = false) {
                    const instance = this.getInstanceById(instanceId);
                    
                    // Check if safe mode is enabled and instance has players
                    if (this.safeMode.enabled && !force && instance) {
                        // strictMode = only protect during active game, otherwise protect when any players online
                        const shouldProtect = this.safeMode.strictMode 
                            ? this.isInGame(instance) 
                            : (this.hasActivePlayers(instance) || this.isInGame(instance));
                        
                        if (shouldProtect) {
                            // Show safe mode modal
                            this.safeModeInstance = instance;
                            this.safeModeAction = 'stop';
                            this.showSafeModeModal = true;
                            return;
                        }
                    }
                    
                    // Cancel any sleeping state
                    delete this.sleepingInstances[instanceId];
                    
                    this.controlLoading = true;
                    try {
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/instances/${instanceId}/stop`,
                            { method: 'POST' }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            this.showToast(`Instance #${instanceId} stopped`, 'success');
                            await this.refreshServerDetails();
                        } else {
                            this.showToast(data.error || 'Failed to stop instance', 'error');
                        }
                    } catch (err) {
                        this.showToast('Network error', 'error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async restartInstance(instanceId, force = false) {
                    const instance = this.getInstanceById(instanceId);
                    
                    // Check if safe mode is enabled and instance has players
                    if (this.safeMode.enabled && !force && instance) {
                        // strictMode = only protect during active game, otherwise protect when any players online
                        const shouldProtect = this.safeMode.strictMode 
                            ? this.isInGame(instance) 
                            : (this.hasActivePlayers(instance) || this.isInGame(instance));
                        
                        if (shouldProtect) {
                            // Show safe mode modal
                            this.safeModeInstance = instance;
                            this.safeModeAction = 'restart';
                            this.showSafeModeModal = true;
                            return;
                        }
                    }
                    
                    // Cancel any sleeping state
                    delete this.sleepingInstances[instanceId];
                    
                    this.controlLoading = true;
                    try {
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/instances/${instanceId}/restart`,
                            { method: 'POST' }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            this.showToast(`Instance #${instanceId} restarted`, 'success');
                            await this.refreshServerDetails();
                        } else {
                            this.showToast(data.error || 'Failed to restart instance', 'error');
                        }
                    } catch (err) {
                        this.showToast('Network error', 'error');
                    } finally {
                        this.controlLoading = false;
                    }
                },
                
                // Get instance by ID
                getInstanceById(instanceId) {
                    const instances = this.statusData?.instances || [];
                    return instances.find(i => i.id === instanceId);
                },
                
                // Put instance to sleep (kick players and stop)
                async sleepInstance(instanceId) {
                    this.showSafeModeModal = false;
                    
                    const instance = this.getInstanceById(instanceId);
                    const players = instance ? (instance.num_clients ?? instance.numClients ?? 0) : 0;
                    
                    this.addLogEntry(`Putting instance #${instanceId} to sleep...`, 'info');
                    
                    try {
                        // Step 1: Kick all players if any
                        if (players > 0) {
                            this.addLogEntry(`Kicking ${players} player(s)...`, 'warning');
                            await this.apiCall(`/api/servers/${instanceId}/reset`, { method: 'POST' });
                            await new Promise(r => setTimeout(r, 2000));
                        }
                        
                        // Step 2: Stop the server
                        this.addLogEntry('Stopping server...', 'info');
                        const res = await this.apiCall(`/api/servers/${instanceId}/stop`, { method: 'POST' });
                        
                        // Always mark as sleeping if request was made (API now always returns success)
                        this.sleepingInstances[instanceId] = {
                            sleepingSince: new Date().toISOString()
                        };
                        
                        // Update local instance status
                        if (instance) {
                            instance.status = 'Offline';
                            instance.num_clients = 0;
                            instance.numClients = 0;
                        }
                        
                        this.addLogEntry(`Instance #${instanceId} is now sleeping`, 'success');
                        this.showToast(`Instance #${instanceId} is now sleeping`, 'success');
                    } catch (err) {
                        this.addLogEntry(`Error: ${err.message}`, 'error');
                        this.showToast(`Error: ${err.message}`, 'error');
                    }
                },
                
                // Wake instance from sleep (start it)
                async wakeInstance(instanceId) {
                    if (!this.sleepingInstances[instanceId]) {
                        this.showToast(`Instance #${instanceId} is not sleeping`, 'warning');
                        return;
                    }
                    
                    this.showToast(`Waking instance #${instanceId}...`, 'info');
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${instanceId}/start`, { method: 'POST' });
                        
                        if (res.ok) {
                            delete this.sleepingInstances[instanceId];
                            this.showToast(`Instance #${instanceId} is now awake`, 'success');
                        } else {
                            this.showToast('Failed to start server', 'error');
                        }
                    } catch (err) {
                        this.showToast(`Error: ${err.message}`, 'error');
                    }
                },
                
                // Cancel sleep mode for instance (deprecated - use wakeInstance)
                cancelSleep(instanceId) {
                    this.wakeInstance(instanceId);
                },
                
                // Check if instance should be protected based on safe mode settings
                shouldProtectInstance(instance) {
                    if (!instance) return false;
                    if (this.safeMode.strictMode) {
                        return this.isInGame(instance);
                    }
                    return this.hasActivePlayers(instance) || this.isInGame(instance);
                },
                
                // Force action (bypass safe mode) - sends serverreset to kick all players first
                async forceAction() {
                    if (!this.safeModeInstance) return;
                    
                    const instanceId = this.safeModeInstance.id;
                    const action = this.safeModeAction;
                    
                    this.showSafeModeModal = false;
                    this.showToast(`Kicking players from instance #${instanceId}...`, 'warning');
                    
                    try {
                        // Send serverreset command to kick all players
                        const res = await this.apiCall(`/api/servers/${instanceId}/reset`, 'POST');
                        
                        if (res.ok) {
                            // Wait a moment for players to be disconnected
                            await new Promise(r => setTimeout(r, 2000));
                            
                            if (action === 'stop') {
                                await this.stopInstance(instanceId, true);
                            } else if (action === 'restart') {
                                await this.restartInstance(instanceId, true);
                            }
                        } else {
                            this.showToast('Failed to send reset command', 'error');
                            // Fall back to normal action
                            if (action === 'stop') {
                                await this.stopInstance(instanceId, true);
                            } else if (action === 'restart') {
                                await this.restartInstance(instanceId, true);
                            }
                        }
                    } catch (err) {
                        console.error('Force action failed:', err);
                        // Fall back to normal action
                        if (action === 'stop') {
                            await this.stopInstance(instanceId, true);
                        } else if (action === 'restart') {
                            await this.restartInstance(instanceId, true);
                        }
                    }
                },
                
                // Check sleeping instances on refresh
                checkSleepingInstances() {
                    for (const [instanceId, sleep] of Object.entries(this.sleepingInstances)) {
                        const instance = this.getInstanceById(parseInt(instanceId));
                        if (!instance) {
                            delete this.sleepingInstances[instanceId];
                            continue;
                        }
                        
                        // Check if players have left (based on strictMode setting)
                        if (!this.shouldProtectInstance(instance)) {
                            const action = sleep.pendingAction;
                            delete this.sleepingInstances[instanceId];
                            
                            this.showToast(`Instance #${instanceId} is now empty, executing ${action}...`, 'info');
                            
                            if (action === 'stop') {
                                this.stopInstance(parseInt(instanceId), true);
                            } else if (action === 'restart') {
                                this.restartInstance(parseInt(instanceId), true);
                            }
                        }
                    }
                },

                async startAllInstances() {
                    if (!confirm('Start all game server instances?')) return;
                    
                    this.controlLoading = true;
                    try {
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/start-all`,
                            { method: 'POST' }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            await this.refreshServerDetails();
                        } else {
                            alert(data.error || 'Failed to start instances');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async stopAllInstances() {
                    if (!confirm('Stop all game server instances?')) return;
                    
                    this.controlLoading = true;
                    try {
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/stop-all`,
                            { method: 'POST' }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            await this.refreshServerDetails();
                        } else {
                            alert(data.error || 'Failed to stop instances');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async restartAllInstances() {
                    if (!confirm('Restart all game server instances?')) return;
                    
                    this.controlLoading = true;
                    try {
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/restart-all`,
                            { method: 'POST' }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            await this.refreshServerDetails();
                        } else {
                            alert(data.error || 'Failed to restart instances');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async addNewInstance() {
                    this.controlLoading = true;
                    try {
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/instances/add`,
                            { method: 'POST' }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            // Wait a moment for HoNfigurator to update its state
                            await new Promise(r => setTimeout(r, 1000));
                            await this.refreshServerDetails();
                            await this.loadServers(); // Also refresh the main list
                        } else {
                            alert(data.error || 'Failed to add instance');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async addAllInstances() {
                    const maxServers = this.statusData?.system_stats?.max_allowed_servers || this.statusData?.systemStats?.maxAllowedServers || 0;
                    const current = this.statusData?.total_servers || this.statusData?.totalServers || 0;
                    
                    if (!confirm(`Add all instances up to maximum capacity (${maxServers})? Currently have ${current} instances.`)) return;
                    
                    this.controlLoading = true;
                    try {
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/instances/add-all`,
                            { method: 'POST' }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            // Wait a moment for HoNfigurator to update its state
                            await new Promise(r => setTimeout(r, 1000));
                            await this.refreshServerDetails();
                            await this.loadServers(); // Also refresh the main list
                            alert(data.message || `Added instances to reach maximum capacity`);
                        } else {
                            alert(data.error || 'Failed to add all instances');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async deleteInstance(instanceId) {
                    if (!confirm(`Delete instance #${instanceId}?`)) return;
                    
                    this.controlLoading = true;
                    try {
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/instances/${instanceId}/delete`,
                            { method: 'POST' }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            // Wait a moment for HoNfigurator to update its state
                            await new Promise(r => setTimeout(r, 1000));
                            await this.refreshServerDetails();
                            await this.loadServers(); // Also refresh the main list
                        } else {
                            alert(data.error || 'Failed to delete instance');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async addMultipleInstances() {
                    const count = this.addInstanceCount;
                    if (!count || count < 1) return;
                    
                    this.controlLoading = true;
                    try {
                        let successCount = 0;
                        for (let i = 0; i < count; i++) {
                            const res = await this.apiCall(
                                `/api/servers/${this.selectedServer.serverId}/instances/add`,
                                { method: 'POST' }
                            );
                            if (res.ok) {
                                successCount++;
                            } else {
                                const data = await res.json();
                                console.error(`Failed to add instance ${i + 1}: ${data.error}`);
                            }
                            // Small delay between additions
                            if (i < count - 1) {
                                await new Promise(r => setTimeout(r, 300));
                            }
                        }
                        
                        // Wait a moment for HoNfigurator to update its state
                        await new Promise(r => setTimeout(r, 1000));
                        await this.refreshServerDetails();
                        await this.loadServers();
                        
                        this.showAddInstanceModal = false;
                        this.addInstanceCount = 1;
                        
                        if (successCount < count) {
                            alert(`Added ${successCount} of ${count} instances. Some may have failed.`);
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async deleteAllInstances() {
                    const instances = this.statusData?.instances || [];
                    if (instances.length === 0) {
                        alert('No instances to delete');
                        return;
                    }
                    
                    if (!confirm(`Delete ALL ${instances.length} instances? This action cannot be undone!`)) return;
                    
                    this.controlLoading = true;
                    try {
                        // Delete instances one by one from highest ID to lowest
                        const sortedInstances = [...instances].sort((a, b) => b.id - a.id);
                        for (const instance of sortedInstances) {
                            const res = await this.apiCall(
                                `/api/servers/${this.selectedServer.serverId}/instances/${instance.id}/delete`,
                                { method: 'POST' }
                            );
                            if (!res.ok) {
                                const text = await res.text();
                                let errorMsg;
                                try {
                                    const data = JSON.parse(text);
                                    errorMsg = data.error || `Failed to delete instance ${instance.id}`;
                                } catch {
                                    errorMsg = text || `Failed to delete instance ${instance.id}`;
                                }
                                throw new Error(errorMsg);
                            }
                            await new Promise(r => setTimeout(r, 500)); // Small delay between deletions
                        }
                        
                        // Wait a moment for HoNfigurator to update its state
                        await new Promise(r => setTimeout(r, 1000));
                        await this.refreshServerDetails();
                        await this.loadServers();
                    } catch (err) {
                        alert(err.message || 'Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async applyScale() {
                    this.controlLoading = true;
                    try {
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/scale`,
                            { 
                                method: 'POST',
                                body: JSON.stringify({ targetCount: this.targetServers })
                            }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            await this.refreshServerDetails();
                        } else {
                            alert(data.error || 'Failed to scale');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async updateConfig() {
                    this.controlLoading = true;
                    try {
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/config`,
                            { 
                                method: 'POST',
                                body: JSON.stringify({ 
                                    proxyEnabled: this.proxyEnabled, 
                                    basePort: this.basePort, 
                                    maxPlayers: this.maxPlayers,
                                    totalServers: this.targetServers
                                })
                            }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            alert('Configuration saved successfully!');
                            await this.refreshServerDetails();
                        } else {
                            alert(data.error || 'Failed to save configuration');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async loadServerConfig() {
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/config`);
                        if (res.ok) {
                            const config = await res.json();
                            console.log('Loaded config:', config);
                            
                            // Update full serverConfig object
                            this.serverConfig.svr_name = config.svr_name?.value ?? '';
                            this.serverConfig.svr_location = config.svr_location?.value ?? 'NEWERTH';
                            this.serverConfig.svr_priority = config.svr_priority?.value ?? 'HIGH';
                            this.serverConfig.svr_total = config.svr_total?.value ?? 1;
                            this.serverConfig.svr_total_per_core = config.svr_total_per_core?.value ?? 1;
                            this.serverConfig.svr_enableBotMatch = config.svr_enableBotMatch?.value ?? true;
                            this.serverConfig.svr_start_on_launch = config.svr_start_on_launch?.value ?? false;
                            this.serverConfig.svr_noConsole = config.svr_noConsole?.value ?? true;
                            this.serverConfig.svr_max_start_at_once = config.svr_max_start_at_once?.value ?? 5;
                            this.serverConfig.svr_startup_timeout = config.svr_startup_timeout?.value ?? 180;
                            this.serverConfig.svr_restart_between_games = config.svr_restart_between_games?.value ?? false;
                            this.serverConfig.svr_masterServer = config.svr_masterServer?.value ?? '';
                            this.serverConfig.svr_chatServer = config.svr_chatServer?.value ?? '';
                            this.serverConfig.svr_patchServer = config.svr_patchServer?.value ?? 'api.kongor.net/patches';
                            this.serverConfig.svr_starting_gamePort = config.svr_starting_gamePort?.value ?? 10001;
                            this.serverConfig.svr_starting_voicePort = config.svr_starting_voicePort?.value ?? 10061;
                            this.serverConfig.svr_api_port = config.svr_api_port?.value ?? 5050;
                            this.serverConfig.svr_maxClients = config.svr_maxClients?.value ?? 10;
                            this.serverConfig.svr_managerPort = config.svr_managerPort?.value ?? 11235;
                            this.serverConfig.svr_beta_mode = config.svr_beta_mode?.value ?? false;
                            this.serverConfig.man_enableProxy = config.man_enableProxy?.value ?? true;
                            this.serverConfig.man_use_cowmaster = config.man_use_cowmaster?.value ?? false;
                            this.serverConfig.hon_install_directory = config.hon_install_directory?.value ?? '';
                            this.serverConfig.hon_home_directory = config.hon_home_directory?.value ?? '';
                            
                            // Host Credentials
                            this.serverConfig.svr_login = config.svr_login?.value ?? '';
                            this.serverConfig.svr_password = config.svr_password?.value ?? '';
                            
                            // Discord Bot Settings
                            this.serverConfig.discord_bot_token = config.discord_bot_token?.value ?? '';
                            this.serverConfig.discord_owner_id = config.discord_owner_id?.value ?? '';
                            this.serverConfig.discord_notification_channel_id = config.discord_notification_channel_id?.value ?? '';
                            this.serverConfig.discord_enable_notifications = config.discord_enable_notifications?.value ?? false;
                            this.serverConfig.discord_notify_match_start = config.discord_notify_match_start?.value ?? true;
                            this.serverConfig.discord_notify_match_end = config.discord_notify_match_end?.value ?? true;
                            this.serverConfig.discord_notify_player_join_leave = config.discord_notify_player_join_leave?.value ?? false;
                            
                            // Also update simple vars for backward compat
                            this.proxyEnabled = this.serverConfig.man_enableProxy;
                            this.basePort = this.serverConfig.svr_starting_gamePort;
                            this.maxPlayers = this.serverConfig.svr_maxClients;
                            this.targetServers = this.serverConfig.svr_total;
                        }
                    } catch (err) {
                        console.error('Failed to load config:', err);
                    }
                },

                async saveFullConfig() {
                    this.controlLoading = true;
                    try {
                        // Build flat config object to send
                        const configPayload = {
                            svr_name: this.serverConfig.svr_name,
                            svr_location: this.serverConfig.svr_location,
                            svr_priority: this.serverConfig.svr_priority,
                            svr_total: parseInt(this.serverConfig.svr_total),
                            svr_total_per_core: parseFloat(this.serverConfig.svr_total_per_core),
                            svr_enableBotMatch: this.serverConfig.svr_enableBotMatch,
                            svr_start_on_launch: this.serverConfig.svr_start_on_launch,
                            svr_noConsole: this.serverConfig.svr_noConsole,
                            svr_max_start_at_once: parseInt(this.serverConfig.svr_max_start_at_once),
                            svr_startup_timeout: parseInt(this.serverConfig.svr_startup_timeout),
                            svr_restart_between_games: this.serverConfig.svr_restart_between_games,
                            svr_masterServer: this.serverConfig.svr_masterServer,
                            svr_chatServer: this.serverConfig.svr_chatServer,
                            svr_patchServer: this.serverConfig.svr_patchServer,
                            svr_starting_gamePort: parseInt(this.serverConfig.svr_starting_gamePort),
                            svr_api_port: parseInt(this.serverConfig.svr_api_port),
                            svr_maxClients: parseInt(this.serverConfig.svr_maxClients),
                            man_enableProxy: this.serverConfig.man_enableProxy,
                            man_use_cowmaster: this.serverConfig.man_use_cowmaster,
                            hon_install_directory: this.serverConfig.hon_install_directory,
                            hon_home_directory: this.serverConfig.hon_home_directory,
                            // Host Credentials
                            svr_login: this.serverConfig.svr_login,
                            svr_password: this.serverConfig.svr_password,
                            // Discord Bot Settings
                            discord_bot_token: this.serverConfig.discord_bot_token,
                            discord_owner_id: this.serverConfig.discord_owner_id,
                            discord_notification_channel_id: this.serverConfig.discord_notification_channel_id,
                            discord_enable_notifications: this.serverConfig.discord_enable_notifications,
                            discord_notify_match_start: this.serverConfig.discord_notify_match_start,
                            discord_notify_match_end: this.serverConfig.discord_notify_match_end,
                            discord_notify_player_join_leave: this.serverConfig.discord_notify_player_join_leave
                        };
                        
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/config/full`,
                            { 
                                method: 'POST',
                                body: JSON.stringify(configPayload)
                            }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            alert('Configuration saved successfully!');
                            // Update simple vars
                            this.proxyEnabled = this.serverConfig.man_enableProxy;
                            this.basePort = this.serverConfig.svr_starting_gamePort;
                            this.maxPlayers = this.serverConfig.svr_maxClients;
                            this.targetServers = this.serverConfig.svr_total;
                            await this.refreshServerDetails();
                        } else {
                            alert(data.error || 'Failed to save configuration');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                async sendBroadcast() {
                    if (!this.broadcastMessage) return;
                    
                    this.controlLoading = true;
                    try {
                        const res = await this.apiCall(
                            `/api/servers/${this.selectedServer.serverId}/broadcast`,
                            { 
                                method: 'POST',
                                body: JSON.stringify({ message: this.broadcastMessage })
                            }
                        );
                        const data = await res.json();
                        if (res.ok) {
                            alert('Message sent!');
                            this.broadcastMessage = '';
                            this.showBroadcastModal = false;
                        } else {
                            alert(data.error || 'Failed to send message');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.controlLoading = false;
                    }
                },

                get filteredInstances() {
                    // Use statusData computed property (liveData first, then cachedStatus)
                    let instances = this.statusData?.instances || [];
                    
                    console.log('filteredInstances - statusData:', this.statusData);
                    console.log('filteredInstances - instances:', instances);
                    
                    if (this.instanceFilter !== 'all') {
                        instances = instances.filter(i => {
                            const status = (i.status || '').toLowerCase();
                            return status === this.instanceFilter.toLowerCase();
                        });
                    }
                    
                    if (this.instanceSearch) {
                        const search = this.instanceSearch.toLowerCase();
                        instances = instances.filter(i => 
                            (i.name || '').toLowerCase().includes(search) ||
                            (i.id || '').toString().includes(search) ||
                            (i.port || '').toString().includes(search)
                        );
                    }
                    
                    return instances;
                },

                get sortedInstances() {
                    let instances = [...this.filteredInstances];
                    
                    instances.sort((a, b) => {
                        let valA, valB;
                        
                        switch (this.instanceSort) {
                            case 'id':
                                valA = a.id || 0;
                                valB = b.id || 0;
                                break;
                            case 'status':
                                valA = a.status || '';
                                valB = b.status || '';
                                break;
                            case 'port':
                                valA = a.port || 0;
                                valB = b.port || 0;
                                break;
                            case 'players':
                                valA = a.num_clients ?? a.numClients ?? 0;
                                valB = b.num_clients ?? b.numClients ?? 0;
                                break;
                            case 'uptime':
                                valA = a.start_time ? new Date(a.start_time).getTime() : 0;
                                valB = b.start_time ? new Date(b.start_time).getTime() : 0;
                                break;
                            default:
                                valA = a.id || 0;
                                valB = b.id || 0;
                        }
                        
                        if (typeof valA === 'string') {
                            return this.instanceSortAsc 
                                ? valA.localeCompare(valB) 
                                : valB.localeCompare(valA);
                        }
                        
                        return this.instanceSortAsc ? valA - valB : valB - valA;
                    });
                    
                    return instances;
                },

                toggleSort(field) {
                    if (this.instanceSort === field) {
                        this.instanceSortAsc = !this.instanceSortAsc;
                    } else {
                        this.instanceSort = field;
                        this.instanceSortAsc = true;
                    }
                },

                // Helper to check status case-insensitively
                isStatus(instance, status) {
                    const s = (instance?.status || '').toLowerCase();
                    return s === status.toLowerCase();
                },

                // Helper to check if status is one of multiple values
                isStatusAny(instance, ...statuses) {
                    const s = (instance?.status || '').toLowerCase();
                    return statuses.some(status => s === status.toLowerCase());
                },

                // Get CSS class for status indicator dot
                getStatusDotClass(instance) {
                    const s = (instance?.status || '').toLowerCase();
                    if (s === 'ready') return 'bg-green-400';
                    if (s === 'occupied') return 'bg-yellow-400';
                    if (s === 'offline' || s === 'stopped') return 'bg-gray-500';
                    if (s === 'starting') return 'bg-blue-400 animate-pulse';
                    return 'bg-gray-500';
                },

                // Get CSS class for status badge
                getStatusBadgeClass(instance) {
                    const s = (instance?.status || '').toLowerCase();
                    if (s === 'ready') return 'bg-green-500/20 text-green-400';
                    if (s === 'occupied') return 'bg-yellow-500/20 text-yellow-400';
                    if (s === 'offline' || s === 'stopped') return 'bg-gray-500/20 text-gray-400';
                    if (s === 'starting') return 'bg-blue-500/20 text-blue-400';
                    return 'bg-gray-500/20 text-gray-400';
                },

                // Get CSS class for status glow dot (grid view)
                getStatusGlowClass(instance) {
                    const s = (instance?.status || '').toLowerCase();
                    if (s === 'ready') return 'bg-green-400 shadow-[0_0_10px_rgba(74,222,128,0.5)]';
                    if (s === 'occupied') return 'bg-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.5)]';
                    if (s === 'offline' || s === 'stopped') return 'bg-gray-500';
                    if (s === 'starting') return 'bg-blue-400 animate-pulse';
                    return 'bg-gray-500';
                },

                // Check if start button should be disabled
                isStartDisabled(instance) {
                    return this.controlLoading || this.isStatusAny(instance, 'ready', 'occupied');
                },

                // Check if stop button should be disabled (with player protection)
                isStopDisabled(instance) {
                    if (this.controlLoading) return true;
                    if (this.isStatusAny(instance, 'offline', 'stopped')) return true;
                    return false; // Don't disable, but will show warning if players present
                },
                
                // Check if restart button should be disabled
                isRestartDisabled(instance) {
                    if (this.controlLoading) return true;
                    if (this.isStatusAny(instance, 'offline', 'stopped')) return true;
                    return false;
                },
                
                // Check if instance has active players
                hasActivePlayers(instance) {
                    const players = instance.num_clients ?? instance.numClients ?? 0;
                    return players > 0;
                },
                
                // Check if instance is in a game
                isInGame(instance) {
                    const status = (instance.status || '').toLowerCase();
                    const phase = (instance.game_phase || instance.gamePhase || '').toLowerCase();
                    return status === 'occupied' || 
                           phase === 'playing' || 
                           phase === 'in game' || 
                           phase === 'ingame' || 
                           phase === 'active' ||
                           phase === 'picking' ||
                           phase === 'banning' ||
                           phase === 'loading';
                },
                
                // Check if instance is sleeping
                isSleeping(instanceId) {
                    return !!this.sleepingInstances[instanceId];
                },
                
                // Get sleep status text
                getSleepStatus(instanceId) {
                    const sleep = this.sleepingInstances[instanceId];
                    if (!sleep) return null;
                    const since = new Date(sleep.sleepingSince).toLocaleTimeString();
                    return `Sleeping since ${since}`;
                },

                getPhaseClass(phase) {
                    const p = (phase || 'idle').toLowerCase();
                    
                    if (p === 'idle' || p === '-' || !p) {
                        return 'bg-gray-500/20 text-gray-400';
                    }
                    if (p === 'lobby' || p === 'waiting') {
                        return 'bg-yellow-500/20 text-yellow-400';
                    }
                    if (p === 'loading' || p === 'picking' || p === 'banning') {
                        return 'bg-blue-500/20 text-blue-400';
                    }
                    if (p === 'playing' || p === 'in game' || p === 'ingame' || p === 'active') {
                        return 'bg-green-500/20 text-green-400';
                    }
                    if (p === 'ending' || p === 'ended' || p === 'finished') {
                        return 'bg-orange-500/20 text-orange-400';
                    }
                    if (p === 'crashed' || p === 'error') {
                        return 'bg-red-500/20 text-red-400';
                    }
                    
                    return 'bg-purple-500/20 text-purple-400';
                },

                formatInstanceUptime(startTime) {
                    if (!startTime) return '-';
                    
                    const start = new Date(startTime);
                    const now = new Date();
                    const diffMs = now - start;
                    
                    if (diffMs < 0) return '-';
                    
                    const diffSeconds = Math.floor(diffMs / 1000);
                    const minutes = Math.floor(diffSeconds / 60);
                    const seconds = diffSeconds % 60;
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    
                    if (hours > 0) {
                        return `${hours}h ${mins}m`;
                    }
                    return `${mins}m ${seconds}s`;
                },

                formatUptime(uptime) {
                    if (!uptime) return '-';
                    // If it's already a string like "0d 0h 21m", return as is
                    if (typeof uptime === 'string') {
                        return uptime;
                    }
                    // If it's seconds, format it
                    const hours = Math.floor(uptime / 3600);
                    const minutes = Math.floor((uptime % 3600) / 60);
                    if (hours > 24) {
                        const days = Math.floor(hours / 24);
                        return `${days}d ${hours % 24}h`;
                    }
                    return `${hours}h ${minutes}m`;
                },

                // Calculate max allowed servers based on CPU count
                // Reserves some CPUs for OS/Manager: <=4 cores: 1 reserved, 5-12: 2 reserved, >12: 4 reserved
                getMaxServers(cpuCount, serversPerCore = 1) {
                    if (!cpuCount || cpuCount <= 0) return 0;
                    let reserved = 1;
                    if (cpuCount > 4 && cpuCount <= 12) reserved = 2;
                    else if (cpuCount > 12) reserved = 4;
                    return Math.max(0, (cpuCount * serversPerCore) - reserved);
                },

                // Get color for target server count based on comparison with max allowed
                getSvrTargetColor(statusData) {
                    const target = statusData?.system_stats?.svr_total || statusData?.systemStats?.svrTotal || 0;
                    const maxAllowed = statusData?.system_stats?.max_allowed_servers || statusData?.systemStats?.maxAllowedServers || 0;
                    const running = statusData?.running_servers || statusData?.runningServers || 0;
                    
                    if (target > maxAllowed) return 'text-red-400';  // Target exceeds max
                    if (running < target) return 'text-yellow-400';  // Not all targets running
                    return 'text-green-400';  // All good
                },

                closeModals() {
                    this.showAddModal = false;
                    this.showEditModal = false;
                    this.formError = '';
                    this.serverForm = {
                        serverName: '',
                        ipAddress: '',
                        apiPort: 5050,
                        region: 'Unknown'
                    };
                },

                // ==================== REPLAYS MANAGEMENT ====================
                async loadReplays() {
                    if (!this.selectedServer) return;
                    
                    this.replaysLoading = true;
                    try {
                        // Load replays list from the correct endpoint
                        const res = await this.apiCall(`/api/replays/upload?count=100`);
                        if (res.ok) {
                            const data = await res.json();
                            this.replays = data.replays || [];
                        }
                        
                        // Load replay stats
                        const statsRes = await this.apiCall(`/api/replays/upload/stats`);
                        if (statsRes.ok) {
                            this.replayStats = await statsRes.json();
                        }
                    } catch (err) {
                        console.error('Failed to load replays:', err);
                    } finally {
                        this.replaysLoading = false;
                    }
                },

                async downloadReplay(filename) {
                    try {
                        const res = await this.apiCall(`/api/replays/download/${filename}`);
                        if (res.ok) {
                            const blob = await res.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            a.remove();
                        } else {
                            alert('Failed to download replay');
                        }
                    } catch (err) {
                        alert('Network error');
                    }
                },

                async deleteReplay(filename) {
                    if (!confirm(`Delete replay ${filename}?`)) return;
                    
                    try {
                        const res = await this.apiCall(`/api/replays/upload/${filename}`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            await this.loadReplays();
                        } else {
                            alert('Failed to delete replay');
                        }
                    } catch (err) {
                        alert('Network error');
                    }
                },

                async archiveReplays() {
                    const days = prompt('Archive replays older than how many days?', '30');
                    if (!days) return;
                    
                    const daysNum = parseInt(days);
                    if (isNaN(daysNum) || daysNum < 1) {
                        alert('Please enter a valid number of days');
                        return;
                    }
                    
                    if (!confirm(`Archive all replays older than ${daysNum} days?`)) return;
                    
                    this.replaysLoading = true;
                    try {
                        const res = await this.apiCall(`/api/replays/manage/archive?daysOld=${daysNum}`, {
                            method: 'POST'
                        });
                        const data = await res.json();
                        if (res.ok) {
                            alert(data.message || `Archived ${data.archived} replays`);
                            await this.loadReplays();
                        } else {
                            alert(data.error || 'Failed to archive replays');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.replaysLoading = false;
                    }
                },

                async cleanupReplays() {
                    const days = prompt('Delete archived replays older than how many days?', '90');
                    if (!days) return;
                    
                    const daysNum = parseInt(days);
                    if (isNaN(daysNum) || daysNum < 1) {
                        alert('Please enter a valid number of days');
                        return;
                    }
                    
                    if (!confirm(`Permanently delete all archived replays older than ${daysNum} days?\n\nThis cannot be undone!`)) return;
                    
                    this.replaysLoading = true;
                    try {
                        const res = await this.apiCall(`/api/replays/manage/cleanup?daysOld=${daysNum}`, {
                            method: 'POST'
                        });
                        const data = await res.json();
                        if (res.ok) {
                            alert(data.message || `Deleted ${data.deleted} archived replays`);
                            await this.loadReplays();
                        } else {
                            alert(data.error || 'Failed to cleanup replays');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.replaysLoading = false;
                    }
                },

                // ==================== STATISTICS ====================
                async loadStatistics() {
                    if (!this.selectedServer) return;
                    
                    this.statsLoading = true;
                    try {
                        // Load summary
                        const summaryRes = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/statistics/summary`);
                        if (summaryRes.ok) {
                            this.statsSummary = await summaryRes.json();
                        }
                        
                        // Load recent matches
                        const matchesRes = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/statistics/matches?limit=10`);
                        if (matchesRes.ok) {
                            const data = await matchesRes.json();
                            this.recentMatches = data.matches || data || [];
                        }
                        
                        // Load top players
                        const playersRes = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/statistics/players/top?limit=10`);
                        if (playersRes.ok) {
                            const data = await playersRes.json();
                            this.topPlayers = data.players || data || [];
                        }
                    } catch (err) {
                        console.error('Failed to load statistics:', err);
                    } finally {
                        this.statsLoading = false;
                    }
                },

                // ==================== LOGS ====================
                async loadLogs() {
                    if (!this.selectedServer) return;
                    
                    const instanceId = this.selectedLogInstance || (this.statusData?.instances?.[0]?.id || 1);
                    this.selectedLogInstance = instanceId;
                    
                    this.logsLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/logs/${instanceId}`);
                        if (res.ok) {
                            const data = await res.json();
                            this.serverLogs = data.logs || data.content || '';
                        }
                    } catch (err) {
                        console.error('Failed to load logs:', err);
                        this.serverLogs = 'Failed to load logs';
                    } finally {
                        this.logsLoading = false;
                    }
                },

                async downloadLogs() {
                    if (!this.selectedServer) return;
                    
                    const instanceId = this.selectedLogInstance || 1;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/logs/${instanceId}/download`);
                        if (res.ok) {
                            const blob = await res.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `server_${instanceId}_logs.txt`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            a.remove();
                        } else {
                            alert('Failed to download logs');
                        }
                    } catch (err) {
                        alert('Network error');
                    }
                },

                // ==================== HEALTH ====================
                async loadHealth() {
                    if (!this.selectedServer) return;
                    
                    this.healthLoading = true;
                    try {
                        // Load health checks
                        const checksRes = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/health/checks`);
                        if (checksRes.ok) {
                            const data = await checksRes.json();
                            this.healthChecks = data.checks || data || [];
                        }
                        
                        // Load system resources
                        const resourcesRes = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/health/resources`);
                        if (resourcesRes.ok) {
                            this.systemResources = await resourcesRes.json();
                        }
                    } catch (err) {
                        console.error('Failed to load health:', err);
                    } finally {
                        this.healthLoading = false;
                    }
                },

                async runHealthChecks() {
                    if (!this.selectedServer) return;
                    
                    this.healthLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/health/run`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            await this.loadHealth();
                        } else {
                            alert('Failed to run health checks');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.healthLoading = false;
                    }
                },

                // ==================== SYSTEM - PATCHING ====================
                async loadPatchStatus() {
                    if (!this.selectedServer) return;
                    
                    this.patchLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/patching/status`);
                        if (res.ok) {
                            this.patchStatus = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load patch status:', err);
                    } finally {
                        this.patchLoading = false;
                    }
                },

                async checkForPatches() {
                    if (!this.selectedServer) return;
                    
                    this.patchLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/patching/check`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            this.patchStatus = await res.json();
                        } else {
                            alert('Failed to check for patches');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.patchLoading = false;
                    }
                },

                async applyPatch() {
                    if (!this.selectedServer) return;
                    if (!confirm('Apply patch? This may restart game servers.')) return;
                    
                    this.patchLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/patching/apply`, {
                            method: 'POST'
                        });
                        const data = await res.json();
                        if (res.ok) {
                            alert(data.message || 'Patch applied successfully');
                            await this.loadPatchStatus();
                        } else {
                            alert(data.error || 'Failed to apply patch');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.patchLoading = false;
                    }
                },

                // ==================== SYSTEM - AUTOPING ====================
                async loadAutoPingStatus() {
                    if (!this.selectedServer) return;
                    
                    this.autoPingLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/autoping/status`);
                        if (res.ok) {
                            this.autoPingStatus = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load autoping status:', err);
                    } finally {
                        this.autoPingLoading = false;
                    }
                },

                async startAutoPing() {
                    if (!this.selectedServer) return;
                    
                    this.autoPingLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/autoping/start`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            this.autoPingStatus = await res.json();
                        } else {
                            alert('Failed to start autoping');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.autoPingLoading = false;
                    }
                },

                async stopAutoPing() {
                    if (!this.selectedServer) return;
                    
                    this.autoPingLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/autoping/stop`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            this.autoPingStatus = await res.json();
                        } else {
                            alert('Failed to stop autoping');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.autoPingLoading = false;
                    }
                },

                // ==================== SYSTEM - MQTT ====================
                async loadMqttStatus() {
                    if (!this.selectedServer) return;
                    
                    this.mqttLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/mqtt/status`);
                        if (res.ok) {
                            this.mqttStatus = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load MQTT status:', err);
                    } finally {
                        this.mqttLoading = false;
                    }
                },

                async connectMqtt() {
                    if (!this.selectedServer) return;
                    
                    this.mqttLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/mqtt/connect`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            this.mqttStatus = await res.json();
                        } else {
                            alert('Failed to connect MQTT');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.mqttLoading = false;
                    }
                },

                async disconnectMqtt() {
                    if (!this.selectedServer) return;
                    
                    this.mqttLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/mqtt/disconnect`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            this.mqttStatus = await res.json();
                        } else {
                            alert('Failed to disconnect MQTT');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.mqttLoading = false;
                    }
                },

                // ==================== SYSTEM - DISCORD ====================
                async loadDiscordStatus() {
                    if (!this.selectedServer) return;
                    
                    this.discordLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/discord/status`);
                        if (res.ok) {
                            this.discordStatus = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load Discord status:', err);
                    } finally {
                        this.discordLoading = false;
                    }
                },

                async testDiscordNotification() {
                    if (!this.selectedServer) return;
                    
                    this.discordLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/discord/test`, {
                            method: 'POST'
                        });
                        const data = await res.json();
                        if (res.ok) {
                            alert(data.message || 'Test notification sent!');
                        } else {
                            alert(data.error || 'Failed to send test notification');
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.discordLoading = false;
                    }
                },

                // ==================== SYSTEM - TASKS ====================
                async loadScheduledTasks() {
                    if (!this.selectedServer) return;
                    
                    this.tasksLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/tasks`);
                        if (res.ok) {
                            const data = await res.json();
                            this.scheduledTasks = data.tasks || data || [];
                        }
                    } catch (err) {
                        console.error('Failed to load scheduled tasks:', err);
                    } finally {
                        this.tasksLoading = false;
                    }
                },

                async runTask(taskName) {
                    if (!this.selectedServer) return;
                    
                    this.tasksLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/tasks/${encodeURIComponent(taskName)}/run`, {
                            method: 'POST'
                        });
                        const data = await res.json();
                        if (res.ok) {
                            alert(data.message || `Task ${taskName} executed`);
                        } else {
                            alert(data.error || `Failed to run task ${taskName}`);
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.tasksLoading = false;
                    }
                },

                async toggleTask(taskName, enable) {
                    if (!this.selectedServer) return;
                    
                    this.tasksLoading = true;
                    try {
                        const action = enable ? 'enable' : 'disable';
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/tasks/${encodeURIComponent(taskName)}/${action}`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            await this.loadScheduledTasks();
                        } else {
                            alert(`Failed to ${action} task`);
                        }
                    } catch (err) {
                        alert('Network error');
                    } finally {
                        this.tasksLoading = false;
                    }
                },

                // ==================== SYSTEM - CLI ====================
                async executeCliCommand() {
                    if (!this.selectedServer || !this.cliCommand.trim()) return;
                    
                    this.cliLoading = true;
                    try {
                        const parts = this.cliCommand.trim().split(/\s+/);
                        const command = parts[0];
                        const args = parts.slice(1);
                        
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/cli/execute`, {
                            method: 'POST',
                            body: JSON.stringify({ command, args })
                        });
                        const data = await res.json();
                        if (res.ok) {
                            this.cliOutput = data.output || data.result || JSON.stringify(data, null, 2);
                        } else {
                            this.cliOutput = `Error: ${data.error || 'Command failed'}`;
                        }
                    } catch (err) {
                        this.cliOutput = `Error: Network error`;
                    } finally {
                        this.cliLoading = false;
                        this.cliCommand = '';
                    }
                },

                // ==================== SYSTEM INFO LOADER ====================
                async loadSystemInfo() {
                    // Load all system tab data
                    await Promise.all([
                        this.loadPatchStatus(),
                        this.loadAutoPingStatus(),
                        this.loadMqttStatus(),
                        this.loadDiscordStatus(),
                        this.loadScheduledTasks()
                    ]);
                },

                // ==================== SCALING ====================
                async loadScalingStatus() {
                    if (!this.selectedServer) return;
                    
                    this.scalingLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/scaling/status`);
                        if (res.ok) {
                            this.scalingStatus = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load scaling status:', err);
                    } finally {
                        this.scalingLoading = false;
                    }
                },

                async scaleUp() {
                    if (!this.selectedServer) return;
                    
                    this.scalingLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/scaling/scale-up`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            await this.loadScalingStatus();
                            alert('Scale up initiated');
                        } else {
                            const err = await res.json();
                            alert(err.error || 'Failed to scale up');
                        }
                    } catch (err) {
                        alert('Failed to scale up');
                    } finally {
                        this.scalingLoading = false;
                    }
                },

                async scaleDown() {
                    if (!this.selectedServer) return;
                    if (!confirm('Are you sure you want to scale down?')) return;
                    
                    this.scalingLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/scaling/scale-down`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            await this.loadScalingStatus();
                            alert('Scale down initiated');
                        } else {
                            const err = await res.json();
                            alert(err.error || 'Failed to scale down');
                        }
                    } catch (err) {
                        alert('Failed to scale down');
                    } finally {
                        this.scalingLoading = false;
                    }
                },

                // ==================== CRASH PROTECTION ====================
                async loadCrashProtectionSettings() {
                    if (!this.selectedServer) return;
                    
                    this.crashProtectionLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/crash-protection`);
                        if (res.ok) {
                            const data = await res.json();
                            this.crashProtection = { ...this.crashProtection, ...data };
                        }
                    } catch (err) {
                        console.error('Failed to load crash protection settings:', err);
                    } finally {
                        this.crashProtectionLoading = false;
                    }
                },
                
                async saveCrashProtectionSettings() {
                    if (!this.selectedServer) return;
                    
                    this.crashProtectionLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/crash-protection`, {
                            method: 'PUT',
                            body: JSON.stringify(this.crashProtection)
                        });
                        if (res.ok) {
                            this.showToast('Crash protection settings saved', 'success');
                        } else {
                            const err = await res.json();
                            this.showToast(err.error || 'Failed to save settings', 'error');
                        }
                    } catch (err) {
                        this.showToast('Failed to save crash protection settings', 'error');
                    } finally {
                        this.crashProtectionLoading = false;
                    }
                },
                
                async loadCrashHistory() {
                    if (!this.selectedServer) return;
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/crash-protection/history`);
                        if (res.ok) {
                            this.crashHistory = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load crash history:', err);
                    }
                },
                
                async manualRestartCrashedInstance(instanceId) {
                    if (!this.selectedServer) return;
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/instances/${instanceId}/start`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            this.showToast(`Instance #${instanceId} restart initiated`, 'success');
                            // Mark as recovered in local history
                            const event = this.crashHistory.find(c => c.instanceId === instanceId && c.type === 'crash' && !c.recovered);
                            if (event) {
                                event.recovered = true;
                            }
                            // Add restart event to history
                            this.crashHistory.unshift({
                                id: Date.now(),
                                instanceId: instanceId,
                                type: 'restart',
                                message: 'Manual restart initiated',
                                timestamp: new Date().toISOString(),
                                recovered: false
                            });
                            await this.refreshServerDetails();
                        } else {
                            const err = await res.json();
                            this.showToast(err.error || 'Failed to restart instance', 'error');
                        }
                    } catch (err) {
                        this.showToast('Failed to restart instance', 'error');
                    }
                },
                
                dismissCrashEvent(eventId) {
                    const index = this.crashHistory.findIndex(e => e.id === eventId);
                    if (index !== -1) {
                        this.crashHistory[index].recovered = true;
                    }
                },
                
                async clearCrashHistory() {
                    if (!confirm('Clear all crash history? This cannot be undone.')) return;
                    
                    if (!this.selectedServer) return;
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/crash-protection/history`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            this.crashHistory = [];
                            this.showToast('Crash history cleared', 'success');
                        }
                    } catch (err) {
                        // Just clear locally if API fails
                        this.crashHistory = [];
                    }
                },
                
                formatTimeAgo(timestamp) {
                    if (!timestamp) return '';
                    const now = new Date();
                    const time = new Date(timestamp);
                    const diff = Math.floor((now - time) / 1000);
                    
                    if (diff < 60) return 'Just now';
                    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
                    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
                    return Math.floor(diff / 86400) + 'd ago';
                },
                
                // Monitor crashed instances (called by auto-refresh)
                checkForCrashedInstances() {
                    if (!this.crashProtection.enabled || !this.statusData?.instances) return;
                    
                    const crashedInstances = this.statusData.instances.filter(i => 
                        i.status === 'Crashed' || i.status === 'CRASHED'
                    );
                    
                    for (const instance of crashedInstances) {
                        // Check if already in history
                        const existing = this.crashHistory.find(c => 
                            c.instanceId === instance.id && 
                            c.type === 'crash' && 
                            !c.recovered &&
                            (Date.now() - new Date(c.timestamp).getTime()) < 300000 // Within 5 minutes
                        );
                        
                        if (!existing) {
                            // Add to crash history
                            this.crashHistory.unshift({
                                id: Date.now(),
                                instanceId: instance.id,
                                type: 'crash',
                                message: `Instance crashed unexpectedly`,
                                timestamp: new Date().toISOString(),
                                recovered: false
                            });
                            
                            // Notify if enabled
                            if (this.crashProtection.notifyOnCrash) {
                                this.showToast(`âš ï¸ Instance #${instance.id} has crashed!`, 'error');
                            }
                            
                            // Auto-restart if enabled
                            if (this.crashProtection.autoRestartEnabled) {
                                this.autoRestartInstance(instance.id);
                            }
                        }
                    }
                },
                
                async autoRestartInstance(instanceId) {
                    // Check restart attempts
                    const recentRestarts = this.crashHistory.filter(c => 
                        c.instanceId === instanceId && 
                        c.type === 'restart' &&
                        (Date.now() - new Date(c.timestamp).getTime()) < 300000 // Within 5 minutes
                    );
                    
                    if (recentRestarts.length >= this.crashProtection.maxRestartAttempts) {
                        this.showToast(`Instance #${instanceId} exceeded max restart attempts`, 'error');
                        return;
                    }
                    
                    // Wait for cooldown
                    await new Promise(resolve => setTimeout(resolve, this.crashProtection.restartCooldownSeconds * 1000));
                    
                    // Attempt restart
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/instances/${instanceId}/start`, {
                            method: 'POST'
                        });
                        
                        if (res.ok) {
                            // Add restart event
                            this.crashHistory.unshift({
                                id: Date.now(),
                                instanceId: instanceId,
                                type: 'restart',
                                message: `Auto-restart attempt ${recentRestarts.length + 1}/${this.crashProtection.maxRestartAttempts}`,
                                timestamp: new Date().toISOString(),
                                recovered: false
                            });
                            
                            if (this.crashProtection.notifyOnRestart) {
                                this.showToast(`ðŸ”„ Auto-restarting instance #${instanceId}...`, 'info');
                            }
                            
                            // Mark crash as recovered
                            const crashEvent = this.crashHistory.find(c => 
                                c.instanceId === instanceId && c.type === 'crash' && !c.recovered
                            );
                            if (crashEvent) {
                                crashEvent.recovered = true;
                            }
                        }
                    } catch (err) {
                        console.error('Auto-restart failed:', err);
                    }
                },

                // ==================== TEMPLATES ====================
                async loadTemplates() {
                    if (!this.selectedServer) return;
                    
                    this.templatesLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/templates`);
                        if (res.ok) {
                            this.templates = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load templates:', err);
                    } finally {
                        this.templatesLoading = false;
                    }
                },

                async applyTemplate(templateId) {
                    if (!this.selectedServer) return;
                    if (!confirm('Apply this template? This will update server configuration.')) return;
                    
                    this.templatesLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/templates/${templateId}/apply`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            alert('Template applied successfully');
                            await this.refreshServerDetails();
                        } else {
                            const err = await res.json();
                            alert(err.error || 'Failed to apply template');
                        }
                    } catch (err) {
                        alert('Failed to apply template');
                    } finally {
                        this.templatesLoading = false;
                    }
                },

                async deleteTemplate(templateId) {
                    if (!this.selectedServer) return;
                    if (!confirm('Delete this template?')) return;
                    
                    this.templatesLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/templates/${templateId}`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            this.templates = this.templates.filter(t => t.id !== templateId);
                        } else {
                            const err = await res.json();
                            alert(err.error || 'Failed to delete template');
                        }
                    } catch (err) {
                        alert('Failed to delete template');
                    } finally {
                        this.templatesLoading = false;
                    }
                },

                // ==================== NOTIFICATIONS & ALERTS ====================
                async loadNotifications() {
                    if (!this.selectedServer) return;
                    
                    this.notificationsLoading = true;
                    try {
                        const [notifRes, unackRes, threshRes] = await Promise.all([
                            this.apiCall(`/api/servers/${this.selectedServer.serverId}/notifications`),
                            this.apiCall(`/api/servers/${this.selectedServer.serverId}/notifications/unacknowledged`),
                            this.apiCall(`/api/servers/${this.selectedServer.serverId}/notifications/thresholds`)
                        ]);
                        
                        if (notifRes.ok) {
                            this.notifications = await notifRes.json();
                        }
                        if (unackRes.ok) {
                            const unack = await unackRes.json();
                            this.unacknowledgedCount = Array.isArray(unack) ? unack.length : 0;
                        }
                        if (threshRes.ok) {
                            this.alertThresholds = await threshRes.json();
                        }
                    } catch (err) {
                        console.error('Failed to load notifications:', err);
                    } finally {
                        this.notificationsLoading = false;
                    }
                },

                async loadThresholds() {
                    if (!this.selectedServer) return;
                    
                    this.notificationsLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/notifications/thresholds`);
                        if (res.ok) {
                            this.alertThresholds = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load thresholds:', err);
                    } finally {
                        this.notificationsLoading = false;
                    }
                },

                async acknowledgeNotification(notificationId) {
                    if (!this.selectedServer) return;
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/notifications/acknowledge`, {
                            method: 'POST',
                            body: JSON.stringify({ notificationId })
                        });
                        if (res.ok) {
                            const notif = this.notifications.find(n => n.id === notificationId);
                            if (notif) notif.acknowledged = true;
                            this.unacknowledgedCount = Math.max(0, this.unacknowledgedCount - 1);
                        }
                    } catch (err) {
                        console.error('Failed to acknowledge notification:', err);
                    }
                },

                async clearNotifications() {
                    if (!this.selectedServer) return;
                    if (!confirm('Clear all notifications?')) return;
                    
                    this.notificationsLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/notifications`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            this.notifications = [];
                            this.unacknowledgedCount = 0;
                        }
                    } catch (err) {
                        console.error('Failed to clear notifications:', err);
                    } finally {
                        this.notificationsLoading = false;
                    }
                },

                async updateThresholds() {
                    if (!this.selectedServer || !this.alertThresholds) return;
                    
                    this.notificationsLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/notifications/thresholds`, {
                            method: 'PUT',
                            body: JSON.stringify(this.alertThresholds)
                        });
                        if (res.ok) {
                            alert('Thresholds updated successfully');
                        } else {
                            const err = await res.json();
                            alert(err.error || 'Failed to update thresholds');
                        }
                    } catch (err) {
                        alert('Failed to update thresholds');
                    } finally {
                        this.notificationsLoading = false;
                    }
                },

                // ==================== WEBHOOKS ====================
                async loadWebhooks() {
                    if (!this.selectedServer) return;
                    
                    this.webhooksLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/webhooks`);
                        if (res.ok) {
                            this.webhooks = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load webhooks:', err);
                    } finally {
                        this.webhooksLoading = false;
                    }
                },

                async registerWebhook() {
                    if (!this.selectedServer || !this.newWebhookUrl) return;
                    
                    this.webhooksLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/webhooks`, {
                            method: 'POST',
                            body: JSON.stringify({
                                url: this.newWebhookUrl,
                                events: this.newWebhookEvents
                            })
                        });
                        if (res.ok) {
                            const newHook = await res.json();
                            this.webhooks.push(newHook);
                            this.newWebhookUrl = '';
                            this.newWebhookEvents = [];
                        } else {
                            const err = await res.json();
                            alert(err.error || 'Failed to register webhook');
                        }
                    } catch (err) {
                        alert('Failed to register webhook');
                    } finally {
                        this.webhooksLoading = false;
                    }
                },

                async testWebhook(webhookId) {
                    if (!this.selectedServer) return;
                    
                    this.webhooksLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/webhooks/${webhookId}/test`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            alert('Test webhook sent');
                        } else {
                            const err = await res.json();
                            alert(err.error || 'Failed to test webhook');
                        }
                    } catch (err) {
                        alert('Failed to test webhook');
                    } finally {
                        this.webhooksLoading = false;
                    }
                },

                async deleteWebhook(webhookId) {
                    if (!this.selectedServer) return;
                    if (!confirm('Delete this webhook?')) return;
                    
                    this.webhooksLoading = true;
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/webhooks/${webhookId}`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            this.webhooks = this.webhooks.filter(w => w.id !== webhookId);
                        } else {
                            const err = await res.json();
                            alert(err.error || 'Failed to delete webhook');
                        }
                    } catch (err) {
                        alert('Failed to delete webhook');
                    } finally {
                        this.webhooksLoading = false;
                    }
                },

                // ==================== CHARTS ====================
                async loadCharts() {
                    if (!this.selectedServer) return;
                    
                    this.chartsLoading = true;
                    try {
                        const [uptimeRes, playersRes, matchesRes] = await Promise.all([
                            this.apiCall(`/api/servers/${this.selectedServer.serverId}/charts/uptime?days=${this.chartDays}`),
                            this.apiCall(`/api/servers/${this.selectedServer.serverId}/charts/players?days=${this.chartDays}`),
                            this.apiCall(`/api/servers/${this.selectedServer.serverId}/charts/matches?days=${this.chartDays}`)
                        ]);
                        
                        if (uptimeRes.ok) {
                            this.chartsData.uptime = await uptimeRes.json();
                        }
                        if (playersRes.ok) {
                            this.chartsData.players = await playersRes.json();
                        }
                        if (matchesRes.ok) {
                            this.chartsData.matches = await matchesRes.json();
                        }
                    } catch (err) {
                        console.error('Failed to load charts:', err);
                    } finally {
                        this.chartsLoading = false;
                    }
                },

                // ==================== ACCESS MANAGEMENT ====================
                async loadServerAccess() {
                    if (!this.selectedServer) return;
                    
                    this.accessLoading = true;
                    try {
                        const res = await this.apiCall(`/api/my-servers/${this.selectedServer.serverId}/access`);
                        if (res.ok) {
                            this.serverAccessList = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load access list:', err);
                    } finally {
                        this.accessLoading = false;
                    }
                },

                async addAccess() {
                    if (!this.addAccessForm.discordId) {
                        this.accessFormError = 'Discord ID is required';
                        return;
                    }

                    this.accessFormLoading = true;
                    this.accessFormError = '';

                    try {
                        const res = await this.apiCall(`/api/my-servers/${this.selectedServer.serverId}/access`, {
                            method: 'POST',
                            body: JSON.stringify({
                                discord_id: this.addAccessForm.discordId,
                                role: parseInt(this.addAccessForm.role)
                            })
                        });

                        if (res.ok) {
                            const newAccess = await res.json();
                            this.serverAccessList.push(newAccess);
                            this.showAddAccessModal = false;
                            this.addAccessForm = { discordId: '', role: 0 };
                        } else {
                            const err = await res.json();
                            this.accessFormError = err.error || 'Failed to add access';
                        }
                    } catch (err) {
                        this.accessFormError = 'Network error';
                    } finally {
                        this.accessFormLoading = false;
                    }
                },

                async updateAccessRole(access) {
                    try {
                        const res = await this.apiCall(`/api/my-servers/${this.selectedServer.serverId}/access/${access.id}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                role: parseInt(access.role)
                            })
                        });

                        if (!res.ok) {
                            // Revert on error
                            await this.loadServerAccess();
                            alert('Failed to update role');
                        }
                    } catch (err) {
                        await this.loadServerAccess();
                        alert('Failed to update role');
                    }
                },

                async removeAccess(access) {
                    if (!confirm(`Remove access for ${access.username || access.discordId}?`)) {
                        return;
                    }

                    try {
                        const res = await this.apiCall(`/api/my-servers/${this.selectedServer.serverId}/access/${access.id}`, {
                            method: 'DELETE'
                        });

                        if (res.ok) {
                            this.serverAccessList = this.serverAccessList.filter(a => a.id !== access.id);
                        } else {
                            alert('Failed to remove access');
                        }
                    } catch (err) {
                        alert('Failed to remove access');
                    }
                },

                // ==================== SUPERADMIN PANEL ====================
                async loadAdminUsers() {
                    this.adminLoading = true;
                    try {
                        const res = await this.apiCall('/api/admin/users');
                        if (res.ok) {
                            this.adminUsers = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load admin users:', err);
                    } finally {
                        this.adminLoading = false;
                    }
                },

                async toggleSuperAdmin(targetUser) {
                    const newStatus = !targetUser.isSuperAdmin;
                    const action = newStatus ? 'grant SuperAdmin to' : 'remove SuperAdmin from';
                    
                    if (!confirm(`Are you sure you want to ${action} ${targetUser.username}?`)) {
                        return;
                    }

                    try {
                        const res = await this.apiCall(`/api/admin/users/${targetUser.id}/superadmin`, {
                            method: 'PUT',
                            body: JSON.stringify({ is_super_admin: newStatus })
                        });

                        if (res.ok) {
                            targetUser.isSuperAdmin = newStatus;
                        } else {
                            const err = await res.json();
                            alert(err.error || 'Failed to update SuperAdmin status');
                        }
                    } catch (err) {
                        alert('Failed to update SuperAdmin status');
                    }
                },

                // ==================== CONSOLE ====================
                async loadConsoleLogs() {
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/console/logs`);
                        if (res.ok) {
                            const logs = await res.json();
                            // Keep local logs and merge with server logs
                            const serverLogs = logs.map(l => ({
                                ...l,
                                id: l.id || Date.now() + Math.random(),
                                type: l.type || 'output'
                            }));
                            // Only add server logs that aren't already in consoleLogs
                            this.consoleLogs = [...this.consoleLogs.filter(l => l.local), ...serverLogs];
                            this.$nextTick(() => {
                                const el = document.getElementById('console-output');
                                if (el) el.scrollTop = el.scrollHeight;
                            });
                        }
                    } catch (err) {
                        console.error('Failed to load console logs:', err);
                    }
                },

                addConsoleLog(message, type = 'output') {
                    this.consoleLogs.push({
                        id: Date.now() + Math.random(),
                        time: new Date().toLocaleTimeString(),
                        message,
                        type,
                        local: true
                    });
                    this.$nextTick(() => {
                        const el = document.getElementById('console-output');
                        if (el) el.scrollTop = el.scrollHeight;
                    });
                },

                clearConsole() {
                    this.consoleLogs = [];
                    this.addConsoleLog('Console cleared', 'info');
                },

                navigateCommandHistory(direction) {
                    if (this.consoleCommandHistory.length === 0) return;
                    
                    this.consoleHistoryIndex += direction;
                    
                    if (this.consoleHistoryIndex < 0) {
                        this.consoleHistoryIndex = -1;
                        this.consoleCommand = '';
                    } else if (this.consoleHistoryIndex >= this.consoleCommandHistory.length) {
                        this.consoleHistoryIndex = this.consoleCommandHistory.length - 1;
                    } else {
                        this.consoleCommand = this.consoleCommandHistory[this.consoleHistoryIndex];
                    }
                },

                async executeConsoleCommand() {
                    const cmd = this.consoleCommand.trim();
                    if (!cmd) return;
                    
                    // Add to history
                    this.consoleCommandHistory.unshift(cmd);
                    if (this.consoleCommandHistory.length > 50) this.consoleCommandHistory.pop();
                    this.consoleHistoryIndex = -1;
                    
                    // Log the command
                    this.addConsoleLog(cmd, 'command');
                    this.consoleCommand = '';
                    
                    // Parse command
                    const parts = cmd.toLowerCase().split(/\s+/);
                    const command = parts[0];
                    const args = parts.slice(1);
                    
                    try {
                        switch (command) {
                            case 'help':
                                this.showConsoleHelp = true;
                                this.addConsoleLog('Showing help panel above...', 'info');
                                break;
                                
                            case 'clear':
                                this.clearConsole();
                                break;
                                
                            case 'refresh':
                                await this.refreshServerDetails();
                                this.addConsoleLog('Server data refreshed', 'success');
                                break;
                                
                            case 'start':
                                await this.handleStartCommand(args);
                                break;
                                
                            case 'stop':
                                await this.handleStopCommand(args);
                                break;
                                
                            case 'restart':
                                await this.handleRestartCommand(args);
                                break;
                                
                            case 'startall':
                                await this.handleStartAllCommand();
                                break;
                                
                            case 'stopall':
                                await this.handleStopAllCommand();
                                break;
                                
                            case 'status':
                                this.handleStatusCommand(args);
                                break;
                                
                            case 'list':
                            case 'ls':
                                this.handleListCommand();
                                break;
                                
                            case 'info':
                                this.handleInfoCommand();
                                break;
                                
                            case 'say':
                            case 'broadcast':
                                await this.handleSayCommand(args, cmd);
                                break;
                                
                            case 'sleep':
                                await this.handleSleepCommand(args);
                                break;
                                
                            case 'wake':
                            case 'cancel':
                                this.handleWakeCommand(args);
                                break;
                                
                            case 'sleeping':
                                this.handleSleepingCommand();
                                break;
                            
                            case 'reset':
                            case 'kick':
                                await this.handleResetCommand(args);
                                break;

                            default:
                                // Send to server as raw command
                                await this.sendRawConsoleCommand(cmd);
                        }
                    } catch (err) {
                        this.addConsoleLog(`Error: ${err.message}`, 'error');
                    }
                },

                async handleStartCommand(args) {
                    if (args.length === 0) {
                        this.addConsoleLog('Usage: start [instance_id]', 'warning');
                        this.addConsoleLog('Example: start 1', 'info');
                        return;
                    }
                    
                    const id = parseInt(args[0]);
                    if (isNaN(id)) {
                        this.addConsoleLog(`Invalid instance ID: ${args[0]}`, 'error');
                        return;
                    }
                    
                    this.addConsoleLog(`Starting instance #${id}...`, 'info');
                    
                    const res = await this.apiCall(
                        `/api/servers/${this.selectedServer.serverId}/instances/${id}/start`,
                        { method: 'POST' }
                    );
                    
                    if (res.ok) {
                        this.addConsoleLog(`âœ“ Instance #${id} started successfully`, 'success');
                        await this.refreshServerDetails();
                    } else {
                        const err = await res.json();
                        this.addConsoleLog(`âœ— Failed to start instance #${id}: ${err.error || 'Unknown error'}`, 'error');
                    }
                },

                async handleStopCommand(args) {
                    if (args.length === 0) {
                        this.addConsoleLog('Usage: stop [instance_id]', 'warning');
                        this.addConsoleLog('Example: stop 1', 'info');
                        return;
                    }
                    
                    const id = parseInt(args[0]);
                    if (isNaN(id)) {
                        this.addConsoleLog(`Invalid instance ID: ${args[0]}`, 'error');
                        return;
                    }
                    
                    this.addConsoleLog(`Stopping instance #${id}...`, 'info');
                    
                    const res = await this.apiCall(
                        `/api/servers/${this.selectedServer.serverId}/instances/${id}/stop`,
                        { method: 'POST' }
                    );
                    
                    if (res.ok) {
                        this.addConsoleLog(`âœ“ Instance #${id} stopped successfully`, 'success');
                        await this.refreshServerDetails();
                    } else {
                        const err = await res.json();
                        this.addConsoleLog(`âœ— Failed to stop instance #${id}: ${err.error || 'Unknown error'}`, 'error');
                    }
                },

                async handleRestartCommand(args) {
                    if (args.length === 0) {
                        this.addConsoleLog('Usage: restart [instance_id]', 'warning');
                        this.addConsoleLog('Example: restart 1', 'info');
                        return;
                    }
                    
                    const id = parseInt(args[0]);
                    if (isNaN(id)) {
                        this.addConsoleLog(`Invalid instance ID: ${args[0]}`, 'error');
                        return;
                    }
                    
                    this.addConsoleLog(`Restarting instance #${id}...`, 'info');
                    
                    const res = await this.apiCall(
                        `/api/servers/${this.selectedServer.serverId}/instances/${id}/restart`,
                        { method: 'POST' }
                    );
                    
                    if (res.ok) {
                        this.addConsoleLog(`âœ“ Instance #${id} restarted successfully`, 'success');
                        await this.refreshServerDetails();
                    } else {
                        const err = await res.json();
                        this.addConsoleLog(`âœ— Failed to restart instance #${id}: ${err.error || 'Unknown error'}`, 'error');
                    }
                },

                async handleStartAllCommand() {
                    const instances = this.statusData?.instances || [];
                    const offline = instances.filter(i => i.status === 'Offline' || i.status === 'OFFLINE' || i.status === 'Crashed' || i.status === 'CRASHED');
                    
                    if (offline.length === 0) {
                        this.addConsoleLog('All instances are already running', 'info');
                        return;
                    }
                    
                    this.addConsoleLog(`Starting ${offline.length} offline instances...`, 'info');
                    
                    for (const inst of offline) {
                        await this.handleStartCommand([inst.id.toString()]);
                        await new Promise(r => setTimeout(r, 500)); // Small delay between starts
                    }
                    
                    this.addConsoleLog(`Finished starting instances`, 'success');
                },

                async handleStopAllCommand() {
                    const instances = this.statusData?.instances || [];
                    const running = instances.filter(i => i.status !== 'Offline' && i.status !== 'OFFLINE');
                    
                    if (running.length === 0) {
                        this.addConsoleLog('All instances are already stopped', 'info');
                        return;
                    }
                    
                    this.addConsoleLog(`Stopping ${running.length} running instances...`, 'warning');
                    
                    for (const inst of running) {
                        await this.handleStopCommand([inst.id.toString()]);
                        await new Promise(r => setTimeout(r, 300));
                    }
                    
                    this.addConsoleLog(`Finished stopping instances`, 'success');
                },

                handleStatusCommand(args) {
                    const instances = this.statusData?.instances || [];
                    
                    if (args.length > 0) {
                        const id = parseInt(args[0]);
                        const inst = instances.find(i => i.id === id);
                        
                        if (!inst) {
                            this.addConsoleLog(`Instance #${id} not found`, 'error');
                            return;
                        }
                        
                        this.addConsoleLog(`â”€â”€â”€ Instance #${inst.id} â”€â”€â”€`, 'info');
                        this.addConsoleLog(`  Status: <span class="${this.getStatusColor(inst.status)}">${inst.status}</span>`, 'output');
                        this.addConsoleLog(`  Port: ${inst.port}`, 'output');
                        this.addConsoleLog(`  Players: ${inst.numClients || 0}/${inst.maxClients || 10}`, 'output');
                        if (inst.matchId) this.addConsoleLog(`  Match ID: ${inst.matchId}`, 'output');
                        if (inst.uptime) this.addConsoleLog(`  Uptime: ${inst.uptime}`, 'output');
                    } else {
                        this.addConsoleLog(`â”€â”€â”€ Server Status â”€â”€â”€`, 'info');
                        this.addConsoleLog(`  Total: ${instances.length} instances`, 'output');
                        this.addConsoleLog(`  Online: ${instances.filter(i => i.status !== 'Offline' && i.status !== 'OFFLINE').length}`, 'output');
                        this.addConsoleLog(`  Occupied: ${instances.filter(i => i.status === 'Occupied' || i.status === 'OCCUPIED').length}`, 'output');
                        this.addConsoleLog(`  Ready: ${instances.filter(i => i.status === 'Ready' || i.status === 'READY').length}`, 'output');
                        this.addConsoleLog(`  Offline: ${instances.filter(i => i.status === 'Offline' || i.status === 'OFFLINE').length}`, 'output');
                    }
                },

                getStatusColor(status) {
                    const s = (status || '').toLowerCase();
                    if (s === 'occupied') return 'text-orange-400';
                    if (s === 'ready') return 'text-green-400';
                    if (s === 'starting') return 'text-blue-400';
                    if (s === 'crashed') return 'text-red-400';
                    return 'text-zinc-500';
                },

                handleListCommand() {
                    const instances = this.statusData?.instances || [];
                    
                    if (instances.length === 0) {
                        this.addConsoleLog('No instances found', 'warning');
                        return;
                    }
                    
                    this.addConsoleLog(`â”€â”€â”€ Instance List (${instances.length}) â”€â”€â”€`, 'info');
                    this.addConsoleLog('  ID   PORT    STATUS     PLAYERS', 'output');
                    this.addConsoleLog('  â”€â”€   â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€     â”€â”€â”€â”€â”€â”€â”€', 'output');
                    
                    for (const inst of instances) {
                        const id = String(inst.id).padEnd(4);
                        const port = String(inst.port).padEnd(7);
                        const status = `<span class="${this.getStatusColor(inst.status)}">${(inst.status || 'Unknown').padEnd(10)}</span>`;
                        const players = `${inst.numClients || 0}/${inst.maxClients || 10}`;
                        this.addConsoleLog(`  ${id} ${port} ${status} ${players}`, 'output');
                    }
                },

                handleInfoCommand() {
                    const server = this.selectedServer;
                    const status = this.statusData;
                    
                    this.addConsoleLog(`â”€â”€â”€ Server Info â”€â”€â”€`, 'info');
                    this.addConsoleLog(`  Name: ${server?.serverName || 'Unknown'}`, 'output');
                    this.addConsoleLog(`  IP: ${server?.ipAddress}:${server?.apiPort}`, 'output');
                    this.addConsoleLog(`  Status: ${server?.isOnline ? '<span class="text-green-400">Online</span>' : '<span class="text-red-400">Offline</span>'}`, 'output');
                    this.addConsoleLog(`  Total Players: ${status?.totalPlayers || 0}`, 'output');
                    this.addConsoleLog(`  Active Matches: ${status?.instances?.filter(i => i.status === 'Occupied' || i.status === 'OCCUPIED').length || 0}`, 'output');
                },

                async handleSayCommand(args, fullCmd) {
                    // Extract message after 'say' or 'broadcast'
                    const match = fullCmd.match(/^(?:say|broadcast)\s+(?:(\d+)\s+)?(.+)$/i);
                    
                    if (!match || !match[2]) {
                        this.addConsoleLog('Usage: say [message]', 'warning');
                        this.addConsoleLog('Example: say Hello everyone!', 'info');
                        return;
                    }
                    
                    const instanceId = match[1] ? parseInt(match[1]) : null;
                    const message = match[2];
                    
                    // Note: Per-instance broadcast not yet implemented in API
                    if (instanceId) {
                        this.addConsoleLog(`âš  Per-instance broadcast not supported yet. Broadcasting to all instead.`, 'warning');
                    }
                    
                    const endpoint = `/api/servers/${this.selectedServer.serverId}/broadcast`;
                    const body = { message };
                    
                    this.addConsoleLog(`Broadcasting to all: "${message}"`, 'info');
                    
                    const res = await this.apiCall(endpoint, {
                        method: 'POST',
                        body: JSON.stringify(body)
                    });
                    
                    if (res.ok) {
                        this.addConsoleLog('âœ“ Message sent', 'success');
                    } else {
                        const err = await res.json().catch(() => ({}));
                        this.addConsoleLog(`âœ— Failed to send message: ${err.error || 'Unknown error'}`, 'error');
                    }
                },

                async handleSleepCommand(args) {
                    if (args.length === 0) {
                        this.addConsoleLog('Usage: sleep [instance_id]', 'warning');
                        this.addConsoleLog('Example: sleep 1', 'info');
                        this.addConsoleLog('This will kick all players and stop the server until wake', 'info');
                        return;
                    }
                    
                    const id = parseInt(args[0]);
                    
                    if (isNaN(id)) {
                        this.addConsoleLog(`Invalid instance ID: ${args[0]}`, 'error');
                        return;
                    }
                    
                    const instance = this.getInstanceById(id);
                    if (!instance) {
                        this.addConsoleLog(`Instance #${id} not found`, 'error');
                        return;
                    }
                    
                    // Check if already sleeping
                    if (this.sleepingInstances[id]) {
                        this.addConsoleLog(`Instance #${id} is already sleeping. Use 'wake ${id}' to start it.`, 'warning');
                        return;
                    }
                    
                    const players = instance.num_clients ?? instance.numClients ?? 0;
                    
                    this.addConsoleLog(`<span class="text-blue-400">â˜½</span> Putting instance #${id} to sleep...`, 'info');
                    
                    // Step 1: Kick all players if any
                    if (players > 0) {
                        this.addConsoleLog(`  Kicking ${players} player(s)...`, 'warning');
                        try {
                            await this.apiCall(`/api/servers/${id}/reset`, { method: 'POST' });
                            // Wait a moment for players to disconnect
                            await new Promise(r => setTimeout(r, 2000));
                        } catch (e) {
                            this.addConsoleLog(`  Warning: Could not kick players`, 'warning');
                        }
                    }
                    
                    // Step 2: Stop the server
                    this.addConsoleLog(`  Stopping server...`, 'info');
                    try {
                        const res = await this.apiCall(`/api/servers/${id}/stop`, { method: 'POST' });
                        // API always returns 200 OK now, just proceed
                    } catch (e) {
                        this.addConsoleLog(`  Warning: ${e.message}`, 'warning');
                        // Continue anyway - we'll mark as sleeping
                    }
                    
                    // Step 3: Mark as sleeping and update local status
                    this.sleepingInstances[id] = {
                        sleepingSince: new Date().toISOString()
                    };
                    
                    // Update local instance status
                    if (instance) {
                        instance.status = 'Offline';
                        instance.num_clients = 0;
                        instance.numClients = 0;
                    }
                    
                    this.addConsoleLog(`<span class="text-blue-400">â˜½</span> Instance #${id} is now <span class="text-blue-400">sleeping</span>`, 'success');
                    this.addConsoleLog(`  Use 'wake ${id}' to start it again`, 'info');
                },

                async handleWakeCommand(args) {
                    if (args.length === 0) {
                        // Wake all sleeping instances
                        const sleepingIds = Object.keys(this.sleepingInstances);
                        if (sleepingIds.length === 0) {
                            this.addConsoleLog('No sleeping instances to wake', 'info');
                            return;
                        }
                        
                        this.addConsoleLog(`<span class="text-yellow-400">â˜€</span> Waking all ${sleepingIds.length} sleeping instance(s)...`, 'info');
                        
                        for (const id of sleepingIds) {
                            await this.handleWakeCommand([id]);
                        }
                        return;
                    }
                    
                    const id = parseInt(args[0]);
                    if (isNaN(id)) {
                        this.addConsoleLog(`Invalid instance ID: ${args[0]}`, 'error');
                        return;
                    }
                    
                    if (!this.sleepingInstances[id]) {
                        this.addConsoleLog(`Instance #${id} is not sleeping`, 'warning');
                        return;
                    }
                    
                    this.addConsoleLog(`<span class="text-yellow-400">â˜€</span> Waking instance #${id}...`, 'info');
                    
                    // Start the server
                    try {
                        const res = await this.apiCall(`/api/servers/${id}/start`, { method: 'POST' });
                        if (res.ok) {
                            delete this.sleepingInstances[id];
                            this.addConsoleLog(`<span class="text-yellow-400">â˜€</span> Instance #${id} is now <span class="text-green-400">awake</span>`, 'success');
                        } else {
                            const err = await res.json().catch(() => ({}));
                            this.addConsoleLog(`âœ— Failed to wake instance: ${err.error || 'Unknown error'}`, 'error');
                        }
                    } catch (e) {
                        this.addConsoleLog(`âœ— Error waking instance: ${e.message}`, 'error');
                    }
                },

                async handleResetCommand(args) {
                    if (args.length === 0) {
                        this.addConsoleLog('Usage: reset [instance_id] - Kick all players from instance', 'warning');
                        this.addConsoleLog('Example: reset 1', 'info');
                        this.addConsoleLog('Alias: kick', 'info');
                        return;
                    }
                    
                    const id = parseInt(args[0]);
                    if (isNaN(id)) {
                        this.addConsoleLog(`Invalid instance ID: ${args[0]}`, 'error');
                        return;
                    }
                    
                    const instance = this.getInstanceById(id);
                    if (!instance) {
                        this.addConsoleLog(`Instance #${id} not found`, 'error');
                        return;
                    }
                    
                    const players = instance.num_clients ?? instance.numClients ?? 0;
                    if (players === 0) {
                        this.addConsoleLog(`Instance #${id} has no players`, 'warning');
                        return;
                    }
                    
                    this.addConsoleLog(`âš  Kicking ${players} player(s) from instance #${id}...`, 'warning');
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${id}/reset`, { method: 'POST' });
                        
                        if (res.ok) {
                            this.addConsoleLog(`âœ“ Reset command sent to instance #${id}`, 'success');
                            this.addConsoleLog('Players will be disconnected shortly', 'info');
                        } else {
                            const err = await res.json();
                            this.addConsoleLog(`âœ— Failed: ${err.error || 'Unknown error'}`, 'error');
                        }
                    } catch (err) {
                        this.addConsoleLog(`âœ— Error: ${err.message}`, 'error');
                    }
                },

                handleSleepingCommand() {
                    const sleeping = Object.entries(this.sleepingInstances);
                    
                    if (sleeping.length === 0) {
                        this.addConsoleLog('No sleeping instances', 'info');
                        this.addConsoleLog('Use: sleep [id] to put an instance to sleep', 'info');
                        return;
                    }
                    
                    this.addConsoleLog(`â”€â”€â”€ Sleeping Instances (${sleeping.length}) â”€â”€â”€`, 'info');
                    this.addConsoleLog('  ID   SLEEPING SINCE', 'output');
                    this.addConsoleLog('  â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'output');
                    
                    for (const [id, info] of sleeping) {
                        const since = new Date(info.sleepingSince).toLocaleTimeString();
                        this.addConsoleLog(`  <span class="text-blue-400">â˜½</span> ${String(id).padEnd(4)} ${since}`, 'output');
                    }
                    
                    this.addConsoleLog('', 'output');
                    this.addConsoleLog('Use: wake [id] to wake up, or wake to wake all', 'info');
                },

                async sendRawConsoleCommand(command) {
                    this.addConsoleLog(`Sending raw command: ${command}`, 'info');
                    
                    const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/console/command`, {
                        method: 'POST',
                        body: JSON.stringify({ command })
                    });
                    
                    if (res.ok) {
                        const result = await res.json();
                        if (result.output) {
                            this.addConsoleLog(result.output, 'output');
                        } else {
                            this.addConsoleLog('Command sent', 'success');
                        }
                    } else {
                        this.addConsoleLog('Failed to execute command', 'error');
                    }
                },

                async sendConsoleCommand() {
                    // Redirect to new method for backwards compatibility
                    await this.executeConsoleCommand();
                },

                // ==================== FILEBEAT ====================
                async loadFilebeatStatus() {
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/filebeat/status`);
                        if (res.ok) {
                            this.filebeatStatus = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load filebeat status:', err);
                    }
                },

                async controlFilebeat(action) {
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/filebeat/${action}`, {
                            method: 'POST'
                        });
                        
                        if (res.ok) {
                            await this.loadFilebeatStatus();
                        } else {
                            alert(`Failed to ${action} Filebeat`);
                        }
                    } catch (err) {
                        alert(`Failed to ${action} Filebeat`);
                    }
                },

                async installFilebeat() {
                    if (!confirm('Install Filebeat? This may take a few minutes.')) return;
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/filebeat/install`, {
                            method: 'POST'
                        });
                        
                        if (res.ok) {
                            alert('Filebeat installation started');
                            await this.loadFilebeatStatus();
                        } else {
                            alert('Failed to install Filebeat');
                        }
                    } catch (err) {
                        alert('Failed to install Filebeat');
                    }
                },

                // ==================== GIT ====================
                async loadGitStatus() {
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/git/status`);
                        if (res.ok) {
                            this.gitStatus = await res.json();
                            this.selectedBranch = this.gitStatus.currentBranch;
                        }
                    } catch (err) {
                        console.error('Failed to load git status:', err);
                    }
                },

                async checkoutBranch() {
                    if (!this.selectedBranch) return;
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/git/checkout`, {
                            method: 'POST',
                            body: JSON.stringify({ branch: this.selectedBranch })
                        });
                        
                        if (res.ok) {
                            await this.loadGitStatus();
                            alert(`Checked out ${this.selectedBranch}`);
                        } else {
                            alert('Failed to checkout branch');
                        }
                    } catch (err) {
                        alert('Failed to checkout branch');
                    }
                },

                async gitPull() {
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/git/pull`, {
                            method: 'POST'
                        });
                        
                        if (res.ok) {
                            await this.loadGitStatus();
                            alert('Pull successful');
                        } else {
                            alert('Failed to pull');
                        }
                    } catch (err) {
                        alert('Failed to pull');
                    }
                },

                async gitReset() {
                    if (!confirm('Are you sure you want to hard reset? All local changes will be lost.')) return;
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/git/reset`, {
                            method: 'POST'
                        });
                        
                        if (res.ok) {
                            await this.loadGitStatus();
                            alert('Reset successful');
                        } else {
                            alert('Failed to reset');
                        }
                    } catch (err) {
                        alert('Failed to reset');
                    }
                },

                // ==================== BACKUPS ====================
                async loadBackups() {
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/backups`);
                        if (res.ok) {
                            this.backupsList = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load backups:', err);
                    }
                },

                async createBackup() {
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/backups`, {
                            method: 'POST'
                        });
                        
                        if (res.ok) {
                            await this.loadBackups();
                            alert('Backup created');
                        } else {
                            alert('Failed to create backup');
                        }
                    } catch (err) {
                        alert('Failed to create backup');
                    }
                },

                async restoreBackup(name) {
                    if (!confirm(`Restore backup ${name}? Current data will be overwritten.`)) return;
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/backups/${name}/restore`, {
                            method: 'POST'
                        });
                        
                        if (res.ok) {
                            alert('Backup restored');
                        } else {
                            alert('Failed to restore backup');
                        }
                    } catch (err) {
                        alert('Failed to restore backup');
                    }
                },

                async deleteBackup(name) {
                    if (!confirm(`Delete backup ${name}?`)) return;
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/backups/${name}`, {
                            method: 'DELETE'
                        });
                        
                        if (res.ok) {
                            await this.loadBackups();
                        } else {
                            alert('Failed to delete backup');
                        }
                    } catch (err) {
                        alert('Failed to delete backup');
                    }
                },

                // ==================== RBAC ====================
                async loadRoles() {
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/rbac/roles`);
                        if (res.ok) {
                            this.rolesList = await res.json();
                        }
                    } catch (err) {
                        console.error('Failed to load roles:', err);
                    }
                },

                async deleteRole(id) {
                    if (!confirm('Delete this role?')) return;
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/rbac/roles/${id}`, {
                            method: 'DELETE'
                        });
                        
                        if (res.ok) {
                            await this.loadRoles();
                        } else {
                            alert('Failed to delete role');
                        }
                    } catch (err) {
                        alert('Failed to delete role');
                    }
                },

                async addRole() {
                    if (!this.addRoleForm.name) return;
                    
                    try {
                        const res = await this.apiCall(`/api/servers/${this.selectedServer.serverId}/rbac/roles`, {
                            method: 'POST',
                            body: JSON.stringify(this.addRoleForm)
                        });
                        
                        if (res.ok) {
                            await this.loadRoles();
                            this.showAddRoleModal = false;
                            this.addRoleForm = { name: '', permissions: [] };
                        } else {
                            alert('Failed to create role');
                        }
                    } catch (err) {
                        alert('Failed to create role');
                    }
                },

                async logout() {
                    await this.apiCall('/auth/logout', { method: 'POST' });
                    this.user = null;
                    this.token = null;
                    this.servers = [];
                    localStorage.removeItem('portal_token');
                    if (this.hubConnection) {
                        this.hubConnection.stop();
                    }
                },

                apiCall(url, options = {}) {
                    return fetch(url, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.token}`,
                            ...(options.headers || {})
                        }
                    });
                }
            };
        }
    </script>
</body>
</html>